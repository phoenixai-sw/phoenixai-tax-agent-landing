<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tax-Agent</title>
    
    <!-- 캐시 방지 및 모바일 최적화 메타 태그 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="address=no">
    <meta name="format-detection" content="email=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4facfe">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --vh: 1vh;
            --primary-color: #4facfe;
            --secondary-color: #00f2fe;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
        }

        html, body {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .chatbot-main {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: white;
            position: relative;
        }

        /* 헤더 */
        .chatbot-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 18px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-title {
            font-size: 20px;
            font-weight: bold;
            margin: 0;
            flex: 1;
        }

        .back-link {
            position: absolute;
            left: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            width: 60px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            transition: all 0.3s ease;
            text-decoration: none;
            z-index: 1000;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .home-icon {
            font-size: 24px;
            line-height: 1;
        }

        .home-arrow {
            font-size: 14px;
            line-height: 1;
            margin-top: 2px;
        }

        /* API 상태 표시 */
        #apiStatus {
            position: absolute;
            top: 10px;
            right: 140px;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
            font-weight: bold;
            z-index: 1001;
        }

        /* n8n 엔진 On 상태 애니메이션 */
        .ai-on {
            background: #d4edda !important;
            color: #155724 !important;
            border-color: #c3e6cb !important;
        }

        .ai-on .blink {
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* AI OFF 상태 */
        .ai-off {
            background: #f8d7da !important;
            color: #721c24 !important;
            border-color: #f5c6cb !important;
        }

        /* 언어 선택 드롭다운 */
        .header-language-dropdown {
            position: absolute;
            right: 15px;
            z-index: 2000;
        }

        .language-dropdown {
            position: relative;
            display: inline-block;
        }

        .language-current {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border: 2px solid #ffbf00;
            color: black !important;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 100px;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.4);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .language-current:hover {
            background: linear-gradient(135deg, #ffbf00 0%, #ffd700 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 215, 0, 0.6);
        }

        .language-current:active {
            transform: scale(0.95);
        }

        .language-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 3000;
            display: none;
            min-width: 120px;
            margin-top: 5px;
            animation: menuSlideDown 0.2s ease-out;
        }

        @keyframes menuSlideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .language-menu.show {
            display: block;
        }

        .language-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            color: black !important;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .language-option:last-child {
            border-bottom: none;
        }

        .language-option:hover {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        }

        .language-option:active {
            background: linear-gradient(135deg, #ffbf00 0%, #ffd700 100%);
            transform: scale(0.98);
        }

        .language-option.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white !important;
        }

        /* 안드로이드 카카오톡 브라우저 최적화 */
        .android-kakao .language-current {
            min-height: 36px;  /* 44px에서 36px로 줄임 */
            min-width: 80px;   /* 100px에서 80px로 줄임 */
            padding: 8px 8px;  /* 8px 12px에서 8px 8px로 줄임 */
            font-size: 12px;    /* 14px에서 12px로 줄임 */
        }

        .android-kakao .language-option {
            min-height: 36px;   /* 44px에서 36px로 줄임 */
            min-width: 80px;    /* 120px에서 80px로 줄임 */
            padding: 8px 8px;   /* 8px 12px에서 8px 8px로 줄임 */
            font-size: 12px;    /* 14px에서 12px로 줄임 */
        }

        .android-kakao .language-menu {
            margin-top: 8px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        /* 윈도우 브라우저 최적화 */
        .windows-browser .language-current {
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }

        .windows-browser .language-current:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5) !important;
        }

        .windows-browser .language-option {
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }

        .windows-browser .language-option:hover {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%) !important;
            transform: translateX(2px) !important;
        }

        .windows-browser .language-menu {
            animation: menuSlideDown 0.3s ease-out !important;
        }

        /* 메시지 영역 */
        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 80px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .message.user .message-avatar {
            background: #e9ecef;
            color: #495057;
        }

        .message-content {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 14px;
            word-wrap: break-word;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.user .message-content {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 6px;
        }

        /* 빠른 버튼 최적화 */
        .quick-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .quick-button {
            background: #f0f8ff;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-radius: 15px;
            padding: 10px 8px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            will-change: transform, box-shadow;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .quick-button:active {
            transform: translateY(0);
        }

        /* 특별 버튼 스타일 */
        .clinic-hours-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%) !important;
            color: #333 !important;
            border: none !important;
        }

        .treatment-cost-btn {
            background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%) !important;
            color: white !important;
            border: none !important;
        }

        .reservation-btn {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%) !important;
            color: white !important;
            border: none !important;
        }

        .directions-btn {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%) !important;
            color: white !important;
            border: none !important;
        }

        /* 입력 영역 */
        .chatbot-input {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #ddd;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .chatbot-input textarea {
            flex: 1;
            border: 2px solid var(--primary-color);
            border-radius: 20px;
            padding: 12px 16px;
            font-size: 16px;
            resize: none;
            outline: none;
            min-height: 45px;
            max-height: 120px;
            line-height: 1.4;
            -webkit-user-select: text;
            user-select: text;
            touch-action: manipulation;
            font-family: inherit;
        }

        .chatbot-input textarea:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }

        .chatbot-send {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 90px;
            height: 45px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .chatbot-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .chatbot-send:active {
            transform: scale(0.95);
        }

        /* 로딩 애니메이션 */
        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 80% { content: '...'; }
            100% { content: ''; }
        }

        /* 예약 버튼 스타일 */
        .reservation-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%) !important;
            color: white !important;
            border: none !important;
            padding: 12px 24px !important;
            border-radius: 25px !important;
            font-size: 14px !important;
            font-weight: bold !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            text-decoration: none !important;
            display: inline-block !important;
            margin: 10px 0 !important;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3) !important;
            touch-action: manipulation !important;
            -webkit-tap-highlight-color: transparent !important;
        }

        .reservation-button:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5) !important;
        }

        .reservation-message {
            margin-top: 15px !important;
            padding: 15px !important;
            background: #f8f9fa !important;
            border-radius: 10px !important;
            border-left: 4px solid var(--primary-color) !important;
            text-align: center !important;
        }

        .reservation-message-text {
            font-size: 14px !important;
            color: #666 !important;
            margin-bottom: 10px !important;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .chatbot-header {
                padding: 12px 8px;
            }
            
            .chatbot-title {
                font-size: 16px;
                margin: 0 80px;
            }
            
            .back-link {
                width: 50px;
                height: 50px;
                left: 8px;
            }
            
            .home-icon {
                font-size: 20px;
            }
            
            .home-arrow {
                font-size: 12px;
            }
            
            #apiStatus {
                right: 90px;
                font-size: 10px;
                padding: 3px 6px;
            }
            
            .header-language-dropdown {
                right: 8px;
            }
            
            .language-current {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 80px;
            }
            
            .chatbot-messages {
                padding: 12px;
                margin-bottom: 75px;
            }
            
            .message-content {
                max-width: 85%;
                font-size: 13px;
            }
            
            .quick-buttons {
                gap: 6px;
                max-width: 280px;
            }
            
            .quick-button {
                font-size: 11px;
                padding: 8px 6px;
                min-height: 40px;
            }
            
            .chatbot-input {
                padding: 10px;
            }
            
            .chatbot-send {
                min-width: 70px;
                padding: 10px 16px;
                font-size: 14px;
            }
            
            /* 안드로이드 카카오톡 브라우저 모바일 최적화 */
            .android-kakao .language-current {
                padding: 6px 8px;
                font-size: 12px;
                min-width: 75px;
                min-height: 40px;
            }
            
            .android-kakao .language-option {
                padding: 8px 8px;
                font-size: 12px;
                min-height: 40px;
            }
            
            .android-kakao .language-menu {
                margin-top: 6px;
                min-width: 85px;
            }
        }

        @media (max-width: 480px) {
            .chatbot-title {
                font-size: 14px;
                margin: 0 70px;
            }
            
            .back-link {
                width: 45px;
                height: 45px;
                left: 5px;
            }
            
            .home-icon {
                font-size: 18px;
            }
            
            .home-arrow {
                font-size: 10px;
            }
            
            #apiStatus {
                right: 75px;
                font-size: 9px;
                padding: 2px 4px;
            }
            
            .header-language-dropdown {
                right: 5px;
            }
            
            .language-current {
                padding: 5px 8px;
                font-size: 10px;
                min-width: 70px;
            }
            
            .chatbot-messages {
                padding: 8px;
                margin-bottom: 70px;
            }
            
            .quick-buttons {
                gap: 4px;
                max-width: 250px;
            }
            
            .quick-button {
                font-size: 10px;
                padding: 6px 4px;
                min-height: 36px;
            }
            
            .chatbot-input {
                padding: 8px;
            }
            
            .chatbot-send {
                min-width: 60px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        /* iOS Safari 최적화 */
        @supports (-webkit-touch-callout: none) {
            .chatbot-main {
                height: 100vh;
                height: -webkit-fill-available;
            }
            
            .chatbot-input {
                padding-bottom: env(safe-area-inset-bottom, 15px);
            }
        }

        /* 키보드 열림 상태 최적화 */
        .keyboard-open .chatbot-messages {
            padding-bottom: 20px;
        }

        /* PC 최적화 */
        @media (min-width: 1024px) {
            .chatbot-main {
                max-width: 800px;
                margin: 0 auto;
                height: 90vh;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.1);
                margin-top: 5vh;
            }
            
            .chatbot-header {
                border-radius: 20px 20px 0 0;
            }
            
            .chatbot-input {
                border-radius: 0 0 20px 20px;
            }
            
            #apiStatus {
                right: 160px;
                font-size: 12px;
                padding: 6px 10px;
            }
            
            .language-current {
                min-width: 120px;
                font-size: 14px;
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="chatbot-main">
        <!-- 헤더 -->
        <div class="chatbot-header">
            <a href="admin.html" class="back-link">
                <span class="home-icon">⚙️</span>
                <span class="home-arrow">설정</span>
            </a>
            <h1 class="chatbot-title">Tax-Agent💰</h1>
            
            <!-- API 설정 상태 표시 -->
            <div id="apiStatus" style="cursor: pointer;" onclick="showApiStatusInfo()">❌ AI API 설정 안됨</div>
            
            <!-- 언어 선택 드롭다운 -->
            <div class="header-language-dropdown">
                <div class="language-dropdown">
                    <button class="language-current" onclick="toggleLanguageMenu()" ontouchstart="toggleLanguageMenu()">
                        <span id="currentLanguageText">🇰🇷 KR</span>
                        <span>▼</span>
                    </button>
                    <div class="language-menu" id="languageMenu">
                        <div class="language-option active" data-lang="ko" onclick="selectLanguage('ko')" ontouchstart="selectLanguage('ko')">🇰🇷 KR</div>
                        <div class="language-option" data-lang="en" onclick="selectLanguage('en')" ontouchstart="selectLanguage('en')">🇺🇸 US</div>
                        <div class="language-option" data-lang="ru" onclick="selectLanguage('ru')" ontouchstart="selectLanguage('ru')">🇷🇺 RU</div>
                        <div class="language-option" data-lang="ja" onclick="selectLanguage('ja')" ontouchstart="selectLanguage('ja')">🇯🇵 JP</div>
                    </div>
                </div>
            </div>
        </div>



        <!-- 메시지 영역 -->
        <div class="chatbot-messages" id="chatbotMessages">
            <!-- 메시지들이 여기에 추가됩니다 -->
        </div>

        <!-- 입력 영역 -->
        <div class="chatbot-input">
            <textarea id="chatbotInput" placeholder="메시지를 입력하세요..." rows="1" oninput="adjustTextareaHeight(this)" onkeydown="handleInputKeyDown(event)"></textarea>
            <button class="chatbot-send" onclick="sendMessage()">전송</button>
        </div>
    </div>

    <script>
        console.log('🚀 Tax-Agent 양도세 챗봇 시작 (최적화 버전)');

        // 🎯 챗봇 핵심 클래스 (단일 책임 원칙 적용)
        class TaxAgentChatbot {
            constructor() {
                this.currentLanguage = 'ko';
                this.apiSettings = null;
                this.knowledgeBase = { enabled: false, files: [], parsedData: [] };
                this.isProcessingMessage = false;
                this.lastMessageTime = 0;
                this.lastMessage = '';
                
                // 대화 이력 관리
                this.chatHistory = [];
                this.MAX_HISTORY = 20; // 최대 대화 이력 개수
                this.MAX_TOKENS = 1500; // API 호출 최대 토큰
                
                this.initializeTranslations();
                this.init();
            }
            
            // 번역 데이터 초기화
            initializeTranslations() {
                this.translations = {
                    ko: {
                        title: 'Tax-Agent💰',
                        placeholder: '양도세 관련 질문을 입력하세요...',
                        sendButton: '전송',
                        currentLanguage: '🇰🇷 KR',
                        welcomeMessage: 'Tax-Agent 양도세 전문 상담사입니다!',
                        welcomeSubMessage: '우측 상단에서 언어 변경 가능합니다'
                    },
                    en: {
                        title: 'Tax-Agent💰',
                        placeholder: 'Enter your capital gains tax question...',
                        sendButton: 'Send',
                        currentLanguage: '🇺🇸 US',
                        welcomeMessage: 'I am Tax-Agent capital gains tax specialist!',
                        welcomeSubMessage: 'Language change available in top right menu'
                    },
                    ru: {
                        title: 'Tax-Agent💰',
                        placeholder: 'Введите ваш вопрос о налоге на прирост капитала...',
                        sendButton: 'Отправить',
                        currentLanguage: '🇷🇺 RU',
                        welcomeMessage: 'Я специалист по налогу на прирост капитала Tax-Agent!',
                        welcomeSubMessage: 'Изменение языка доступно в меню справа вверху'
                    },
                    ja: {
                        title: 'Tax-Agent💰',
                        placeholder: '譲渡税に関する質問を入力してください...',
                        sendButton: '送信',
                        currentLanguage: '🇯🇵 JP',
                        welcomeMessage: 'Tax-Agent譲渡税専門相談員です！',
                        welcomeSubMessage: '右上メニューで言語変更が可能です'
                    }
                };
            }
            
            // 초기화 (브라우저별 호환성 개선)
            async init() {
                console.log('🤖 Tax-Agent 양도세 챗봇 초기화 시작');
                
                this.loadSettings();
                this.setupEventListeners();
                this.setupMobileOptimization();
                setTimeout(() => this.addWelcomeMessage(), 500);
                this.updateLanguageUI();
                
                // 브라우저별 API 연결 테스트 실행
                try {
                    await this.testBrowserApiConnection();
                } catch (error) {
                    console.warn('⚠️ 브라우저별 API 연결 테스트 실패:', error);
                }
                
                console.log('✅ Tax-Agent 양도세 챗봇 초기화 완료');
            }
            
            // 설정 로딩
            loadSettings() {
                this.loadApiSettings();
                this.loadKnowledgeBaseSettings();
                this.loadHistorySettings();
                this.updateApiStatusDisplay();
            }
            
            // 🎯 핵심 메시지 처리 함수 (API 우선순위 최상위)
            async processMessage(message) {
                console.log('🎯 메시지 처리 시작:', message);
                
                // 중복 실행 방지
                if (this.isDuplicateMessage(message)) {
                    console.log('⚠️ 중복 메시지 차단');
                    return;
                }
                
                this.setProcessingFlag(true);
                
                try {
                    // ✅ 1차: AI API 호출 (최우선)
                    console.log('🤖 1차: AI API 호출 시도');
                    if (this.hasActiveAPI()) {
                        console.log('✅ 활성화된 AI API 발견');
                        
                        // 상세 질문이나 특정 치료비용 질문인 경우에만 스마트 필터링 적용
                        const useSmartFiltering = this.isDetailedQuestion(message) || 
                                                 this.isSpecificTreatmentCostQuery(message);
                        
                        await this.generateAIResponse(message, useSmartFiltering);
                        return;
                    }
                    
                    // ✅ 2차: 인사/감사 처리 (빠른 응답)
                    if (this.isGreetingOrThanks(message)) {
                        console.log('😊 2차: 인사/감사 처리');
                        const response = this.generateGreetingResponse(message);
                        this.addBotMessage(response);
                        return;
                    }
                    
                    // ✅ 3차: 지식베이스 검색
                    console.log('📚 3차: 지식베이스 검색');
                    const knowledgeAnswer = this.searchInKnowledgeBase(message);
                    if (knowledgeAnswer) {
                        console.log('✅ 지식베이스에서 답변 발견');
                        this.addBotMessage(knowledgeAnswer);
                        return;
                    }
                    
                    // ✅ 4차: 기본 FAQ 답변 (키워드 기반)
                    console.log('❓ 4차: 기본 FAQ 검색');
                    const faqAnswer = this.getFAQAnswer(message);
                    if (faqAnswer) {
                        console.log('✅ FAQ 답변 발견:', faqAnswer.type);
                        this.addBotMessage(faqAnswer.content);
                        return;
                    }
                    
                    // 특정 양도세 계산 질문 처리 추가
                    if (this.isSpecificTaxCalculationQuery(message)) {
                        console.log('💰 특정 양도세 계산 질문 감지: 키워드 답변 제공');
                        const taxAnswer = this.createTaxCalculationContent(this.currentLanguage);
                        this.addBotMessage(taxAnswer);
                        return;
                    }
                    
                    // ✅ 5차: 시뮬레이션된 답변 (최후 수단)
                    console.log('🎭 5차: 시뮬레이션된 답변 사용');
                    setTimeout(() => {
                        const response = this.generateSimulatedResponse(message);
                        this.addBotMessage(response);
                    }, 800);
                    
                } catch (error) {
                    console.error('❌ 메시지 처리 오류:', error);
                    
                    const errorMessages = {
                        ko: '죄송합니다. 일시적인 오류가 발생했습니다. 다시 시도해주세요.',
                        en: 'Sorry. A temporary error occurred. Please try again.',
                        ru: 'Извините. Произошла временная ошибка. Пожалуйста, попробуйте еще раз.',
                        ja: '申し訳ございません。一時的なエラーが発生しました。もう一度お試しください。'
                    };
                    
                    this.addBotMessage(errorMessages[this.currentLanguage] || errorMessages['ko']);
                } finally {
                    this.setProcessingFlag(false);
                }
            }
            
            // 중복 메시지 확인 (개선됨)
            isDuplicateMessage(message) {
                const currentTime = Date.now();
                const isDuplicate = this.isProcessingMessage || 
                                   (currentTime - this.lastMessageTime < 1000 && this.lastMessage === message);
                
                this.lastMessageTime = currentTime;
                this.lastMessage = message;
                return isDuplicate;
            }
            
            // 처리 플래그 설정
            setProcessingFlag(processing) {
                this.isProcessingMessage = processing;
                if (processing) {
                    setTimeout(() => { this.isProcessingMessage = false; }, 5000);
                }
            }
            

            
            // 인사/감사 확인
            isGreetingOrThanks(message) {
                const greetings = ['안녕', 'hello', 'hi', '하이', '반가워', '안녕하세요'];
                const thanks = ['감사', '고마워', 'thanks', 'thank you', '땡큐'];
                const meaningless = /^(떼|데|테|때|뗘|뗴|데데|떼떼){1,}$/i;
                
                const lower = message.toLowerCase();
                return greetings.some(g => lower.includes(g)) || 
                       thanks.some(t => lower.includes(t)) || 
                       meaningless.test(lower);
            }
            
            // 인사/감사 응답 생성
            generateGreetingResponse(message) {
                const lower = message.toLowerCase();
                const reservationText = this.getReservationText();
                
                const greetingResponses = {
                    ko: {
                        thanks: `천만에요! Tax-Agent를 이용해주셔서 감사합니다. 더 궁금한 양도세 관련 질문이 있으시면 언제든 문의해주세요 😊`,
                        hello: `안녕하세요! Tax-Agent 양도세 전문 상담사입니다. 양도세 관련 궁금한 점이 있으시면 언제든 말씀해 주세요 😊`
                    },
                    en: {
                        thanks: `You're welcome! Thank you for using Tax-Agent. If you have any more capital gains tax questions, please feel free to ask anytime 😊`,
                        hello: `Hello! I am Tax-Agent capital gains tax specialist. If you have any tax-related questions, please feel free to ask anytime 😊`
                    },
                    ru: {
                        thanks: `Пожалуйста! Спасибо, что пользуетесь Tax-Agent. Если у вас есть еще вопросы о налоге на прирост капитала, пожалуйста, обращайтесь в любое время 😊`,
                        hello: `Здравствуйте! Я специалист по налогу на прирост капитала Tax-Agent. Если у вас есть вопросы по налогам, пожалуйста, обращайтесь в любое время 😊`
                    },
                    ja: {
                        thanks: `どういたしまして！Tax-Agentをご利用いただき、ありがとうございます。他に譲渡税に関するご質問がございましたら、いつでもお気軽にお聞かせください 😊`,
                        hello: `こんにちは！Tax-Agent譲渡税専門相談員です。譲渡税に関するご質問がございましたら、いつでもお気軽にお聞かせください 😊`
                    }
                };
                
                const currentResponses = greetingResponses[this.currentLanguage] || greetingResponses['ko'];
                
                if (lower.includes('감사') || lower.includes('고마워') || lower.includes('thank') || 
                    lower.includes('спасибо') || lower.includes('ありがとう')) {
                    return `${currentResponses.thanks}
                    
                    <div class="reservation-message">
                        <div class="reservation-message-text">${reservationText.message}</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                    </div>`;
                }
                
                return `${currentResponses.hello}
                
                <div class="reservation-message">
                    <div class="reservation-message-text">${reservationText.message}</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                </div>`;
            }
            
            // FAQ 답변 처리 (스마트 키워드 매칭)
            getFAQAnswer(message) {
                // 상세 질문인 경우 키워드 매칭 우회
                if (this.isDetailedQuestion(message)) {
                    console.log(' 상세 질문 감지: 키워드 매칭 우회');
                    return null;
                }
                
                const keywordGroups = this.getKeywordGroups();
                const normalized = message.toLowerCase().trim();
                
                for (const [groupName, group] of Object.entries(keywordGroups)) {
                    if (this.matchesKeywords(normalized, group.keywords)) {
                        // 동적으로 콘텐츠 생성
                        let content;
                        switch (group.type) {
                            case 'capitalGainsTax':
                                content = this.createCapitalGainsTaxContent(this.currentLanguage);
                                break;
                            case 'taxCalculation':
                                content = this.createTaxCalculationContent(this.currentLanguage);
                                break;
                            case 'taxFiling':
                                content = this.createTaxFilingContent(this.currentLanguage);
                                break;
                            case 'taxExemption':
                                content = this.createTaxExemptionContent(this.currentLanguage);
                                break;
                            default:
                                content = '';
                        }
                        
                        return {
                            type: group.type,
                            content: content
                        };
                    }
                }
                
                return null;
            }
            
            // 키워드 그룹 정의 (양도세 관련 키워드)
            getKeywordGroups() {
                return {
                    capitalGainsTax: {
                        keywords: [
                            // 한국어 (7개)
                            '양도세', '양도소득세', '양도소득', '양도', '양도세율', '양도세계산', '양도세신고',
                            // 영어 (7개)
                            'capital gains tax', 'capital gains', 'gains tax', 'tax on gains', 'capital gains rate', 'tax calculation',
                            // 러시아어 (7개)
                            'налог на прирост капитала', 'прирост капитала', 'налог на доходы', 'налоговая ставка',
                            // 일본어 (7개)
                            '譲渡税', '譲渡所得税', '譲渡所得', '譲渡', '譲渡税率', '譲渡税計算'
                        ],
                        type: 'capitalGainsTax'
                    },
                    taxCalculation: {
                        keywords: [
                            // 한국어 (7개)
                            '세금계산', '양도세계산', '세율', '과세표준', '세액', '공제', '감면',
                            // 영어 (7개)
                            'tax calculation', 'tax rate', 'taxable income', 'tax amount', 'deduction', 'exemption',
                            // 러시아어 (7개)
                            'расчет налога', 'налоговая ставка', 'налогооблагаемый доход', 'налоговая сумма',
                            // 일본어 (7개)
                            '税金計算', '譲渡税計算', '税率', '課税標準', '税額', '控除', '減免'
                        ],
                        type: 'taxCalculation'
                    },
                    taxFiling: {
                        keywords: [
                            // 한국어 (6개)
                            '세금신고', '양도세신고', '신고', '신고기한', '신고서', '신고방법',
                            // 영어 (6개)
                            'tax filing', 'tax return', 'filing', 'deadline', 'tax form', 'filing method',
                            // 러시아어 (6개)
                            'налоговая декларация', 'декларация', 'срок подачи', 'налоговая форма',
                            // 일본어 (6개)
                            '税金申告', '譲渡税申告', '申告', '申告期限', '申告書', '申告方法'
                        ],
                        type: 'taxFiling'
                    },
                    taxExemption: {
                        keywords: [
                            // 한국어 (8개)
                            '비과세', '면세', '공제', '감면', '비과세요건', '면세요건', '공제요건', '감면요건',
                            // 영어 (8개)
                            'tax exemption', 'exemption', 'deduction', 'non-taxable', 'exemption requirements', 'deduction requirements',
                            // 러시아어 (8개)
                            'налоговые льготы', 'освобождение', 'вычет', 'необлагаемый', 'льготные требования',
                            // 일본어 (8개)
                            '非課税', '免税', '控除', '減免', '非課税要件', '免税要件', '控除要件', '減免要件'
                        ],
                        type: 'taxExemption'
                    }
                };
            }
            
            // 키워드 매칭 (더 정확한 알고리즘)
            matchesKeywords(message, keywords) {
                return keywords.some(keyword => {
                    // 정확한 단어 경계 매칭 또는 부분 문자열 매칭
                    const wordBoundary = new RegExp(`\\b${keyword.toLowerCase()}\\b`);
                    return wordBoundary.test(message) || message.includes(keyword.toLowerCase());
                });
            }
            
            // 상세 질문 패턴 감지 함수 추가
            isDetailedQuestion(message) {
                const detailedPatterns = [
                    // 질문어 패턴
                    /(어떻게|어떤|왜|언제|어디서|누가|무엇을|어떠한|어떤지|어떻게요|어떤가요|왜요|언제요|어디서요|누가요|무엇을요|어떠한가요)/,
                    // 상세 설명 요청 패턴
                    /(자세히|상세히|구체적으로|정확히|정확한|자세한|상세한|구체적인|알려주세요|설명해주세요|가르쳐주세요|알려주시겠어요|설명해주시겠어요|가르쳐주시겠어요)/,
                    // 비교/분석 요청 패턴
                    /(차이점|비교|분석|장단점|장점|단점|어떤|어떤 것이|어떤 것이 좋은지|어떤 것이 나쁜지|어떤 것이 더|어떤 것이 적합한지)/,
                    // 과정/절차 요청 패턴
                    /(과정|절차|순서|단계|방법|어떻게|어떤 순서로|어떤 단계로|어떤 과정을|어떤 절차를|어떤 방법으로)/,
                    // 원인/이유 요청 패턴
                    /(원인|이유|왜|어떤 이유로|어떤 원인으로|왜 그런지|어떤 이유인지|어떤 원인인지|왜 그런가요|어떤 이유인가요|어떤 원인인가요)/
                ];
                
                const normalized = message.toLowerCase().trim();
                return detailedPatterns.some(pattern => pattern.test(normalized));
            }
            
            // 특정 양도세 계산 질문 감지 함수 추가
            isSpecificTaxCalculationQuery(message) {
                const taxKeywords = [
                    // 양도세 종류별 키워드
                    '부동산', '주식', '토지', '건물', '아파트', '빌라', '상가', '토지양도', '부동산양도', '주식양도',
                    'real estate', 'stock', 'land', 'building', 'apartment', 'villa', 'commercial property', 'land transfer', 'real estate transfer', 'stock transfer',
                    'недвижимость', 'акции', 'земля', 'здание', 'квартира', 'вилла', 'коммерческая недвижимость',
                    '不動産', '株式', '土地', '建物', 'アパート', 'マンション', '商業施設', '土地譲渡', '不動産譲渡', '株式譲渡'
                ];
                
                const calculationKeywords = [
                    // 계산 관련 키워드
                    '계산', '세율', '세금', '양도세', '얼마', '금액', '원',
                    'calculation', 'tax rate', 'tax', 'capital gains tax', 'amount', 'money',
                    'расчет', 'налоговая ставка', 'налог', 'сумма', 'деньги',
                    '計算', '税率', '税金', '譲渡税', '金額', 'お金', '円'
                ];
                
                const normalized = message.toLowerCase().trim();
                const hasTaxKeyword = taxKeywords.some(keyword => normalized.includes(keyword));
                const hasCalculationKeyword = calculationKeywords.some(keyword => normalized.includes(keyword));
                
                return hasTaxKeyword && hasCalculationKeyword;
            }
            
            // 스마트 대화 이력 필터링 함수 추가
            getSmartFilteredHistory(message) {
                const recentHistory = this.chatHistory.slice(-this.MAX_HISTORY);
                
                // 질문 유형에 따른 필터링
                if (this.isSpecificTaxCalculationQuery(message)) {
                    // 양도세 계산 질문: 이력 제외 (정확한 답변을 위해)
                    console.log('💰 양도세 계산 질문 감지: 대화 이력 제외');
                    return [];
                } else if (this.isDetailedQuestion(message)) {
                    // 상세 질문: 최근 5개 메시지만 포함 (관련성 높은 컨텍스트만)
                    console.log(' 상세 질문 감지: 최근 5개 메시지만 포함');
                    return recentHistory.slice(-5).map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));
                } else {
                    // 일반 질문: 기존 로직 사용
                    console.log(' 일반 질문: 기존 대화 이력 로직 사용');
                    return recentHistory.map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));
                }
            }
            
            // API 활성 상태 확인 (기본 OpenAI 활성화)
            hasActiveAPI() {
                const hasApi = this.apiSettings && (
                    (this.apiSettings.openai?.enabled) || // OpenAI는 활성화만 되어있으면 사용 가능 (API 키는 서버에서 처리)
                    (this.apiSettings.google?.enabled && this.apiSettings.google?.apiKey) ||
                    (this.apiSettings.anthropic?.enabled && this.apiSettings.anthropic?.apiKey)
                );
                
                // 브라우저별 추가 검증
                if (hasApi) {
                    const userAgent = navigator.userAgent;
                    const isChrome = /Chrome/.test(userAgent) && !/Edge/.test(userAgent);
                    
                    // Chrome 브라우저에서 추가 검증
                    if (isChrome) {
                        console.log('🔍 Chrome 브라우저에서 API 상태 추가 검증');
                        // Chrome에서는 실제 연결 테스트를 수행할 수 있음
                    }
                }
                
                return hasApi;
            }
            
            // 브라우저별 API 연결 테스트
            async testBrowserApiConnection() {
                const userAgent = navigator.userAgent;
                const browserInfo = {
                    isChrome: /Chrome/.test(userAgent) && !/Edge/.test(userAgent),
                    isEdge: /Edge/.test(userAgent),
                    isFirefox: /Firefox/.test(userAgent),
                    isSafari: /Safari/.test(userAgent) && !/Chrome/.test(userAgent),
                    isKakaoTalk: /KAKAO/.test(userAgent),
                    userAgent: userAgent.substring(0, 100)
                };
                
                console.log('🧪 브라우저별 API 연결 테스트 시작:', browserInfo);
                
                try {
                    // 간단한 API 연결 테스트
                    const testResponse = await fetch('/.netlify/functions/ask-ai', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o',
                            messages: [{ role: 'user', content: 'test' }],
                            max_tokens: 10
                        })
                    });
                    
                    const testResult = {
                        status: testResponse.status,
                        ok: testResponse.ok,
                        browser: browserInfo,
                        timestamp: new Date().toISOString()
                    };
                    
                    console.log('✅ 브라우저별 API 연결 테스트 결과:', testResult);
                    
                    // 테스트 결과를 로컬 스토리지에 저장
                    const testHistory = JSON.parse(localStorage.getItem('browserApiTestHistory') || '[]');
                    testHistory.push(testResult);
                    
                    // 최근 10개만 유지
                    if (testHistory.length > 10) {
                        testHistory.splice(0, testHistory.length - 10);
                    }
                    
                    localStorage.setItem('browserApiTestHistory', JSON.stringify(testHistory));
                    
                    return testResult;
                    
                } catch (error) {
                    console.error('❌ 브라우저별 API 연결 테스트 실패:', error);
                    
                    const testResult = {
                        status: 'error',
                        error: error.message,
                        browser: browserInfo,
                        timestamp: new Date().toISOString()
                    };
                    
                    // 오류 결과도 저장
                    const testHistory = JSON.parse(localStorage.getItem('browserApiTestHistory') || '[]');
                    testHistory.push(testResult);
                    
                    if (testHistory.length > 10) {
                        testHistory.splice(0, testHistory.length - 10);
                    }
                    
                    localStorage.setItem('browserApiTestHistory', JSON.stringify(testHistory));
                    
                    return testResult;
                }
            }
            
            // 활성화된 API 제공자 가져오기 (기본 OpenAI 활성화)
            getActiveProvider() {
                if (this.apiSettings?.openai?.enabled) {
                    return 'openai'; // OpenAI는 활성화만 되어있으면 사용 가능
                } else if (this.apiSettings?.google?.enabled && this.apiSettings.google?.apiKey) {
                    return 'google';
                } else if (this.apiSettings?.anthropic?.enabled && this.apiSettings.anthropic?.apiKey) {
                    return 'anthropic';
                }
                return null;
            }
            
            // 지식베이스에서 컨텍스트 정보 추출
            getContextFromKnowledgeBase() {
                if (!this.knowledgeBase.enabled || this.knowledgeBase.parsedData.length === 0) {
                    return '';
                }
                
                // 모든 Q&A를 컨텍스트로 정리
                let context = '\n\n=== 양도세 전문 지식 정보 ===\n';
                this.knowledgeBase.parsedData.forEach((qa, index) => {
                    context += `${index + 1}. Q: ${qa.question}\n   A: ${qa.answer}\n`;
                });
                
                return context;
            }
            
            // 언어별 예약 텍스트 반환
            getReservationText() {
                const texts = {
                    ko: {
                        message: '자세한 양도세 상담은 전문 세무사와 상담하세요!',
                        button: '📞 세무사 상담'
                    },
                    en: {
                        message: 'For detailed capital gains tax consultation, please consult with a tax professional!',
                        button: '📞 Tax Professional Consultation'
                    },
                    ru: {
                        message: 'Для подробной консультации по налогу на прирост капитала, пожалуйста, обратитесь к налоговому специалисту!',
                        button: '📞 Консультация налогового специалиста'
                    },
                    ja: {
                        message: '詳細な譲渡税相談は専門税理士にご相談ください！',
                        button: '📞 税理士相談'
                    }
                };
                
                return texts[this.currentLanguage] || texts['ko'];
            }
            
            // 언어별 전문상담원 텍스트 반환
            getConsultantText() {
                const texts = {
                    ko: {
                        message: '전문 세무사에게 1:1 양도세 상담 받아보세요!<br><br>(<strong>가능언어</strong> 한국어, 영어, 러시아어, 일본어)<br><br>(<strong>운영시간</strong> 오전9-오후9시, 점심 12시-13시)',
                        button: '💬 전문 세무사 1:1'
                    },
                    en: {
                        message: 'Get 1:1 capital gains tax consultation with a professional tax consultant!<br><br>(<strong>Available Languages</strong> Korean, English, Russian, Japanese)<br><br>(<strong>Operating Hours</strong> 9AM-9PM, Lunch 12PM-1PM)',
                        button: '💬 Professional Tax Consultant 1:1'
                    },
                    ru: {
                        message: 'Получите индивидуальную консультацию по налогу на прирост капитала у профессионального налогового консультанта!<br><br>(<strong>Доступные языки</strong> корейский, английский, русский, японский)<br><br>(<strong>Часы работы</strong> 9:00-21:00, Обед 12:00-13:00)',
                        button: '💬 Профессиональный налоговый консультант 1:1'
                    },
                    ja: {
                        message: '専門税理士に1対1譲渡税相談を受けてください！<br><br>（<strong>対応言語</strong> 韓国語、英語、ロシア語、日本語）<br><br>（<strong>営業時間</strong> 午前9時-午後9時、昼休み 12時-13時）',
                        button: '💬 専門税理士 1:1'
                    }
                };
                
                return texts[this.currentLanguage] || texts['ko'];
            }
            
            // API 호출 함수
            async callAPI(provider, message, contextInfo, useSmartFiltering = false) {
                const settings = this.apiSettings[provider];
                
                switch (provider) {
                    case 'openai':
                        return await this.callOpenAIAPI(message, settings, contextInfo, useSmartFiltering);
                    case 'google':
                        return await this.callGoogleAPI(message, settings, contextInfo, useSmartFiltering);
                    case 'anthropic':
                        return await this.callClaudeAPI(message, settings, contextInfo, useSmartFiltering);
                    default:
                        throw new Error('지원하지 않는 API 제공자입니다.');
                }
            }
            
            // OpenAI API 호출
            async callOpenAIAPI(message, settings, contextInfo, useSmartFiltering = false) {
                const systemPrompt = `당신은 Tax-Agent의 전문 양도세 상담사입니다. 
                매우 친절하고 전문적으로 답변해주세요.

                양도세 기본 정보:
                • 양도소득세: 자산을 양도할 때 발생하는 소득에 대한 세금
                • 과세대상: 부동산, 주식, 토지, 건물, 기타 자산의 양도
                • 과세표준: 양도가액 - 취득가액 - 필요경비
                • 세율: 과세표준에 따라 6%~45% (누진세율)
                • 신고기한: 양도일이 속하는 연도의 다음 연도 5월 31일까지
                • 신고방법: 국세청 홈택스 또는 세무서 방문

                주요 양도세 종류:
                • 부동산양도소득세: 부동산, 토지, 건물 양도 시
                • 주식양도소득세: 주식, 지분 양도 시
                • 기타자산양도소득세: 기타 자산 양도 시

                비과세 요건:
                • 1세대 1주택 비과세: 조건 충족 시 최대 12억원까지 비과세
                • 장기보유특별공제: 보유기간에 따라 공제율 적용
                • 기본공제: 연간 250만원 기본공제

                ${contextInfo}

                답변 작성 원칙:
                1. 매우 친절하고 따뜻한 말투를 사용하세요
                2. 전문적이면서도 이해하기 쉽게 설명하세요
                3. 구체적인 정보를 제공하되, 정확하지 않은 세무 조언은 피하세요
                4. 전문 세무사 상담이 필요한 경우 적극 안내하세요
                5. 답변을 구조화하여 읽기 쉽게 정리해주세요
                6. 양도세율, 양도세계산, 양도세신고, 비과세요건 등 주요 질문에 대해서는 자연스럽고 상세한 설명을 제공하세요
                7. 사용자의 편의를 고려한 실용적인 조언을 포함해주세요
                8. 고객이 보기 편하게 정리되어서 나가야 합니다
                9. 단어와 문장에 적합한 이모티콘도 적절히 사용하세요
                10. 이전 대화 내용을 참고하여 자연스럽게 대화를 이어가세요

                답변 형식 가이드라인 (구조화된 형식):
                - 메인 제목: # 제목 (예: # 양도세 기본 정보)
                - 부제목: ## 제목 (예: ## 양도세 계산 방법)
                - 소제목: ### 제목 (예: ### 비과세 요건)
                - 중요 정보는 **굵게** 표시하여 강조
                - 리스트는 • 또는 번호로 정리
                - 섹션 구분은 === 또는 --- 사용
                - 인용구는 > 텍스트 형태로 작성
                - 결론 섹션은 "결론" 또는 "요약" 키워드로 시작
                - 전체적으로 고객이 보기 편하고 읽기 쉬운 형식으로 구성
                - 각 섹션은 명확하게 구분되어야 함`;

                // 대화 이력 가져오기 (스마트 필터링 옵션)
                const chatHistory = useSmartFiltering ? 
                    this.getSmartFilteredHistory(message) : 
                    this.getChatHistoryForAPI();
                
                // 메시지 배열 구성 (시스템 프롬프트 + 대화 이력 + 현재 메시지)
                const messages = [
                    {
                        role: "system",
                        content: systemPrompt
                    },
                    ...chatHistory,
                    {
                        role: "user",
                        content: message
                    }
                ];

                console.log('🤖 ChatGPT API 호출 - 대화 이력 포함:', {
                    historyCount: chatHistory.length,
                    totalMessages: messages.length,
                    currentMessage: message.substring(0, 100) + '...'
                });

                // 브라우저별 호환성을 위한 fetch 옵션 설정
                const fetchOptions = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 브라우저별 호환성을 위한 추가 헤더
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        model: settings.model,
                        messages: messages,
                        max_tokens: 3000,
                        temperature: 0.7
                    })
                };

                // 브라우저 감지 및 특별 처리
                const userAgent = navigator.userAgent;
                const isChrome = /Chrome/.test(userAgent) && !/Edge/.test(userAgent);
                const isEdge = /Edge/.test(userAgent);
                const isFirefox = /Firefox/.test(userAgent);
                const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
                
                console.log('🌐 브라우저 감지:', {
                    userAgent: userAgent.substring(0, 100),
                    isChrome,
                    isEdge,
                    isFirefox,
                    isSafari
                });

                // Chrome 특별 처리 (캐시 방지)
                if (isChrome) {
                    fetchOptions.headers['Cache-Control'] = 'no-cache';
                    fetchOptions.headers['Pragma'] = 'no-cache';
                    console.log('🔧 Chrome 브라우저 감지 - 캐시 방지 헤더 추가');
                }

                // Edge 특별 처리 (타임아웃 설정)
                if (isEdge) {
                    console.log('🔧 Edge 브라우저 감지 - 타임아웃 설정 적용');
                }

                try {
                    const response = await fetch('/.netlify/functions/ask-ai', fetchOptions);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    // Edge 브라우저에서 마지막 단어 중복 문제 해결
                    let content = data.choices[0].message.content;
                    if (isEdge && content) {
                        // 마지막 단어 중복 제거 로직
                        const words = content.split(' ');
                        if (words.length > 1) {
                            const lastWord = words[words.length - 1];
                            const secondLastWord = words[words.length - 2];
                            if (lastWord === secondLastWord) {
                                words.pop();
                                content = words.join(' ');
                                console.log('🔧 Edge 브라우저: 마지막 단어 중복 제거');
                            }
                        }
                    }
                    
                    return content;
                } catch (error) {
                    console.error('❌ ChatGPT API 호출 실패:', error);
                    
                    // 브라우저별 오류 메시지
                    const browserErrorMessages = {
                        ko: {
                            chrome: 'Chrome 브라우저에서 API 호출 중 오류가 발생했습니다. 다른 브라우저로 시도해보세요.',
                            edge: 'Edge 브라우저에서 API 호출 중 오류가 발생했습니다. 다른 브라우저로 시도해보세요.',
                            firefox: 'Firefox 브라우저에서 API 호출 중 오류가 발생했습니다. 다른 브라우저로 시도해보세요.',
                            safari: 'Safari 브라우저에서 API 호출 중 오류가 발생했습니다. 다른 브라우저로 시도해보세요.',
                            default: '브라우저에서 API 호출 중 오류가 발생했습니다. 다른 브라우저로 시도해보세요.'
                        }
                    };
                    
                    let errorMessage = browserErrorMessages.ko.default;
                    if (isChrome) errorMessage = browserErrorMessages.ko.chrome;
                    else if (isEdge) errorMessage = browserErrorMessages.ko.edge;
                    else if (isFirefox) errorMessage = browserErrorMessages.ko.firefox;
                    else if (isSafari) errorMessage = browserErrorMessages.ko.safari;
                    
                    throw new Error(errorMessage);
                }
            }
            
            // Google API 호출
            async callGoogleAPI(message, settings, contextInfo, useSmartFiltering = false) {
                // 대화 이력 가져오기 (스마트 필터링 옵션)
                const chatHistory = useSmartFiltering ? 
                    this.getSmartFilteredHistory(message) : 
                    this.getChatHistoryForAPI();
                
                // Gemini용 대화 이력 구성
                let conversationContext = '';
                if (chatHistory.length > 0) {
                    conversationContext = '\n\n=== 이전 대화 내용 ===\n';
                    chatHistory.forEach((msg, index) => {
                        const role = msg.role === 'user' ? '사용자' : 'AI 상담사';
                        conversationContext += `${role}: ${msg.content}\n`;
                    });
                    conversationContext += '\n=== 현재 질문 ===\n';
                }

                const prompt = `당신은 Tax-Agent의 전문 양도세 상담사입니다. 
                매우 친절하고 전문적으로 답변해주세요.

                양도세 기본 정보:
                • 양도소득세: 자산을 양도할 때 발생하는 소득에 대한 세금
                • 과세대상: 부동산, 주식, 토지, 건물, 기타 자산의 양도
                • 과세표준: 양도가액 - 취득가액 - 필요경비
                • 세율: 과세표준에 따라 6%~45% (누진세율)
                • 신고기한: 양도일이 속하는 연도의 다음 연도 5월 31일까지
                • 신고방법: 국세청 홈택스 또는 세무서 방문

                주요 양도세 종류:
                • 부동산양도소득세: 부동산, 토지, 건물 양도 시
                • 주식양도소득세: 주식, 지분 양도 시
                • 기타자산양도소득세: 기타 자산 양도 시

                비과세 요건:
                • 1세대 1주택 비과세: 조건 충족 시 최대 12억원까지 비과세
                • 장기보유특별공제: 보유기간에 따라 공제율 적용
                • 기본공제: 연간 250만원 기본공제

                ${contextInfo}

                답변 작성 원칙:
                1. 매우 친절하고 따뜻한 말투를 사용하세요
                2. 전문적이면서도 이해하기 쉽게 설명하세요
                3. 구체적인 정보를 제공하되, 정확하지 않은 세무 조언은 피하세요
                4. 전문 세무사 상담이 필요한 경우 적극 안내하세요
                5. 답변을 구조화하여 읽기 쉽게 정리해주세요
                6. 양도세율, 양도세계산, 양도세신고, 비과세요건 등 주요 질문에 대해서는 자연스럽고 상세한 설명을 제공하세요
                7. 사용자의 편의를 고려한 실용적인 조언을 포함해주세요
                8. 고객이 보기 편하게 정리되어서 나가야 합니다
                9. 단어와 문장에 적합한 이모티콘도 적절히 사용하세요
                10. 이전 대화 내용을 참고하여 자연스럽게 대화를 이어가세요

                답변 형식 가이드라인 (구조화된 형식):
                - 메인 제목: # 제목 (예: # 양도세 기본 정보)
                - 부제목: ## 제목 (예: ## 양도세 계산 방법)
                - 소제목: ### 제목 (예: ### 비과세 요건)
                - 중요 정보는 **굵게** 표시하여 강조
                - 리스트는 • 또는 번호로 정리
                - 섹션 구분은 === 또는 --- 사용
                - 인용구는 > 텍스트 형태로 작성
                - 결론 섹션은 "결론" 또는 "요약" 키워드로 시작
                - 전체적으로 고객이 보기 편하고 읽기 쉬운 형식으로 구성
                - 각 섹션은 명확하게 구분되어야 함

                ${conversationContext}
                질문: ${message}`;

                console.log('🤖 Gemini API 호출 - 대화 이력 포함:', {
                    historyCount: chatHistory.length,
                    conversationContext: conversationContext.substring(0, 100) + '...',
                    currentMessage: message.substring(0, 100) + '...'
                });

                const response = await fetch('/.netlify/functions/ask-gemini', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: settings.model,
                        prompt: prompt,
                        maxOutputTokens: 3000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            }
            
            // Claude API 호출
            async callClaudeAPI(message, settings, contextInfo, useSmartFiltering = false) {
                // 대화 이력 가져오기 (스마트 필터링 옵션)
                const chatHistory = useSmartFiltering ? 
                    this.getSmartFilteredHistory(message) : 
                    this.getChatHistoryForAPI();
                
                // Claude용 대화 이력 구성
                let conversationContext = '';
                if (chatHistory.length > 0) {
                    conversationContext = '\n\n=== 이전 대화 내용 ===\n';
                    chatHistory.forEach((msg, index) => {
                        const role = msg.role === 'user' ? '사용자' : 'AI 상담사';
                        conversationContext += `${role}: ${msg.content}\n`;
                    });
                    conversationContext += '\n=== 현재 질문 ===\n';
                }

                const prompt = `당신은 Tax-Agent의 전문 양도세 상담사입니다. 
                매우 친절하고 전문적으로 답변해주세요.

                양도세 기본 정보:
                • 양도소득세: 자산을 양도할 때 발생하는 소득에 대한 세금
                • 과세대상: 부동산, 주식, 토지, 건물, 기타 자산의 양도
                • 과세표준: 양도가액 - 취득가액 - 필요경비
                • 세율: 과세표준에 따라 6%~45% (누진세율)
                • 신고기한: 양도일이 속하는 연도의 다음 연도 5월 31일까지
                • 신고방법: 국세청 홈택스 또는 세무서 방문

                주요 양도세 종류:
                • 부동산양도소득세: 부동산, 토지, 건물 양도 시
                • 주식양도소득세: 주식, 지분 양도 시
                • 기타자산양도소득세: 기타 자산 양도 시

                비과세 요건:
                • 1세대 1주택 비과세: 조건 충족 시 최대 12억원까지 비과세
                • 장기보유특별공제: 보유기간에 따라 공제율 적용
                • 기본공제: 연간 250만원 기본공제

                ${contextInfo}

                답변 작성 원칙:
                1. 매우 친절하고 따뜻한 말투를 사용하세요
                2. 전문적이면서도 이해하기 쉽게 설명하세요
                3. 구체적인 정보를 제공하되, 정확하지 않은 세무 조언은 피하세요
                4. 전문 세무사 상담이 필요한 경우 적극 안내하세요
                5. 답변을 구조화하여 읽기 쉽게 정리해주세요
                6. 양도세율, 양도세계산, 양도세신고, 비과세요건 등 주요 질문에 대해서는 자연스럽고 상세한 설명을 제공하세요
                7. 사용자의 편의를 고려한 실용적인 조언을 포함해주세요
                8. 고객이 보기 편하게 정리되어서 나가야 합니다
                9. 단어와 문장에 적합한 이모티콘도 적절히 사용하세요
                10. 이전 대화 내용을 참고하여 자연스럽게 대화를 이어가세요

                답변 형식 가이드라인 (구조화된 형식):
                - 메인 제목: # 제목 (예: # 양도세 기본 정보)
                - 부제목: ## 제목 (예: ## 양도세 계산 방법)
                - 소제목: ### 제목 (예: ### 비과세 요건)
                - 중요 정보는 **굵게** 표시하여 강조
                - 리스트는 • 또는 번호로 정리
                - 섹션 구분은 === 또는 --- 사용
                - 인용구는 > 텍스트 형태로 작성
                - 결론 섹션은 "결론" 또는 "요약" 키워드로 시작
                - 전체적으로 고객이 보기 편하고 읽기 쉬운 형식으로 구성
                - 각 섹션은 명확하게 구분되어야 함

                ${conversationContext}
                질문: ${message}`;

                console.log('🤖 Claude API 호출 - 대화 이력 포함:', {
                    historyCount: chatHistory.length,
                    conversationContext: conversationContext.substring(0, 100) + '...',
                    currentMessage: message.substring(0, 100) + '...'
                });

                const response = await fetch('/.netlify/functions/ask-claude', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: settings.model,
                        max_tokens: 3000,
                        messages: [{
                            role: "user",
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                return data.content[0].text;
            }
            
            // AI 응답 포맷팅
            formatAIResponse(response, provider) {
                const reservationText = this.getReservationText();
                const consultantText = this.getConsultantText();
                
                // AI 답변을 깔끔하게 정리
                const formattedResponse = this.formatAIResponseContent(response);
                
                return `${formattedResponse}
                
                <div class="reservation-message">
                    <div class="reservation-message-text">${consultantText.message}</div>
                    <button class="reservation-button" onclick="window.open('http://pf.kakao.com/_DiIin/chat', '_blank')">${consultantText.button}</button>
                </div>
                <div class="reservation-message">
                    <div class="reservation-message-text">${reservationText.message}</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                </div>`;
            }
            
            // AI 응답 내용 포맷팅 (구조화된 형식)
            formatAIResponseContent(response) {
                // 줄바꿈을 <br>로 변환
                let formatted = response.replace(/\n/g, '<br>');
                
                // 강조 텍스트 처리 (**텍스트** -> <strong>텍스트</strong>)
                formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                // 리스트 항목 처리 (• 또는 - 로 시작하는 줄)
                formatted = formatted.replace(/^[•\-]\s*(.*?)$/gm, '<div style="margin: 8px 0; padding-left: 20px; line-height: 1.6;">• $1</div>');
                
                // 번호가 있는 리스트 처리 (1. 2. 등)
                formatted = formatted.replace(/^(\d+)\.\s*(.*?)$/gm, '<div style="margin: 8px 0; padding-left: 20px; line-height: 1.6;">$1. $2</div>');
                
                // 섹션 구분선 처리 (=== 또는 ---) - 더 눈에 띄는 구분선으로 변경
                formatted = formatted.replace(/^={3,}$/gm, '<div style="height: 2px; background: linear-gradient(90deg, #4facfe, #00f2fe); margin: 20px 0; border-radius: 1px;"></div>');
                formatted = formatted.replace(/^-{3,}$/gm, '<div style="height: 1px; background: #e9ecef; margin: 15px 0;"></div>');
                
                // 제목 처리 (### 제목) - 더 강조된 스타일
                formatted = formatted.replace(/^###\s*(.*?)$/gm, '<div style="font-size: 16px; font-weight: bold; color: #2c3e50; margin: 20px 0 12px 0; padding: 8px 12px; background: #f8f9fa; border-left: 4px solid #4facfe; border-radius: 4px;">📋 $1</div>');
                
                // 부제목 처리 (## 제목) - 더 강조된 스타일
                formatted = formatted.replace(/^##\s*(.*?)$/gm, '<div style="font-size: 18px; font-weight: bold; color: #2c3e50; margin: 25px 0 15px 0; padding: 10px 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 6px;">💡 $1</div>');
                
                // 메인 제목 처리 (# 제목) - 더 강조된 스타일
                formatted = formatted.replace(/^#\s*(.*?)$/gm, '<div style="font-size: 20px; font-weight: bold; color: #2c3e50; margin: 30px 0 20px 0; padding: 15px 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border-radius: 8px; text-align: center;">💰 $1</div>');
                
                // 인용구 처리 (> 텍스트) - 더 눈에 띄는 박스로 변경
                formatted = formatted.replace(/^>\s*(.*?)$/gm, '<div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 15px 20px; margin: 15px 0; border-radius: 8px; border-left: 5px solid #4facfe; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">💬 $1</div>');
                
                // 코드 블록 처리 (```코드```) - 제거
                formatted = formatted.replace(/```(.*?)```/gs, '');
                
                // 인라인 코드 처리 (`코드`) - 제거
                formatted = formatted.replace(/`(.*?)`/g, '$1');
                
                // 큰 괄호로 감싸진 텍스트 강조 처리
                formatted = formatted.replace(/\((.*?)\)/g, '<span style="color: #4facfe; font-weight: 600;">($1)</span>');
                
                // 결론 섹션 강조 처리 (결론, 요약, 마무리 등의 키워드)
                formatted = formatted.replace(/(결론|요약|마무리|정리|마지막|마지막으로|요약하면|정리하면|결론적으로)/gi, '<div style="font-size: 16px; font-weight: bold; color: #2c3e50; margin: 20px 0 12px 0; padding: 10px 15px; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-radius: 6px; border-left: 4px solid #ffc107;">🎯 $1</div>');
                
                return formatted;
            }
            
            // AI 응답 생성
            async generateAIResponse(message, useSmartFiltering = false) {
                const loadingMessages = {
                    ko: '💰 Tax-Agent 양도세 전문 상담사가 답변을 준비 중 입니다...⏰<span class="loading-dots"></span>',
                    en: '💰 Tax-Agent capital gains tax specialist is preparing an answer...⏰<span class="loading-dots"></span>',
                    ru: '💰 Специалист по налогу на прирост капитала Tax-Agent готовит ответ...⏰<span class="loading-dots"></span>',
                    ja: '💰 Tax-Agent譲渡税専門相談員が回答を準備中です...⏰<span class="loading-dots"></span>'
                };
                
                const loadingMessage = this.addBotMessage(loadingMessages[this.currentLanguage] || loadingMessages['ko']);
                
                try {
                    // API 호출 로직
                    const activeProvider = this.getActiveProvider();
                    const contextInfo = this.getContextFromKnowledgeBase();
                    
                    // 스마트 필터링 옵션 전달
                    const response = await this.callAPI(activeProvider, message, contextInfo, useSmartFiltering);
                    this.removeMessage(loadingMessage);
                    this.addBotMessage(this.formatAIResponse(response, activeProvider));
                } catch (error) {
                    console.error('AI API 호출 실패:', error);
                    this.removeMessage(loadingMessage);
                    
                    // 오류 유형별 상세 메시지
                    let errorMessage = '';
                    if (error.message.includes('API key not configured')) {
                        errorMessage = {
                            ko: '🔑 API 키가 설정되지 않았습니다. 관리자 페이지에서 API 키를 설정해주세요.',
                            en: '🔑 API key is not configured. Please set up API key in admin page.',
                            ru: '🔑 Ключ API не настроен. Пожалуйста, настройте ключ API на странице администратора.',
                            ja: '🔑 APIキーが設定されていません。管理者ページでAPIキーを設定してください。'
                        };
                    } else if (error.message.includes('rate limit') || error.message.includes('quota')) {
                        errorMessage = {
                            ko: '⏰ API 사용 한도를 초과했습니다. 잠시 후 다시 시도해주세요.',
                            en: '⏰ API rate limit exceeded. Please try again later.',
                            ru: '⏰ Превышен лимит использования API. Пожалуйста, попробуйте позже.',
                            ja: '⏰ API使用制限を超過しました。しばらくしてから再試行してください。'
                        };
                    } else if (error.message.includes('network') || error.message.includes('fetch')) {
                        errorMessage = {
                            ko: '🌐 네트워크 연결 오류입니다. 인터넷 연결을 확인해주세요.',
                            en: '🌐 Network connection error. Please check your internet connection.',
                            ru: '🌐 Ошибка сетевого подключения. Пожалуйста, проверьте подключение к интернету.',
                            ja: '🌐 ネットワーク接続エラーです。インターネット接続を確認してください。'
                        };
                    } else {
                        errorMessage = {
                            ko: '🤖 AI API 호출 중 오류가 발생했습니다. 기본 답변을 제공합니다.',
                            en: '🤖 An error occurred while calling AI API. Providing default answer.',
                            ru: '🤖 Произошла ошибка при вызове ИИ API. Предоставляется базовый ответ.',
                            ja: '🤖 AI API呼び出し中にエラーが発生しました。デフォルト回答を提供します。'
                        };
                    }
                    
                    this.addBotMessage(errorMessage[this.currentLanguage] || errorMessage['ko']);
                    const fallbackResponse = this.generateSimulatedResponse(message);
                    this.addBotMessage(fallbackResponse);
                }
            }
            
            // 시뮬레이션된 응답 생성 (더 자연스럽게)
            generateSimulatedResponse(message) {
                const responses = {
                    ko: [
                        `안녕하세요! "${message}"에 대한 답변을 도와드리겠습니다.`,
                        'Tax-Agent 양도세 전문 상담사입니다. 더 자세한 상담이 필요하시면 언제든 연락주세요!',
                        '궁금한 점이 있으시면 양도세율, 양도세계산, 양도세신고, 비과세요건 등을 입력해보세요.'
                    ],
                    en: [
                        `Hello! I'll help you with an answer about "${message}".`,
                        'I am Tax-Agent capital gains tax specialist. Please contact us anytime if you need more detailed consultation!',
                        'If you have any questions, please try entering capital gains tax rates, tax calculation, tax filing, exemption requirements, etc.'
                    ],
                    ru: [
                        `Здравствуйте! Я помогу вам с ответом на "${message}".`,
                        'Я специалист по налогу на прирост капитала Tax-Agent. Пожалуйста, обращайтесь в любое время, если вам нужна более подробная консультация!',
                        'Если у вас есть вопросы, попробуйте ввести ставки налога на прирост капитала, расчет налога, подачу декларации, требования к льготам и т.д.'
                    ],
                    ja: [
                        `こんにちは！"${message}"についての回答をお手伝いします。`,
                        'Tax-Agent譲渡税専門相談員です。より詳細な相談が必要でしたら、いつでもご連絡ください！',
                        'ご質問がございましたら、譲渡税率、譲渡税計算、譲渡税申告、非課税要件などを入力してみてください。'
                    ]
                };
                
                const quickMenu = {
                    ko: {
                        title: '💡 <strong>빠른 양도세 문의 메뉴</strong>',
                        capitalGainsTax: '• "양도세" - 양도소득세 기본 정보',
                        taxCalculation: '• "양도세계산" - 양도세 계산 방법',
                        taxFiling: '• "양도세신고" - 양도세 신고 방법',
                        taxExemption: '• "비과세요건" - 양도세 비과세 요건',
                        directInquiry: '📞 <strong>직접 문의:</strong> 070-1234-1234'
                    },
                    en: {
                        title: '💡 <strong>Quick Capital Gains Tax Inquiry Menu</strong>',
                        capitalGainsTax: '• "Capital Gains Tax" - Basic capital gains tax information',
                        taxCalculation: '• "Tax Calculation" - How to calculate capital gains tax',
                        taxFiling: '• "Tax Filing" - How to file capital gains tax',
                        taxExemption: '• "Exemption Requirements" - Capital gains tax exemption requirements',
                        directInquiry: '📞 <strong>Direct Inquiry:</strong> 070-1234-1234'
                    },
                    ru: {
                        title: '💡 <strong>Быстрое меню запросов по налогу на прирост капитала</strong>',
                        capitalGainsTax: '• "Налог на прирост капитала" - Основная информация о налоге',
                        taxCalculation: '• "Расчет налога" - Как рассчитать налог на прирост капитала',
                        taxFiling: '• "Подача декларации" - Как подать декларацию по налогу',
                        taxExemption: '• "Требования к льготам" - Требования к освобождению от налога',
                        directInquiry: '📞 <strong>Прямой запрос:</strong> 070-1234-1234'
                    },
                    ja: {
                        title: '💡 <strong>クイック譲渡税問い合わせメニュー</strong>',
                        capitalGainsTax: '• "譲渡税" - 譲渡所得税基本情報',
                        taxCalculation: '• "譲渡税計算" - 譲渡税計算方法',
                        taxFiling: '• "譲渡税申告" - 譲渡税申告方法',
                        taxExemption: '• "非課税要件" - 譲渡税非課税要件',
                        directInquiry: '📞 <strong>直接問い合わせ:</strong> 070-1234-1234'
                    }
                };
                
                const apiStatus = {
                    ko: this.hasActiveAPI() ? 
                        '🤖 AI API가 연결되어 있어 더 정확한 답변을 제공할 수 있습니다.' : 
                        '❌ AI API가 설정되지 않아 기본 답변을 제공합니다. (관리자 메뉴에서 AI API 설정 가능)',
                    en: this.hasActiveAPI() ? 
                        '🤖 AI API is connected and can provide more accurate answers.' : 
                        '❌ AI API is not set up, providing basic answers. (AI API can be set up in admin menu)',
                    ru: this.hasActiveAPI() ? 
                        '🤖 ИИ API подключен и может предоставить более точные ответы.' : 
                        '❌ ИИ API не настроен, предоставляются базовые ответы. (ИИ API можно настроить в меню администратора)',
                    ja: this.hasActiveAPI() ? 
                        '🤖 AI APIが接続されており、より正確な回答を提供できます。' : 
                        '❌ AI APIが設定されていないため、基本的な回答を提供します。（管理者メニューでAI API設定可能）'
                };
                
                const currentResponses = responses[this.currentLanguage] || responses['ko'];
                const currentQuickMenu = quickMenu[this.currentLanguage] || quickMenu['ko'];
                const currentApiStatus = apiStatus[this.currentLanguage] || apiStatus['ko'];
                const reservationText = this.getReservationText();
                
                return currentResponses[Math.floor(Math.random() * currentResponses.length)] + `
                
<div style="margin: 15px 0;">
${currentQuickMenu.title}
</div>

<div style="margin: 10px 0;">
${currentQuickMenu.capitalGainsTax}
${currentQuickMenu.taxCalculation}
${currentQuickMenu.taxFiling}
${currentQuickMenu.taxExemption}
</div>

<div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #4facfe;">
${currentApiStatus}
</div>

<div style="margin: 15px 0;">
${currentQuickMenu.directInquiry}
</div>

<div class="reservation-message">
    <div class="reservation-message-text">${reservationText.message}</div>
    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
</div>`;
            }
            
            // 사용자 메시지 추가
            addUserMessage(message) {
                const messagesContainer = document.getElementById('chatbotMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user';
                messageDiv.innerHTML = `
                    <div class="message-avatar">👤</div>
                    <div class="message-content">${this.escapeHtml(message)}</div>
                `;
                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                // 대화 이력에 사용자 메시지 추가
                this.addToChatHistory('user', message);
            }
            
            // 봇 메시지 추가
            addBotMessage(message) {
                const messagesContainer = document.getElementById('chatbotMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';
                messageDiv.innerHTML = `
                    <div class="message-avatar">💰</div>
                    <div class="message-content">${message}</div>
                `;
                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                // 대화 이력에 봇 메시지 추가 (HTML 태그 제거)
                const cleanMessage = this.stripHtmlTags(message);
                this.addToChatHistory('assistant', cleanMessage);
                
                return messageDiv;
            }
            
            // 대화 이력에 메시지 추가
            addToChatHistory(role, content) {
                this.chatHistory.push({
                    role: role,
                    content: content,
                    timestamp: Date.now()
                });
                
                // 최대 이력 개수 제한
                if (this.chatHistory.length > this.MAX_HISTORY * 2) {
                    this.chatHistory = this.chatHistory.slice(-this.MAX_HISTORY * 2);
                }
                
                console.log(`💬 대화 이력 추가: ${role} - ${content.substring(0, 50)}...`);
            }
            
            // HTML 태그 제거
            stripHtmlTags(html) {
                const div = document.createElement('div');
                div.innerHTML = html;
                return div.textContent || div.innerText || '';
            }
            
            // AI API용 대화 이력 가져오기 (토큰 한도 최적화)
            getChatHistoryForAPI() {
                // 토큰 한도를 고려하여 대화 이력 제한
                const maxHistoryForAPI = Math.min(this.MAX_HISTORY, 10); // 최대 10개로 제한
                const recentHistory = this.chatHistory.slice(-maxHistoryForAPI);
                
                // 각 메시지의 길이를 확인하고 너무 긴 메시지는 축약
                const optimizedHistory = recentHistory.map(msg => {
                    let content = msg.content;
                    
                    // 메시지가 너무 길면 축약 (HTML 태그 제거 후 길이 확인)
                    const plainText = this.stripHtmlTags(content);
                    if (plainText.length > 500) {
                        content = plainText.substring(0, 500) + '...';
                    }
                    
                    return {
                        role: msg.role,
                        content: content
                    };
                });
                
                console.log(`📝 API용 대화 이력 최적화: ${recentHistory.length}개 → ${optimizedHistory.length}개`);
                
                return optimizedHistory;
            }
            
            // 대화 이력 초기화
            clearChatHistory() {
                this.chatHistory = [];
                console.log('🗑️ 대화 이력 초기화 완료');
            }
            
            // HTML 이스케이프
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // 메시지 제거
            removeMessage(messageElement) {
                if (messageElement && messageElement.parentNode) {
                    messageElement.parentNode.removeChild(messageElement);
                }
            }
            
            // 스크롤 하단 이동
            scrollToBottom() {
                const messagesContainer = document.getElementById('chatbotMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // 환영 메시지 추가
            addWelcomeMessage() {
                const t = this.translations[this.currentLanguage];
                
                const quickButtons = {
                    ko: {
                        capitalGainsTax: { text: '💰 양도세', message: '양도세 기본 정보 알려주세요' },
                        taxCalculation: { text: '🧮 양도세계산', message: '양도세 계산 방법 궁금해요' },
                        taxFiling: { text: '📋 양도세신고', message: '양도세 신고 방법 알려주세요' },
                        taxExemption: { text: '✅ 비과세요건', message: '양도세 비과세 요건 궁금해요' }
                    },
                    en: {
                        capitalGainsTax: { text: '💰 Capital Gains Tax', message: 'Tell me about capital gains tax basics' },
                        taxCalculation: { text: '🧮 Tax Calculation', message: 'I want to know how to calculate capital gains tax' },
                        taxFiling: { text: '📋 Tax Filing', message: 'Tell me how to file capital gains tax' },
                        taxExemption: { text: '✅ Exemption Requirements', message: 'I want to know about exemption requirements' }
                    },
                    ru: {
                        capitalGainsTax: { text: '💰 Налог на прирост капитала', message: 'Расскажите об основах налога на прирост капитала' },
                        taxCalculation: { text: '🧮 Расчет налога', message: 'Хочу узнать как рассчитать налог на прирост капитала' },
                        taxFiling: { text: '📋 Подача декларации', message: 'Расскажите как подать декларацию по налогу' },
                        taxExemption: { text: '✅ Требования к льготам', message: 'Хочу узнать о требованиях к освобождению от налога' }
                    },
                    ja: {
                        capitalGainsTax: { text: '💰 譲渡税', message: '譲渡税の基本情報を教えてください' },
                        taxCalculation: { text: '🧮 譲渡税計算', message: '譲渡税の計算方法を知りたいです' },
                        taxFiling: { text: '📋 譲渡税申告', message: '譲渡税の申告方法を教えてください' },
                        taxExemption: { text: '✅ 非課税要件', message: '譲渡税の非課税要件を知りたいです' }
                    }
                };
                
                const currentButtons = quickButtons[this.currentLanguage] || quickButtons['ko'];
                
                const welcomeMessage = `
                    <div style="text-align: center; color: #333;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #2c3e50;">
                            ${t.welcomeMessage}
                        </div>
                        <div style="font-size: 14px; color: #666; line-height: 1.5; margin-bottom: 15px;">
                            ${t.welcomeSubMessage}
                        </div>
                        <div class="quick-buttons">
                            <button class="quick-button clinic-hours-btn" onclick="chatbot.handleQuickMessage('${currentButtons.capitalGainsTax.message}')">
                                ${currentButtons.capitalGainsTax.text}
                            </button>
                            <button class="quick-button treatment-cost-btn" onclick="chatbot.handleQuickMessage('${currentButtons.taxCalculation.message}')">
                                ${currentButtons.taxCalculation.text}
                            </button>
                            <button class="quick-button reservation-btn" onclick="chatbot.handleQuickMessage('${currentButtons.taxFiling.message}')">
                                ${currentButtons.taxFiling.text}
                            </button>
                            <button class="quick-button directions-btn" onclick="chatbot.handleQuickMessage('${currentButtons.taxExemption.message}')">
                                ${currentButtons.taxExemption.text}
                            </button>
                        </div>
                    </div>
                `;
                
                this.addBotMessage(welcomeMessage);
            }
            
            // 빠른 메시지 처리
            handleQuickMessage(message) {
                console.log('⚡ 빠른 메시지:', message);
                this.addUserMessage(message);
                this.processMessage(message);
            }
            
                    // 언어 UI 업데이트
        updateLanguageUI() {
            const t = this.translations[this.currentLanguage];
            
            document.querySelector('.chatbot-title').textContent = t.title;
            document.getElementById('chatbotInput').placeholder = t.placeholder;
            document.querySelector('.chatbot-send').textContent = t.sendButton;
            document.getElementById('currentLanguageText').textContent = t.currentLanguage;
            
            // 드롭다운 옵션 업데이트
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-lang') === this.currentLanguage) {
                    option.classList.add('active');
                }
            });
        }
        
        // 이벤트 리스너 설정
        setupEventListeners() {
            // 안드로이드 카카오톡 브라우저 최적화된 드롭다운 처리
            this.setupLanguageDropdown();
            
            // 외부 클릭 시 드롭다운 닫기 (안드로이드 최적화)
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.language-dropdown')) {
                    this.closeLanguageMenu();
                }
            });
            
            // 터치 이벤트로 외부 클릭 감지 (안드로이드 대응)
            document.addEventListener('touchend', (e) => {
                if (!e.target.closest('.language-dropdown')) {
                    this.closeLanguageMenu();
                }
            });
        }
        
        // 언어 드롭다운 설정 (안드로이드 카카오톡 브라우저 최적화)
        setupLanguageDropdown() {
            const languageButton = document.querySelector('.language-current');
            const languageMenu = document.getElementById('languageMenu');
            
            if (!languageButton || !languageMenu) return;
            
            // 브라우저 감지
            const userAgent = navigator.userAgent;
            const isAndroidKakao = /Android/.test(userAgent) && /KAKAO/.test(userAgent);
            const isWindows = /Windows/.test(userAgent);
            const isChrome = /Chrome/.test(userAgent) && !/Edge/.test(userAgent);
            const isEdge = /Edge/.test(userAgent);
            const isFirefox = /Firefox/.test(userAgent);
            
            console.log('브라우저 감지:', {
                userAgent: userAgent,
                isAndroidKakao: isAndroidKakao,
                isWindows: isWindows,
                isChrome: isChrome,
                isEdge: isEdge,
                isFirefox: isFirefox
            });
            
            if (isAndroidKakao) {
                // 안드로이드 카카오톡 브라우저용 터치 이벤트 처리
                let touchStartTime = 0;
                let touchEndTime = 0;
                let isMenuOpen = false;
                
                // 터치 시작
                languageButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    touchStartTime = Date.now();
                    console.log('안드로이드 카카오톡: 터치 시작');
                }, { passive: false });
                
                // 터치 종료
                languageButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    touchEndTime = Date.now();
                    const touchDuration = touchEndTime - touchStartTime;
                    
                    console.log('안드로이드 카카오톡: 터치 종료, 지속시간:', touchDuration);
                    
                    // 짧은 터치만 처리 (1초 미만)
                    if (touchDuration < 1000) {
                        if (isMenuOpen) {
                            this.closeLanguageMenu();
                            isMenuOpen = false;
                        } else {
                            this.openLanguageMenu();
                            isMenuOpen = true;
                        }
                    }
                }, { passive: false });
                
                // 클릭 이벤트도 함께 처리 (백업)
                languageButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('안드로이드 카카오톡: 클릭 이벤트');
                    
                    if (isMenuOpen) {
                        this.closeLanguageMenu();
                        isMenuOpen = false;
                    } else {
                        this.openLanguageMenu();
                        isMenuOpen = true;
                    }
                });
                
                // 언어 옵션 선택 시 메뉴 닫기
                document.querySelectorAll('.language-option').forEach(option => {
                    option.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('안드로이드 카카오톡: 언어 옵션 선택');
                        isMenuOpen = false;
                    }, { passive: false });
                    
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('안드로이드 카카오톡: 언어 옵션 클릭');
                        isMenuOpen = false;
                    });
                });
                
            } else {
                // 윈도우 브라우저 및 일반 브라우저용 처리
                let isMenuOpen = false;
                
                // 클릭 이벤트 처리
                languageButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('윈도우/일반 브라우저: 클릭 이벤트');
                    
                    if (isMenuOpen) {
                        this.closeLanguageMenu();
                        isMenuOpen = false;
                    } else {
                        this.openLanguageMenu();
                        isMenuOpen = true;
                    }
                });
                
                // 마우스 이벤트 처리 (윈도우 브라우저 최적화)
                if (isWindows) {
                    languageButton.addEventListener('mouseenter', (e) => {
                        console.log('윈도우 브라우저: 마우스 진입');
                    });
                    
                    languageButton.addEventListener('mouseleave', (e) => {
                        console.log('윈도우 브라우저: 마우스 이탈');
                    });
                }
                
                // 언어 옵션 선택 시 메뉴 닫기
                document.querySelectorAll('.language-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('윈도우/일반 브라우저: 언어 옵션 클릭');
                        isMenuOpen = false;
                    });
                    
                    // 마우스 이벤트도 추가
                    option.addEventListener('mouseenter', (e) => {
                        console.log('언어 옵션 마우스 진입');
                    });
                    
                    option.addEventListener('mouseleave', (e) => {
                        console.log('언어 옵션 마우스 이탈');
                    });
                });
            }
        }
        
        // 언어 메뉴 열기
        openLanguageMenu() {
            const menu = document.getElementById('languageMenu');
            if (menu) {
                menu.classList.add('show');
                console.log('언어 메뉴 열기');
            }
        }
        
        // 언어 메뉴 닫기
        closeLanguageMenu() {
            const menu = document.getElementById('languageMenu');
            if (menu) {
                menu.classList.remove('show');
                console.log('언어 메뉴 닫기');
            }
        }
        
        // 언어 메뉴 토글
        toggleLanguageMenu() {
            const menu = document.getElementById('languageMenu');
            if (menu) {
                menu.classList.toggle('show');
                console.log('언어 메뉴 토글');
            }
        }
            
                    // 모바일 최적화 설정
        setupMobileOptimization() {
            this.setViewportHeight();
            window.addEventListener('resize', () => this.setViewportHeight());
            window.addEventListener('orientationchange', () => {
                setTimeout(() => this.setViewportHeight(), 100);
            });
            
            // 키보드 감지
            this.setupKeyboardDetection();
            
            // 안드로이드 카카오톡 브라우저 감지 및 최적화
            this.detectAndroidKakaoBrowser();
        }
        
        // 브라우저 감지 (안드로이드 카카오톡 + 윈도우 브라우저)
        detectAndroidKakaoBrowser() {
            const userAgent = navigator.userAgent;
            const isAndroid = /Android/.test(userAgent);
            const isKakao = /KAKAO/.test(userAgent);
            const isWindows = /Windows/.test(userAgent);
            const isChrome = /Chrome/.test(userAgent) && !/Edge/.test(userAgent);
            const isEdge = /Edge/.test(userAgent);
            const isFirefox = /Firefox/.test(userAgent);
            
            console.log('브라우저 감지 결과:', {
                isAndroid: isAndroid,
                isKakao: isKakao,
                isWindows: isWindows,
                isChrome: isChrome,
                isEdge: isEdge,
                isFirefox: isFirefox
            });
            
            if (isAndroid && isKakao) {
                console.log('안드로이드 카카오톡 브라우저 감지됨');
                document.body.classList.add('android-kakao');
                
                // 안드로이드 카카오톡 브라우저 특별 최적화
                this.setupAndroidKakaoOptimizations();
            } else if (isWindows) {
                console.log('윈도우 브라우저 감지됨');
                document.body.classList.add('windows-browser');
                
                // 윈도우 브라우저 특별 최적화
                this.setupWindowsBrowserOptimizations();
            }
        }
        
        // 안드로이드 카카오톡 브라우저 최적화
        setupAndroidKakaoOptimizations() {
            // 터치 이벤트 최적화
            const allButtons = document.querySelectorAll('button, .language-current, .language-option');
            allButtons.forEach(button => {
                button.style.setProperty('-webkit-tap-highlight-color', 'transparent', 'important');
                button.style.setProperty('touch-action', 'manipulation', 'important');
                button.style.setProperty('-webkit-touch-callout', 'none', 'important');
                button.style.setProperty('-webkit-user-select', 'none', 'important');
                button.style.setProperty('user-select', 'none', 'important');
            });
            
            // 스크롤 최적화
            const messagesContainer = document.getElementById('chatbotMessages');
            if (messagesContainer) {
                messagesContainer.style.setProperty('-webkit-overflow-scrolling', 'touch', 'important');
                messagesContainer.style.setProperty('overscroll-behavior', 'contain', 'important');
            }
            
            console.log('안드로이드 카카오톡 브라우저 최적화 적용 완료');
        }
        
        // 윈도우 브라우저 최적화
        setupWindowsBrowserOptimizations() {
            // 마우스 이벤트 최적화
            const allButtons = document.querySelectorAll('button, .language-current, .language-option');
            allButtons.forEach(button => {
                button.style.setProperty('cursor', 'pointer', 'important');
                button.style.setProperty('user-select', 'none', 'important');
                button.style.setProperty('-webkit-user-select', 'none', 'important');
            });
            
            // 언어 드롭다운 버튼 특별 최적화
            const languageButton = document.querySelector('.language-current');
            if (languageButton) {
                languageButton.style.setProperty('transition', 'all 0.2s ease', 'important');
                languageButton.style.setProperty('cursor', 'pointer', 'important');
                
                // 호버 효과 강화
                languageButton.addEventListener('mouseenter', () => {
                    languageButton.style.setProperty('transform', 'translateY(-1px)', 'important');
                    languageButton.style.setProperty('box-shadow', '0 4px 12px rgba(255, 215, 0, 0.5)', 'important');
                });
                
                languageButton.addEventListener('mouseleave', () => {
                    languageButton.style.setProperty('transform', 'translateY(0)', 'important');
                    languageButton.style.setProperty('box-shadow', '0 3px 10px rgba(255, 215, 0, 0.4)', 'important');
                });
            }
            
            // 언어 옵션 호버 효과
            const languageOptions = document.querySelectorAll('.language-option');
            languageOptions.forEach(option => {
                option.style.setProperty('transition', 'all 0.2s ease', 'important');
                option.style.setProperty('cursor', 'pointer', 'important');
                
                option.addEventListener('mouseenter', () => {
                    option.style.setProperty('background', 'linear-gradient(135deg, #ffd700 0%, #ffed4e 100%)', 'important');
                    option.style.setProperty('transform', 'translateX(2px)', 'important');
                });
                
                option.addEventListener('mouseleave', () => {
                    if (!option.classList.contains('active')) {
                        option.style.setProperty('background', 'transparent', 'important');
                    }
                    option.style.setProperty('transform', 'translateX(0)', 'important');
                });
            });
            
            console.log('윈도우 브라우저 최적화 적용 완료');
        }
            
            // 뷰포트 높이 설정
            setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            // 키보드 감지 설정
            setupKeyboardDetection() {
                const initialHeight = window.innerHeight;
                
                window.addEventListener('resize', () => {
                    const currentHeight = window.innerHeight;
                    const heightDiff = initialHeight - currentHeight;
                    
                    if (heightDiff > 150) {
                        document.body.classList.add('keyboard-open');
                    } else {
                        document.body.classList.remove('keyboard-open');
                    }
                });
            }
            
            // API 설정 로딩 (기본 OpenAI 활성화)
            loadApiSettings() {
                try {
                    // 새로운 관리자 페이지에서 저장한 설정들을 로드
                    const openaiSettings = JSON.parse(localStorage.getItem('openaiSettings') || '{}');
                    const googleSettings = JSON.parse(localStorage.getItem('googleSettings') || '{}');
                    const anthropicSettings = JSON.parse(localStorage.getItem('anthropicSettings') || '{}');
                    
                    this.apiSettings = {
                        openai: {
                            enabled: openaiSettings.enabled !== undefined ? openaiSettings.enabled : true, // 기본값: 활성화
                            apiKey: openaiSettings.apiKey || '',
                            model: openaiSettings.model || 'gpt-4o'
                        },
                        google: {
                            enabled: googleSettings.enabled || false,
                            apiKey: googleSettings.apiKey || '',
                            model: googleSettings.model || 'gemini-flash-2.5'
                        },
                        anthropic: {
                            enabled: anthropicSettings.enabled || false,
                            apiKey: anthropicSettings.apiKey || '',
                            model: anthropicSettings.model || 'claude-3-5-sonnet-20241022'
                        }
                    };
                    
                    console.log('✅ API 설정 로드 완료:', {
                        openai: this.apiSettings.openai.enabled ? '활성화' : '비활성화',
                        google: this.apiSettings.google.enabled ? '활성화' : '비활성화',
                        anthropic: this.apiSettings.anthropic.enabled ? '활성화' : '비활성화'
                    });
                } catch (error) {
                    console.error('❌ API 설정 로드 실패:', error);
                    this.apiSettings = {
                        openai: { enabled: true, apiKey: '', model: 'gpt-4o' }, // 기본값: 활성화
                        google: { enabled: false, apiKey: '', model: 'gemini-flash-2.5' },
                        anthropic: { enabled: false, apiKey: '', model: 'claude-3-5-sonnet-20241022' }
                    };
                }
            }
            
            // 지식베이스 설정 로딩
            loadKnowledgeBaseSettings() {
                try {
                    const saved = localStorage.getItem('chatbotKnowledgeBase');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.knowledgeBase.enabled = parsed.enabled || false;
                        this.knowledgeBase.parsedData = parsed.parsedData || [];
                        console.log('✅ 지식베이스 설정 로드 완료:', this.knowledgeBase.parsedData.length, '개 Q&A');
                    }
                } catch (error) {
                    console.error('❌ 지식베이스 설정 로드 실패:', error);
                }
            }
            
            // 대화 이력 설정 로딩
            loadHistorySettings() {
                try {
                    const saved = localStorage.getItem('chatbotHistorySettings');
                    if (saved) {
                        const settings = JSON.parse(saved);
                        this.MAX_HISTORY = settings.maxHistory || 20;
                        this.MAX_TOKENS = settings.maxTokens || 1500;
                        console.log('✅ 대화 이력 설정 로드 완료:', {
                            maxHistory: this.MAX_HISTORY,
                            maxTokens: this.MAX_TOKENS
                        });
                    }
                } catch (error) {
                    console.error('❌ 대화 이력 설정 로드 실패:', error);
                }
            }
            
            // API 상태 표시 업데이트 (브라우저별 호환성 개선)
            updateApiStatusDisplay() {
                const apiStatus = document.getElementById('apiStatus');
                if (!apiStatus) return; // 요소가 없으면 리턴
                
                // 브라우저 감지
                const userAgent = navigator.userAgent;
                const isChrome = /Chrome/.test(userAgent) && !/Edge/.test(userAgent);
                const isEdge = /Edge/.test(userAgent);
                const isFirefox = /Firefox/.test(userAgent);
                const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
                const isKakaoTalk = /KAKAO/.test(userAgent);
                
                if (!this.hasActiveAPI()) {
                    apiStatus.innerHTML = '🔴 AI OFF';
                    apiStatus.className = 'ai-off';
                    
                    // 브라우저별 추가 정보 표시
                    if (isChrome) {
                        apiStatus.title = 'Chrome 브라우저에서 API 연결 문제가 있을 수 있습니다. Edge나 다른 브라우저로 시도해보세요.';
                    } else if (isEdge) {
                        apiStatus.title = 'Edge 브라우저에서 정상 작동합니다.';
                    } else if (isFirefox) {
                        apiStatus.title = 'Firefox 브라우저에서 API 연결을 확인해주세요.';
                    } else if (isSafari) {
                        apiStatus.title = 'Safari 브라우저에서 API 연결을 확인해주세요.';
                    } else if (isKakaoTalk) {
                        apiStatus.title = '카카오톡 브라우저에서 정상 작동합니다.';
                    }
                    return;
                }
                
                const activeApis = [];
                if (this.apiSettings?.openai?.enabled) activeApis.push('OpenAI');
                if (this.apiSettings?.google?.enabled) activeApis.push('Google');
                
                // 브라우저별 상태 메시지
                let statusText = `<span class="blink">🟢</span> n8n 엔진 On`;
                let statusTitle = `활성화된 API: ${activeApis.join(', ')}`;
                
                if (isChrome) {
                    statusTitle += ' (Chrome 브라우저 - 문제 발생 시 Edge로 시도해보세요)';
                } else if (isEdge) {
                    statusTitle += ' (Edge 브라우저 - 정상 작동)';
                } else if (isFirefox) {
                    statusTitle += ' (Firefox 브라우저)';
                } else if (isSafari) {
                    statusTitle += ' (Safari 브라우저)';
                } else if (isKakaoTalk) {
                    statusTitle += ' (카카오톡 브라우저 - 정상 작동)';
                }
                
                apiStatus.innerHTML = statusText;
                apiStatus.className = 'ai-on';
                apiStatus.title = statusTitle;
                
                console.log('🌐 API 상태 업데이트:', {
                    browser: {
                        isChrome,
                        isEdge,
                        isFirefox,
                        isSafari,
                        isKakaoTalk
                    },
                    activeApis,
                    userAgent: userAgent.substring(0, 100)
                });
            }
            
            // 지식베이스 검색 (간소화된 버전)
            searchInKnowledgeBase(message) {
                if (!this.knowledgeBase.enabled || this.knowledgeBase.parsedData.length === 0) {
                    return null;
                }
                
                const query = message.toLowerCase().trim();
                let bestMatch = null;
                let bestScore = 0;
                
                for (const qa of this.knowledgeBase.parsedData) {
                    const question = qa.question.toLowerCase();
                    const answer = qa.answer.toLowerCase();
                    
                    let score = 0;
                    
                    // 완전 일치
                    if (question === query) score += 1000;
                    
                    // 부분 포함
                    if (question.includes(query) || query.includes(question)) score += 500;
                    
                    // 단어 매칭
                    const queryWords = query.split(/\s+/).filter(w => w.length > 1);
                    for (const word of queryWords) {
                        if (question.includes(word)) score += 100;
                        if (answer.includes(word)) score += 50;
                    }
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = qa;
                    }
                }
                
                if (bestScore >= 50) {
                    const reservationText = this.getReservationText();
                    
                    const knowledgeResponse = {
                        ko: {
                            title: '📚 <strong>피닉스 치과 전문 지식 답변</strong>',
                            note: '💡 전문 지식 데이터베이스에서 제공된 답변입니다.'
                        },
                        en: {
                            title: '📚 <strong>Phoenix Dental Professional Knowledge Answer</strong>',
                            note: '💡 Answer provided from professional knowledge database.'
                        },
                        ru: {
                            title: '📚 <strong>Профессиональный ответ Phoenix Dental</strong>',
                            note: '💡 Ответ предоставлен из профессиональной базы знаний.'
                        },
                        ja: {
                            title: '📚 <strong>フェニックス歯科専門知識回答</strong>',
                            note: '💡 専門知識データベースから提供された回答です。'
                        }
                    };
                    
                    const currentKnowledge = knowledgeResponse[this.currentLanguage] || knowledgeResponse['ko'];
                    
                    return `${currentKnowledge.title}<br><br>
                            <strong>Q:</strong> ${bestMatch.question}<br><br>
                            <strong>A:</strong> ${bestMatch.answer}<br><br>
                            <small>${currentKnowledge.note}</small>
                            
                            <div class="reservation-message">
                                <div class="reservation-message-text">${reservationText.message}</div>
                                <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                            </div>`;
                }
                
                return null;
            }
            
            // 콘텐츠 생성 메서드들
            createCapitalGainsTaxContent(lang) {
                const content = {
                    ko: '💰 <strong>양도소득세 기본 정보</strong><br><br>📋 <strong>정의:</strong> 자산을 양도할 때 발생하는 소득에 대한 세금<br>📋 <strong>과세대상:</strong> 부동산, 주식, 토지, 건물, 기타 자산의 양도<br>📋 <strong>과세표준:</strong> 양도가액 - 취득가액 - 필요경비<br>📋 <strong>세율:</strong> 과세표준에 따라 6%~45% (누진세율)<br>📋 <strong>신고기한:</strong> 양도일이 속하는 연도의 다음 연도 5월 31일까지<br><br>💡 <strong>정확한 계산은 전문 세무사와 상담하세요!</strong>',
                    en: '💰 <strong>Capital Gains Tax Basic Information</strong><br><br>📋 <strong>Definition:</strong> Tax on income from asset transfers<br>📋 <strong>Taxable Items:</strong> Real estate, stocks, land, buildings, other assets<br>📋 <strong>Tax Base:</strong> Transfer amount - Acquisition cost - Necessary expenses<br>📋 <strong>Tax Rate:</strong> 6%~45% based on tax base (progressive rate)<br>📋 <strong>Filing Deadline:</strong> May 31st of the year following the transfer<br><br>💡 <strong>For accurate calculation, consult with a tax professional!</strong>',
                    ru: '💰 <strong>Основная информация о налоге на прирост капитала</strong><br><br>📋 <strong>Определение:</strong> Налог на доход от передачи активов<br>📋 <strong>Облагаемые объекты:</strong> Недвижимость, акции, земля, здания, другие активы<br>📋 <strong>Налоговая база:</strong> Сумма передачи - Стоимость приобретения - Необходимые расходы<br>📋 <strong>Налоговая ставка:</strong> 6%~45% в зависимости от налоговой базы (прогрессивная ставка)<br>📋 <strong>Срок подачи:</strong> 31 мая года, следующего за передачей<br><br>💡 <strong>Для точного расчета обратитесь к налоговому специалисту!</strong>',
                    ja: '💰 <strong>譲渡所得税基本情報</strong><br><br>📋 <strong>定義:</strong> 資産譲渡時に発生する所得に対する税金<br>📋 <strong>課税対象:</strong> 不動産、株式、土地、建物、その他資産の譲渡<br>📋 <strong>課税標準:</strong> 譲渡価額 - 取得価額 - 必要経費<br>📋 <strong>税率:</strong> 課税標準に応じて6%~45%（累進税率）<br>📋 <strong>申告期限:</strong> 譲渡日が属する年の翌年5月31日まで<br><br>💡 <strong>正確な計算は専門税理士にご相談ください！</strong>'
                };
                
                // 현재 언어를 사용하여 예약 텍스트 가져오기
                const currentLang = lang || this.currentLanguage;
                const reservationText = this.getReservationText();
                
                return content[currentLang] + `<br><br><div class="reservation-message">
                    <div class="reservation-message-text">${reservationText.message}</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                </div>`;
            }
            
            createTaxCalculationContent(lang) {
                const content = {
                    ko: '🧮 <strong>양도세 계산 방법</strong><br><br>📊 <strong>과세표준 계산:</strong><br>• 양도가액 - 취득가액 - 필요경비<br><br>📊 <strong>세율 적용:</strong><br>• 1,200만원 이하: 6%<br>• 1,200만원 초과 ~ 4,600만원: 15%<br>• 4,600만원 초과 ~ 8,800만원: 24%<br>• 8,800만원 초과 ~ 1.5억원: 35%<br>• 1.5억원 초과 ~ 3억원: 38%<br>• 3억원 초과 ~ 5억원: 40%<br>• 5억원 초과: 42%<br><br>💡 <strong>정확한 계산은 전문 세무사와 상담하세요!</strong>',
                    en: '🧮 <strong>Capital Gains Tax Calculation Method</strong><br><br>📊 <strong>Tax Base Calculation:</strong><br>• Transfer amount - Acquisition cost - Necessary expenses<br><br>📊 <strong>Tax Rate Application:</strong><br>• Up to 12 million KRW: 6%<br>• 12-46 million KRW: 15%<br>• 46-88 million KRW: 24%<br>• 88-150 million KRW: 35%<br>• 150-300 million KRW: 38%<br>• 300-500 million KRW: 40%<br>• Over 500 million KRW: 42%<br><br>💡 <strong>For accurate calculation, consult with a tax professional!</strong>',
                    ru: '🧮 <strong>Метод расчета налога на прирост капитала</strong><br><br>📊 <strong>Расчет налоговой базы:</strong><br>• Сумма передачи - Стоимость приобретения - Необходимые расходы<br><br>📊 <strong>Применение налоговой ставки:</strong><br>• До 12 млн вон: 6%<br>• 12-46 млн вон: 15%<br>• 46-88 млн вон: 24%<br>• 88-150 млн вон: 35%<br>• 150-300 млн вон: 38%<br>• 300-500 млн вон: 40%<br>• Свыше 500 млн вон: 42%<br><br>💡 <strong>Для точного расчета обратитесь к налоговому специалисту!</strong>',
                    ja: '🧮 <strong>譲渡税計算方法</strong><br><br>📊 <strong>課税標準計算:</strong><br>• 譲渡価額 - 取得価額 - 必要経費<br><br>📊 <strong>税率適用:</strong><br>• 1,200万円以下: 6%<br>• 1,200万円超～4,600万円: 15%<br>• 4,600万円超～8,800万円: 24%<br>• 8,800万円超～1.5億円: 35%<br>• 1.5億円超～3億円: 38%<br>• 3億円超～5億円: 40%<br>• 5億円超: 42%<br><br>💡 <strong>正確な計算は専門税理士にご相談ください！</strong>'
                };
                
                // 현재 언어를 사용하여 예약 텍스트 가져오기
                const currentLang = lang || this.currentLanguage;
                const reservationText = this.getReservationText();
                
                return content[currentLang] + `<br><br><div class="reservation-message">
                    <div class="reservation-message-text">${reservationText.message}</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                </div>`;
            }
            
            createTaxFilingContent(lang) {
                const content = {
                    ko: '📋 <strong>양도세 신고 방법</strong><br><br>📅 <strong>신고기한:</strong> 양도일이 속하는 연도의 다음 연도 5월 31일까지<br>📅 <strong>신고방법:</strong> 국세청 홈택스 또는 세무서 방문<br>📅 <strong>필요서류:</strong> 양도계약서, 취득증빙서류, 양도가액 증빙서류<br>📅 <strong>신고절차:</strong> 홈택스 접속 → 양도소득세 신고 → 서류 업로드 → 신고서 제출<br><br>💡 <strong>정확한 신고는 전문 세무사와 상담하세요!</strong>',
                    en: '📋 <strong>Capital Gains Tax Filing Method</strong><br><br>📅 <strong>Filing Deadline:</strong> May 31st of the year following the transfer<br>📅 <strong>Filing Method:</strong> National Tax Service HomeTax or visit tax office<br>📅 <strong>Required Documents:</strong> Transfer contract, acquisition documents, transfer amount documents<br>📅 <strong>Filing Procedure:</strong> Access HomeTax → File capital gains tax → Upload documents → Submit return<br><br>💡 <strong>For accurate filing, consult with a tax professional!</strong>',
                    ru: '📋 <strong>Метод подачи декларации по налогу на прирост капитала</strong><br><br>📅 <strong>Срок подачи:</strong> 31 мая года, следующего за передачей<br>📅 <strong>Способ подачи:</strong> Национальная налоговая служба HomeTax или посещение налоговой инспекции<br>📅 <strong>Необходимые документы:</strong> Договор передачи, документы о приобретении, документы о сумме передачи<br>📅 <strong>Процедура подачи:</strong> Доступ к HomeTax → Подача декларации по налогу → Загрузка документов → Подача декларации<br><br>💡 <strong>Для точной подачи обратитесь к налоговому специалисту!</strong>',
                    ja: '📞 <strong>フェニックス歯科予約</strong><br><br>🏥 <strong>病院名:</strong> フェニックス歯科<br>📞 <strong>電話番号:</strong> 070-1234-1234<br>💬 <strong>カカオトーク:</strong> フェニックス歯科<br>🌐 <strong>オンライン:</strong> ホーム페이지予約システム<br><br>💡 <strong>オンライン予約が最も便利です!</strong>'
                };
                
                // 현재 언어를 사용하여 예약 텍스트 가져오기
                const currentLang = lang || this.currentLanguage;
                const reservationText = this.getReservationText();
                
                return content[currentLang] + `<br><br><div class="reservation-message">
                    <div class="reservation-message-text">${reservationText.message}</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                </div>`;
            }
            
            createTaxExemptionContent(lang) {
                const content = {
                    ko: '✅ <strong>양도세 비과세 요건</strong><br><br>🏠 <strong>1세대 1주택 비과세:</strong> 조건 충족 시 최대 12억원까지 비과세<br>🏠 <strong>장기보유특별공제:</strong> 보유기간에 따라 공제율 적용<br>🏠 <strong>기본공제:</strong> 연간 250만원 기본공제<br>🏠 <strong>공제요건:</strong> 보유기간, 거주기간, 소유주택 수 등 확인 필요<br><br>💡 <strong>정확한 비과세 요건은 전문 세무사와 상담하세요!</strong>',
                    en: '✅ <strong>Capital Gains Tax Exemption Requirements</strong><br><br>🏠 <strong>1st Generation 1 House Exemption:</strong> Up to 1.2 billion KRW tax-free when conditions are met<br>🏠 <strong>Long-term Holding Special Deduction:</strong> Deduction rate applied based on holding period<br>🏠 <strong>Basic Deduction:</strong> 2.5 million KRW annual basic deduction<br>🏠 <strong>Deduction Requirements:</strong> Holding period, residence period, number of owned houses, etc. need to be verified<br><br>💡 <strong>For accurate exemption requirements, consult with a tax professional!</strong>',
                    ru: '✅ <strong>Требования к освобождению от налога на прирост капитала</strong><br><br>🏠 <strong>Освобождение 1 поколения 1 дома:</strong> До 1.2 млрд вон без налога при выполнении условий<br>🏠 <strong>Специальный вычет за долгосрочное владение:</strong> Ставка вычета применяется в зависимости от периода владения<br>🏠 <strong>Базовый вычет:</strong> 2.5 млн вон годовой базовый вычет<br>🏠 <strong>Требования к вычету:</strong> Период владения, период проживания, количество принадлежащих домов и т.д. необходимо проверить<br><br>💡 <strong>Для точных требований к освобождению обратитесь к налоговому специалисту!</strong>',
                                          ja: '✅ <strong>譲渡税非課税要件</strong><br><br>🏠 <strong>1世帯1住宅非課税:</strong> 条件充足時最大12億円まで非課税<br>🏠 <strong>長期保有特別控除:</strong> 保有期間に応じて控除率適用<br>🏠 <strong>基本控除:</strong> 年間250万円基本控除<br>🏠 <strong>控除要件:</strong> 保有期間、居住期間、所有住宅数など確認必要<br><br>💡 <strong>正確な非課税要件は専門税理士にご相談ください！</strong>'
                };
                
                // 현재 언어를 사용하여 예약 텍스트 가져오기
                const currentLang = lang || this.currentLanguage;
                const reservationText = this.getReservationText();
                
                return content[currentLang] + `<br><br><div class="reservation-message">
                    <div class="reservation-message-text">${reservationText.message}</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                </div>`;
            }
            

        }

        // 🎯 전역 챗봇 인스턴스 생성
        let chatbot;
        
        // 브라우저별 디버깅 도구 (전역 함수)
        window.debugBrowserApi = function() {
            if (window.chatbot) {
                console.log('🔧 브라우저별 디버깅 도구 실행');
                
                const userAgent = navigator.userAgent;
                const browserInfo = {
                    userAgent: userAgent,
                    isChrome: /Chrome/.test(userAgent) && !/Edge/.test(userAgent),
                    isEdge: /Edge/.test(userAgent),
                    isFirefox: /Firefox/.test(userAgent),
                    isSafari: /Safari/.test(userAgent) && !/Chrome/.test(userAgent),
                    isKakaoTalk: /KAKAO/.test(userAgent),
                    platform: navigator.platform,
                    language: navigator.language,
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine
                };
                
                console.log('🌐 브라우저 정보:', browserInfo);
                console.log('🔧 챗봇 설정:', window.chatbot.apiSettings);
                console.log('📊 API 상태:', window.chatbot.hasActiveAPI());
                
                // 로컬 스토리지 테스트
                try {
                    const testKey = 'browser_debug_test';
                    localStorage.setItem(testKey, 'test_value');
                    const testValue = localStorage.getItem(testKey);
                    localStorage.removeItem(testKey);
                    console.log('💾 로컬 스토리지 테스트:', testValue === 'test_value' ? '성공' : '실패');
                } catch (error) {
                    console.error('❌ 로컬 스토리지 테스트 실패:', error);
                }
                
                // API 연결 테스트 실행
                window.chatbot.testBrowserApiConnection().then(result => {
                    console.log('🧪 API 연결 테스트 결과:', result);
                }).catch(error => {
                    console.error('❌ API 연결 테스트 실패:', error);
                });
                
                return browserInfo;
            } else {
                console.error('❌ 챗봇 인스턴스를 찾을 수 없습니다.');
                return null;
            }
        };
        
        // 브라우저별 테스트 히스토리 확인
        window.showBrowserTestHistory = function() {
            try {
                const history = JSON.parse(localStorage.getItem('browserApiTestHistory') || '[]');
                console.log('📊 브라우저별 테스트 히스토리:', history);
                return history;
            } catch (error) {
                console.error('❌ 테스트 히스토리 로드 실패:', error);
                return [];
            }
        };
        
        // 브라우저별 캐시 클리어
        window.clearBrowserCache = function() {
            try {
                // 로컬 스토리지 클리어
                localStorage.clear();
                console.log('🗑️ 로컬 스토리지 클리어 완료');
                
                // 세션 스토리지 클리어
                sessionStorage.clear();
                console.log('🗑️ 세션 스토리지 클리어 완료');
                
                alert('브라우저 캐시가 클리어되었습니다. 페이지를 새로고침해주세요.');
                return true;
            } catch (error) {
                console.error('❌ 캐시 클리어 실패:', error);
                alert('캐시 클리어 중 오류가 발생했습니다.');
                return false;
            }
        };

        // 🎯 페이지 로드 시 초기화 (브라우저별 호환성 개선)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 피닉스 치과 AI 챗봇 페이지 로드');
            
            // 브라우저 정보 로깅
            const userAgent = navigator.userAgent;
            console.log('🌐 브라우저 정보:', {
                userAgent: userAgent.substring(0, 100),
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine
            });
            
            // 챗봇 인스턴스 생성 및 초기화
            chatbot = new TaxAgentChatbot();
            window.chatbot = chatbot; // 전역으로 설정
            
                    // 페이지 로드 후 자동으로 전역 설정 로드
        setTimeout(() => {
            autoLoadGlobalConfig();
        }, 1000);
        
        // API 상태 정보 표시
        function showApiStatusInfo() {
            const statusDiv = document.getElementById('apiStatus');
            const currentStatus = statusDiv.textContent;
            
            if (currentStatus.includes('❌')) {
                alert('🤖 n8n 엔진 설정이 필요합니다!\n\n' +
                      '1. 좌측 상단 설정 아이콘(⚙️) 클릭\n' +
                      '2. 로그인: tax004050 / tax004050\n' +
                      '3. "🌐 전역 설정 로드" 버튼 클릭\n' +
                      '4. "💾 API 설정 저장" 버튼 클릭\n\n' +
                      '또는 관리자가 환경변수를 설정했다면\n' +
                      '페이지를 새로고침해보세요!');
            } else if (currentStatus.includes('🟢')) {
                alert('✅ n8n 엔진이 정상적으로 설정되어 있습니다!\n\n' +
                      '양도세 관련 질문을 자유롭게 물어보세요!');
            } else {
                alert('🔄 n8n 엔진 상태를 확인 중입니다...\n\n' +
                      '잠시 후 다시 시도해보세요.');
            }
        }
        });

        // 🎯 전역 함수들 (기존 코드와의 호환성)
        function sendMessage() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            chatbot.addUserMessage(message);
            input.value = '';
            input.style.height = 'auto';
            
            chatbot.processMessage(message);
        }

        function toggleLanguageMenu() {
            if (chatbot) {
                chatbot.toggleLanguageMenu();
            } else {
                const menu = document.getElementById('languageMenu');
                if (menu) {
                    menu.classList.toggle('show');
                    console.log('전역 함수: 언어 메뉴 토글');
                }
            }
        }

        function selectLanguage(language) {
            if (chatbot) {
                chatbot.currentLanguage = language;
                chatbot.updateLanguageUI();
                
                const changeMessages = {
                    ko: '🇰🇷 한국어로 언어가 변경되었습니다!',
                    en: '🇺🇸 Language changed to English!',
                    ru: '🇷🇺 Язык изменен на русский!',
                    ja: '🇯🇵 言語が日本語に変更されました！'
                };
                
                chatbot.addBotMessage(changeMessages[language] || changeMessages['ko']);
                
                // 언어 변경 후 환영 메시지 다시 표시
                setTimeout(() => {
                    chatbot.addWelcomeMessage();
                }, 1000);
                
                chatbot.closeLanguageMenu();
            }
        }

        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function handleInputKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleBackNavigation(event) {
            // 뒤로가기 로직
            if (document.referrer) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }



        // 관리자 페이지 열기
        function openAdminPage(event) {
            event.preventDefault();
            console.log('Tax Agent 관리 페이지 로그인 시도');
            
            // 로그인 확인
            const username = prompt('관리자 아이디를 입력하세요:');
            const password = prompt('관리자 비밀번호를 입력하세요:');
            
            if (username === 'tax004050' && password === 'tax004050') {
                console.log('✅ 관리자 로그인 성공');
                document.getElementById('chatbotAdminPage').style.display = 'flex';
                
                // 기존 설정 로드
                loadAdminSettings();
            } else {
                console.log('❌ 관리자 로그인 실패');
                alert('❌ 로그인 실패! 아이디와 비밀번호를 확인해주세요.');
            }
        }

        // 페이지 로드 시 자동으로 전역 설정 로드
        async function autoLoadGlobalConfig() {
            try {
                console.log('🔄 자동 전역 설정 로드 시작');
                const response = await fetch('/.netlify/functions/chatbot-config');
                if (response.ok) {
                    const config = await response.json();
                    console.log('✅ 자동 전역 설정 로드 성공:', config);
                    
                    // API 설정에 적용
                    if (config.openai && config.openai.apiKey) {
                        const settings = {
                            openai: {
                                enabled: true,
                                apiKey: config.openai.apiKey,
                                model: config.openai.model || 'gpt-4o'
                            },
                            google: {
                                enabled: config.google && config.google.apiKey ? true : false,
                                apiKey: config.google ? config.google.apiKey : '',
                                model: config.google ? config.google.model : 'gemini-flash-2.5'
                            }
                        };
                        
                        // 로컬 스토리지에 저장
                        localStorage.setItem('chatbotApiSettings', JSON.stringify(settings));
                        
                        // 챗봇 인스턴스 업데이트
                        if (window.chatbot) {
                            window.chatbot.loadApiSettings();
                            window.chatbot.updateApiStatusDisplay();
                        }
                        
                        console.log('✅ 자동 API 설정 완료');
                        
                        // 사용자에게 알림 (첫 방문 시에만)
                        const hasShownAutoSetup = localStorage.getItem('hasShownAutoSetup');
                        if (!hasShownAutoSetup) {
                            setTimeout(() => {
                                alert('🎉 자동으로 n8n 엔진이 설정되었습니다!\n\n' +
                                      '이제 양도세 관련 질문을 자유롭게 물어보세요!\n\n' +
                                      '💡 우측 상단의 n8n 엔진 상태를 클릭하면\n' +
                                      '현재 설정 상태를 확인할 수 있습니다.');
                                localStorage.setItem('hasShownAutoSetup', 'true');
                            }, 2000);
                        }
                    }
                }
            } catch (error) {
                console.log('⚠️ 자동 전역 설정 로드 실패 (정상적인 상황):', error.message);
            }
        }

        // 관리자 페이지 닫기
        function closeChatbotAdmin() {
            console.log('Tax Agent 관리 페이지 닫기');
            document.getElementById('chatbotAdminPage').style.display = 'none';
        }

        // 관리자 페이지 API 상태 업데이트
        function updateAdminApiStatus() {
            const adminApiStatus = document.getElementById('adminApiStatus');
            if (adminApiStatus && window.chatbot) {
                adminApiStatus.innerHTML = window.chatbot.hasActiveAPI() ? '🟢 AI API 연결됨' : '🔴 AI API 설정 필요';
            }
        }

        // 전역 설정 관련 함수들
        // 전역 설정 로드
        async function loadGlobalConfig() {
            try {
                console.log('🌐 전역 설정 로드 시작');
                
                const statusDiv = document.getElementById('apiSettingsStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">🔄 전역 설정을 로드하고 있습니다...</div>';
                }
                
                const response = await fetch('/.netlify/functions/chatbot-config');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const config = await response.json();
                console.log('✅ 전역 설정 로드 성공:', config);
                
                // API 설정에 적용
                if (config.openai) {
                    const openaiApiKey = document.getElementById('openaiApiKey');
                    const openaiModel = document.getElementById('openaiModel');
                    if (openaiApiKey) openaiApiKey.value = config.openai.apiKey || '';
                    if (openaiModel) openaiModel.value = config.openai.model || 'gpt-4o';
                }
                
                if (config.google) {
                    const googleApiKey = document.getElementById('googleApiKey');
                    const googleModel = document.getElementById('googleModel');
                    if (googleApiKey) googleApiKey.value = config.google.apiKey || '';
                    if (googleModel) googleModel.value = config.google.model || 'gemini-flash-2.5';
                }
                
                // 성공 메시지 표시
                if (statusDiv) {
                    statusDiv.innerHTML = '<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">✅ 전역 설정이 로드되었습니다! 저장 버튼을 클릭하세요.</div>';
                }
                
                alert('✅ 전역 설정이 로드되었습니다!\n\n설정을 확인하고 "API 설정 저장" 버튼을 클릭하세요.');
                
            } catch (error) {
                console.error('❌ 전역 설정 로드 실패:', error);
                
                const statusDiv = document.getElementById('apiSettingsStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = '<div style="color: #721c24; padding: 10px; background: #f8d7da; border-radius: 5px; margin-top: 10px;">❌ 전역 설정 로드 실패: ' + error.message + '</div>';
                }
                
                alert('❌ 전역 설정 로드 실패!\n\n오류: ' + error.message + '\n\nNetlify 환경변수가 설정되었는지 확인해주세요.');
            }
        }

        // 설정 내보내기
        function exportSettings() {
            try {
                console.log('📤 설정 내보내기 시작');
                
                const settings = {
                    openai: {
                        apiKey: document.getElementById('openaiApiKey').value,
                        model: document.getElementById('openaiModel').value
                    },
                    google: {
                        apiKey: document.getElementById('googleApiKey').value,
                        model: document.getElementById('googleModel').value
                    },
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tax-agent-settings.json';
                a.click();
                URL.revokeObjectURL(url);
                
                console.log('✅ 설정 내보내기 완료');
                alert('✅ 설정이 "tax-agent-settings.json" 파일로 내보내졌습니다!');
                
            } catch (error) {
                console.error('❌ 설정 내보내기 실패:', error);
                alert('❌ 설정 내보내기 실패: ' + error.message);
            }
        }

        // 설정 가져오기
        function importSettings() {
            try {
                console.log('📥 설정 가져오기 시작');
                
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const settings = JSON.parse(e.target.result);
                            console.log('📥 가져온 설정:', settings);
                            
                            // API 설정에 적용
                            if (settings.openai) {
                                const openaiApiKey = document.getElementById('openaiApiKey');
                                const openaiModel = document.getElementById('openaiModel');
                                if (openaiApiKey) openaiApiKey.value = settings.openai.apiKey || '';
                                if (openaiModel) openaiModel.value = settings.openai.model || 'gpt-4o';
                            }
                            
                            if (settings.google) {
                                const googleApiKey = document.getElementById('googleApiKey');
                                const googleModel = document.getElementById('googleModel');
                                if (googleApiKey) googleApiKey.value = settings.google.apiKey || '';
                                if (googleModel) googleModel.value = settings.google.model || 'gemini-flash-2.5';
                            }
                            
                            console.log('✅ 설정 가져오기 완료');
                            alert('✅ 설정이 가져와졌습니다!\n\n"API 설정 저장" 버튼을 클릭하여 저장하세요.');
                            
                        } catch (error) {
                            console.error('❌ 설정 파일 파싱 실패:', error);
                            alert('❌ 설정 파일 형식이 올바르지 않습니다.\n\n올바른 JSON 파일인지 확인해주세요.');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
                
            } catch (error) {
                console.error('❌ 설정 가져오기 실패:', error);
                alert('❌ 설정 가져오기 실패: ' + error.message);
            }
        }

        // 관리자 페이지 이벤트 리스너 설정
        function setupAdminEventListeners() {
            console.log('🔧 관리자 페이지 이벤트 리스너 설정 시작');
            
            // API 설정 저장 버튼
            const saveApiBtn = document.getElementById('saveApiBtn');
            if (saveApiBtn) {
                saveApiBtn.addEventListener('click', function() {
                    try {
                        console.log('💾 API 설정 저장 시작');
                        
                        // 입력 필드에서 값 가져오기
                        const openaiApiKey = document.getElementById('openaiApiKey');
                        const openaiModel = document.getElementById('openaiModel');
                        const googleApiKey = document.getElementById('googleApiKey');
                        const googleModel = document.getElementById('googleModel');
                        
                        if (!openaiApiKey || !openaiModel || !googleApiKey || !googleModel) {
                            throw new Error('필수 입력 필드를 찾을 수 없습니다.');
                        }
                        
                        const settings = {
                            openai: {
                                enabled: openaiModel.value !== '',  // 모델이 선택되면 활성화
                                apiKey: openaiApiKey.value.trim(),
                                model: openaiModel.value
                            },
                            google: {
                                enabled: googleModel.value !== '',  // 모델이 선택되면 활성화
                                apiKey: googleApiKey.value.trim(),
                                model: googleModel.value
                            }
                        };
                        
                        localStorage.setItem('chatbotApiSettings', JSON.stringify(settings));
                        console.log('✅ API 설정 저장 완료:', settings);
                        
                        // 상태 메시지 업데이트
                        const statusDiv = document.getElementById('apiSettingsStatus');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">✅ API 설정이 저장되었습니다!</div>';
                        }
                        
                        // 챗봇 인스턴스 업데이트
                        if (window.chatbot) {
                            window.chatbot.loadApiSettings();
                            window.chatbot.updateApiStatusDisplay();
                            console.log('✅ 챗봇 API 설정 업데이트 완료');
                        }
                        
                        // 관리자 페이지 상태 업데이트
                        updateAdminApiStatus();
                        
                        // 성공 알림
                        alert('✅ API 설정이 성공적으로 저장되었습니다!');
                        
                    } catch (error) {
                        console.error('❌ API 설정 저장 실패:', error);
                        alert('❌ API 설정 저장에 실패했습니다: ' + error.message);
                    }
                });
                console.log('✅ API 설정 저장 버튼 이벤트 리스너 추가 완료');
            }

                    // API 연결 테스트 버튼
            const testApiBtn = document.getElementById('testApiBtn');
            if (testApiBtn) {
                testApiBtn.addEventListener('click', function() {
                    try {
                        console.log('🔗 API 연결 테스트 시작');
                        
                        const statusDiv = document.getElementById('apiSettingsStatus');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">🔄 API 연결을 테스트하고 있습니다...</div>';
                        }
                        
                        setTimeout(() => {
                            try {
                                const settings = JSON.parse(localStorage.getItem('chatbotApiSettings') || '{}');
                                let activeApis = [];
                                
                                                if (settings.openai?.enabled) activeApis.push('OpenAI');
                                if (settings.google?.enabled) activeApis.push('Google');
                                
                                console.log('🔍 활성화된 API:', activeApis);
                                
                                if (activeApis.length > 0) {
                                    const successMessage = `✅ 연결 성공! 활성화된 API: ${activeApis.join(', ')}`;
                                    if (statusDiv) {
                                        statusDiv.innerHTML = `<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">${successMessage}</div>`;
                                    }
                                    alert(successMessage);
                                    
                                    // 챗봇 인스턴스 업데이트
                                    if (window.chatbot) {
                                        window.chatbot.loadApiSettings();
                                        window.chatbot.updateApiStatusDisplay();
                                    }
                                    
                                    // 관리자 페이지 상태 업데이트
                                    updateAdminApiStatus();
                                } else {
                                    const errorMessage = '❌ 활성화된 API가 없습니다. API 키를 입력해주세요.';
                                    if (statusDiv) {
                                        statusDiv.innerHTML = `<div style="color: #721c24; padding: 10px; background: #f8d7da; border-radius: 5px; margin-top: 10px;">${errorMessage}</div>`;
                                    }
                                    alert(errorMessage);
                                }
                            } catch (error) {
                                console.error('❌ API 연결 테스트 중 오류:', error);
                                const errorMessage = '❌ API 연결 테스트 중 오류가 발생했습니다.';
                                if (statusDiv) {
                                    statusDiv.innerHTML = `<div style="color: #721c24; padding: 10px; background: #f8d7da; border-radius: 5px; margin-top: 10px;">${errorMessage}</div>`;
                                }
                                alert(errorMessage);
                            }
                        }, 1000);
                        
                    } catch (error) {
                        console.error('❌ API 연결 테스트 실패:', error);
                        alert('❌ API 연결 테스트에 실패했습니다. 다시 시도해주세요.');
                    }
                });
                console.log('✅ API 연결 테스트 버튼 이벤트 리스너 추가 완료');
            }

            // API 설정 초기화 버튼
            const clearApiBtn = document.getElementById('clearApiBtn');
            if (clearApiBtn) {
                clearApiBtn.addEventListener('click', function() {
                    try {
                        if (confirm('정말로 모든 API 설정을 초기화하시겠습니까?')) {
                            console.log('🔄 API 설정 초기화 시작');
                            
                            // 입력 필드 초기화
                            const fields = [
                                'openaiApiKey', 'openaiModel',
                                'googleApiKey', 'googleModel'
                            ];
                            
                            fields.forEach(fieldId => {
                                const element = document.getElementById(fieldId);
                                if (element) {
                                    element.value = '';
                                }
                            });
                            
                            // 로컬 스토리지에서 설정 제거
                            localStorage.removeItem('chatbotApiSettings');
                            console.log('✅ API 설정 초기화 완료');
                            
                            // 상태 메시지 업데이트
                            const statusDiv = document.getElementById('apiSettingsStatus');
                            if (statusDiv) {
                                statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">🔄 API 설정이 초기화되었습니다.</div>';
                            }
                            
                            // 챗봇 인스턴스 업데이트
                            if (window.chatbot) {
                                window.chatbot.loadApiSettings();
                                window.chatbot.updateApiStatusDisplay();
                                console.log('✅ 챗봇 API 설정 초기화 완료');
                            }
                            
                            // 관리자 페이지 상태 업데이트
                            updateAdminApiStatus();
                            
                            alert('✅ API 설정이 성공적으로 초기화되었습니다!');
                        }
                    } catch (error) {
                        console.error('❌ API 설정 초기화 실패:', error);
                        alert('❌ API 설정 초기화에 실패했습니다. 다시 시도해주세요.');
                    }
                });
                console.log('✅ API 설정 초기화 버튼 이벤트 리스너 추가 완료');
            }

            // 전역 설정 로드 버튼
            const loadGlobalConfigBtn = document.getElementById('loadGlobalConfigBtn');
            if (loadGlobalConfigBtn) {
                loadGlobalConfigBtn.addEventListener('click', loadGlobalConfig);
                console.log('✅ 전역 설정 로드 버튼 이벤트 리스너 추가 완료');
            }

            // 설정 내보내기 버튼
            const exportSettingsBtn = document.getElementById('exportSettingsBtn');
            if (exportSettingsBtn) {
                exportSettingsBtn.addEventListener('click', exportSettings);
                console.log('✅ 설정 내보내기 버튼 이벤트 리스너 추가 완료');
            }

            // 설정 가져오기 버튼
            const importSettingsBtn = document.getElementById('importSettingsBtn');
            if (importSettingsBtn) {
                importSettingsBtn.addEventListener('click', importSettings);
                console.log('✅ 설정 가져오기 버튼 이벤트 리스너 추가 완료');
            }



            // 파일 업로드 이벤트
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(event) {
                    const files = event.target.files;
                    processUploadedFiles(files);
                });
                console.log('✅ 파일 업로드 이벤트 리스너 추가 완료');
            }

            // 파일 드래그 앤 드롭 이벤트
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                // 클릭 이벤트
                uploadArea.addEventListener('click', function() {
                    document.getElementById('fileInput').click();
                });
                
                // 드래그 오버 이벤트
                uploadArea.addEventListener('dragover', function(event) {
                    event.preventDefault();
                    this.style.borderColor = '#4facfe';
                });
                
                // 드래그 리브 이벤트
                uploadArea.addEventListener('dragleave', function(event) {
                    event.preventDefault();
                    this.style.borderColor = '#ddd';
                });
                
                // 드롭 이벤트
                uploadArea.addEventListener('drop', function(event) {
                    event.preventDefault();
                    this.style.borderColor = '#ddd';
                    
                    const files = event.dataTransfer.files;
                    processUploadedFiles(files);
                });
                console.log('✅ 파일 드래그 앤 드롭 이벤트 리스너 추가 완료');
            }

            // 파일 업로드 처리 함수들
            function processUploadedFiles(files) {
                console.log('파일 업로드 처리 시작:', files.length, '개');
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    console.log('파일 처리 중:', file.name, file.type, file.size);
                    
                    const fileData = {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploadTime: new Date(),
                        content: ''
                    };
                    
                    // 파일 확장자 확인
                    const fileExtension = file.name.toLowerCase().split('.').pop();
                    
                    // PDF 파일 경고
                    if (fileExtension === 'pdf' || file.type === 'application/pdf') {
                        console.warn('PDF 파일 감지:', file.name);
                        alert('❌ PDF 파일은 현재 지원되지 않습니다.\nPDF 내용을 텍스트 파일(.txt)로 복사해서 업로드해주세요.');
                        continue;
                    }
                    
                    // 지원되는 파일 형식 처리
                    if (fileExtension === 'txt' || file.type === 'text/plain' || file.type === '') {
                        // 텍스트 파일 처리
                        processTextFile(file, fileData);

                    } else if (fileExtension === 'jsonl' || file.type === 'application/jsonl' || file.type === 'text/plain') {
                        // JSONL 파일 처리
                        processJsonlFile(file, fileData);
                    } else {
                        // 지원되지 않는 파일 형식
                        console.warn('지원되지 않는 파일 형식:', file.name, file.type);
                        alert(`❌ 지원되지 않는 파일 형식입니다: ${file.name}\n\n📁 현재 지원되는 파일 형식:\n• 텍스트 파일 (.txt)\n• JSONL 파일 (.jsonl)`);
                    }
                }
            }

            // 텍스트 파일 처리
            function processTextFile(file, fileData) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        fileData.content = content;
                        processKnowledgeFile(fileData.name, content);
                    } catch (error) {
                        console.error('텍스트 파일 처리 오류:', error);
                        alert(`❌ 텍스트 파일 처리 실패: ${file.name}`);
                    }
                };
                reader.onerror = function() {
                    console.error('텍스트 파일 읽기 오류');
                    alert(`❌ 텍스트 파일 읽기 실패: ${file.name}`);
                };
                reader.readAsText(file, 'UTF-8');
            }



            // JSONL 파일 처리
            function processJsonlFile(file, fileData) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        fileData.content = content;
                        processJsonlContent(fileData.name, content);
                    } catch (error) {
                        console.error('JSONL 파일 처리 오류:', error);
                        alert(`❌ JSONL 파일 처리 실패: ${file.name}`);
                    }
                };
                reader.onerror = function() {
                    console.error('JSONL 파일 읽기 오류');
                    alert(`❌ JSONL 파일 읽기 실패: ${file.name}`);
                };
                reader.readAsText(file, 'UTF-8');
            }

            // JSONL 내용 처리
            function processJsonlContent(filename, content) {
                const lines = content.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);
                const qaList = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    try {
                        const jsonData = JSON.parse(line);
                        
                        let question = '';
                        let answer = '';
                        
                        if (jsonData.question && jsonData.answer) {
                            question = jsonData.question;
                            answer = jsonData.answer;
                        } else if (jsonData.q && jsonData.a) {
                            question = jsonData.q;
                            answer = jsonData.a;
                        } else if (jsonData.질문 && jsonData.답변) {
                            question = jsonData.질문;
                            answer = jsonData.답변;
                        } else if (jsonData.text && jsonData.response) {
                            question = jsonData.text;
                            answer = jsonData.response;
                        } else if (jsonData.prompt && jsonData.completion) {
                            question = jsonData.prompt;
                            answer = jsonData.completion;
                        } else if (jsonData.input && jsonData.output) {
                            question = jsonData.input;
                            answer = jsonData.output;
                        }
                        
                        if (question && answer && question.length > 2 && answer.length > 3) {
                            qaList.push({ question: question, answer: answer });
                        }
                        
                    } catch (error) {
                        console.warn(`JSONL 라인 ${i + 1} 파싱 실패:`, error);
                        continue;
                    }
                }
                
                if (qaList.length > 0) {
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    knowledgeData.parsedData = knowledgeData.parsedData.concat(qaList);
                    localStorage.setItem('chatbotKnowledgeBase', JSON.stringify(knowledgeData));
                    
                    // 파일 목록에 추가
                    const fileList = document.getElementById('fileList');
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-item';
                    fileDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                            <div>
                                <strong>📄 ${filename}</strong>
                                <div style="font-size: 12px; color: #666;">크기: ${(content.length / 1024).toFixed(2)} KB | Q&A: ${qaList.length}개</div>
                            </div>
                            <button onclick="this.parentElement.remove(); updateKnowledgeStatus();" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">삭제</button>
                        </div>
                    `;
                    fileList.appendChild(fileDiv);
                }
                
                updateKnowledgeStatus();
            }

            // 지식 파일 처리 함수
            function processKnowledgeFile(filename, content) {
                const fileList = document.getElementById('fileList');
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-item';
                fileDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                        <div>
                            <strong>📄 ${filename}</strong>
                            <div style="font-size: 12px; color: #666;">크기: ${(content.length / 1024).toFixed(2)} KB</div>
                        </div>
                        <button onclick="this.parentElement.remove(); updateKnowledgeStatus();" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">삭제</button>
                    </div>
                `;
                fileList.appendChild(fileDiv);
                
                // Q&A 파싱
                const qaList = parseQAFromContent(content);
                if (qaList.length > 0) {
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    knowledgeData.parsedData = knowledgeData.parsedData.concat(qaList);
                    localStorage.setItem('chatbotKnowledgeBase', JSON.stringify(knowledgeData));
                }
                
                updateKnowledgeStatus();
            }

            // Q&A 파싱 함수
            function parseQAFromContent(content) {
                const lines = content.split('\n');
                const qaList = [];
                let currentQ = '';
                let currentA = '';
                
                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('Q:') || line.startsWith('Q.') || line.startsWith('질문:')) {
                        if (currentQ && currentA) {
                            qaList.push({ question: currentQ, answer: currentA });
                        }
                        currentQ = line.replace(/^Q[:.]\s*|^질문:\s*/, '');
                        currentA = '';
                    } else if (line.startsWith('A:') || line.startsWith('A.') || line.startsWith('답변:')) {
                        currentA = line.replace(/^A[:.]\s*|^답변:\s*/, '');
                    } else if (currentA) {
                        currentA += ' ' + line;
                    } else if (currentQ) {
                        currentQ += ' ' + line;
                    }
                }
                
                if (currentQ && currentA) {
                    qaList.push({ question: currentQ, answer: currentA });
                }
                
                return qaList;
            }

            // 지식 상태 업데이트 함수
            function updateKnowledgeStatus() {
                const fileItems = document.querySelectorAll('.file-item');
                const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                
                const statusDiv = document.getElementById('knowledgeStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = `📖 업로드된 지식 파일: ${fileItems.length}개 | 파싱된 Q&A: ${knowledgeData.parsedData.length}개 | 상태: ${knowledgeData.enabled ? '활성' : '비활성'}`;
                }
            }

            // 지식 설정 저장 버튼
            const saveKnowledgeBtn = document.getElementById('saveKnowledgeBtn');
            if (saveKnowledgeBtn) {
                saveKnowledgeBtn.addEventListener('click', function() {
                    const fileItems = document.querySelectorAll('.file-item');
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    
                    knowledgeData.enabled = fileItems.length > 0;
                    knowledgeData.files = Array.from(fileItems).map(item => item.querySelector('strong').textContent.replace('📄 ', ''));
                    
                    localStorage.setItem('chatbotKnowledgeBase', JSON.stringify(knowledgeData));
                    
                    const statusDiv = document.getElementById('knowledgeSettingsStatus');
                    if (statusDiv) {
                        statusDiv.innerHTML = '<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">✅ 지식 설정이 저장되었습니다!</div>';
                    }
                    
                    if (window.chatbot) {
                        window.chatbot.loadKnowledgeBaseSettings();
                    }
                    
                    alert('✅ 지식 설정이 성공적으로 저장되었습니다!');
                });
                console.log('✅ 지식 설정 저장 버튼 이벤트 리스너 추가 완료');
            }

            // 지식 검색 테스트 버튼
            const testKnowledgeBtn = document.getElementById('testKnowledgeBtn');
            if (testKnowledgeBtn) {
                testKnowledgeBtn.addEventListener('click', function() {
                    const testQuery = prompt('검색할 질문을 입력하세요:');
                    if (!testQuery) return;
                    
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    
                    if (!knowledgeData.enabled || knowledgeData.parsedData.length === 0) {
                        alert('활성화된 지식베이스가 없습니다.');
                        return;
                    }
                    
                    const result = searchInKnowledgeBase(testQuery, knowledgeData.parsedData);
                    if (result) {
                        alert(`검색 결과:\n\nQ: ${result.question}\n\nA: ${result.answer}`);
                    } else {
                        alert('관련 답변을 찾을 수 없습니다.');
                    }
                });
                console.log('✅ 지식 검색 테스트 버튼 이벤트 리스너 추가 완료');
            }

            // 지식베이스 검색 함수
            function searchInKnowledgeBase(query, parsedData) {
                const normalizedQuery = query.toLowerCase().trim();
                let bestMatch = null;
                let bestScore = 0;
                
                for (const qa of parsedData) {
                    const question = qa.question.toLowerCase();
                    const answer = qa.answer.toLowerCase();
                    
                    let score = 0;
                    
                    if (question === normalizedQuery) score += 1000;
                    if (question.includes(normalizedQuery) || normalizedQuery.includes(question)) score += 500;
                    
                    const queryWords = normalizedQuery.split(/\s+/).filter(w => w.length > 1);
                    for (const word of queryWords) {
                        if (question.includes(word)) score += 100;
                        if (answer.includes(word)) score += 50;
                    }
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = qa;
                    }
                }
                
                return bestScore >= 50 ? bestMatch : null;
            }

            // 파싱된 데이터 보기 버튼
            const showParsedDataBtn = document.getElementById('showParsedDataBtn');
            if (showParsedDataBtn) {
                showParsedDataBtn.addEventListener('click', function() {
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    const viewDiv = document.getElementById('parsedDataView');
                    const contentDiv = document.getElementById('parsedDataContent');
                    
                    if (viewDiv && contentDiv) {
                        if (knowledgeData.parsedData.length === 0) {
                            contentDiv.innerHTML = '<p style="color: #666;">파싱된 Q&A 데이터가 없습니다.</p>';
                        } else {
                            let html = '';
                            knowledgeData.parsedData.forEach((qa, index) => {
                                html += `
                                    <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">Q${index + 1}: ${qa.question}</div>
                                        <div style="color: #666;">A: ${qa.answer}</div>
                                    </div>
                                `;
                            });
                            contentDiv.innerHTML = html;
                        }
                        
                        viewDiv.style.display = viewDiv.style.display === 'none' ? 'block' : 'none';
                    }
                });
                console.log('✅ 파싱된 데이터 보기 버튼 이벤트 리스너 추가 완료');
            }

            // 모든 지식 삭제 버튼
            const clearKnowledgeBtn = document.getElementById('clearKnowledgeBtn');
            if (clearKnowledgeBtn) {
                clearKnowledgeBtn.addEventListener('click', function() {
                    if (confirm('정말로 모든 지식 데이터를 삭제하시겠습니까?')) {
                        const fileList = document.getElementById('fileList');
                        if (fileList) {
                            fileList.innerHTML = '';
                        }
                        localStorage.removeItem('chatbotKnowledgeBase');
                        updateKnowledgeStatus();
                        
                        const statusDiv = document.getElementById('knowledgeSettingsStatus');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">🔄 모든 지식 데이터가 삭제되었습니다.</div>';
                        }
                        
                        if (window.chatbot) {
                            window.chatbot.loadKnowledgeBaseSettings();
                        }
                        
                        alert('✅ 모든 지식 데이터가 성공적으로 삭제되었습니다!');
                    }
                });
                console.log('✅ 모든 지식 삭제 버튼 이벤트 리스너 추가 완료');
            }

            // 대화 이력 관리 이벤트 리스너들
            // 대화 이력 보기 버튼
            const viewChatHistoryBtn = document.getElementById('viewChatHistoryBtn');
            if (viewChatHistoryBtn) {
                viewChatHistoryBtn.addEventListener('click', function() {
                    const viewDiv = document.getElementById('chatHistoryView');
                    const contentDiv = document.getElementById('chatHistoryContent');
                    
                    if (viewDiv && contentDiv && window.chatbot) {
                        const history = window.chatbot.chatHistory;
                        
                        if (history.length === 0) {
                            contentDiv.innerHTML = '<p style="color: #666;">현재 대화 이력이 없습니다.</p>';
                        } else {
                            let html = '';
                            history.forEach((msg, index) => {
                                const role = msg.role === 'user' ? '👤 사용자' : '👩‍⚕️ AI 상담사';
                                const time = new Date(msg.timestamp).toLocaleString();
                                html += `
                                    <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; background: ${msg.role === 'user' ? '#f8f9fa' : '#e3f2fd'}">
                                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
                                            ${role} (${time})
                                        </div>
                                        <div style="color: #666; word-break: break-word;">${msg.content}</div>
                                    </div>
                                `;
                            });
                            contentDiv.innerHTML = html;
                        }
                        
                        viewDiv.style.display = viewDiv.style.display === 'none' ? 'block' : 'none';
                    }
                });
                console.log('✅ 대화 이력 보기 버튼 이벤트 리스너 추가 완료');
            }

            // 대화 이력 설정 저장 버튼
            const saveHistorySettingsBtn = document.getElementById('saveHistorySettingsBtn');
            if (saveHistorySettingsBtn) {
                saveHistorySettingsBtn.addEventListener('click', function() {
                    const maxHistory = document.getElementById('maxHistorySelect').value;
                    const maxTokens = document.getElementById('maxTokensSelect').value;
                    
                    if (window.chatbot) {
                        window.chatbot.MAX_HISTORY = parseInt(maxHistory);
                        window.chatbot.MAX_TOKENS = parseInt(maxTokens);
                        
                        // 설정을 로컬 스토리지에 저장
                        localStorage.setItem('chatbotHistorySettings', JSON.stringify({
                            maxHistory: parseInt(maxHistory),
                            maxTokens: parseInt(maxTokens)
                        }));
                        
                        updateChatHistoryStatus();
                        
                        const statusDiv = document.getElementById('chatHistorySettingsStatus');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">✅ 대화 이력 설정이 저장되었습니다!</div>';
                        }
                        
                        alert('✅ 대화 이력 설정이 성공적으로 저장되었습니다!');
                    }
                });
                console.log('✅ 대화 이력 설정 저장 버튼 이벤트 리스너 추가 완료');
            }

            // 대화 이력 초기화 버튼
            const clearChatHistoryBtn = document.getElementById('clearChatHistoryBtn');
            if (clearChatHistoryBtn) {
                clearChatHistoryBtn.addEventListener('click', function() {
                    if (confirm('정말로 모든 대화 이력을 초기화하시겠습니까?')) {
                        if (window.chatbot) {
                            window.chatbot.clearChatHistory();
                            updateChatHistoryStatus();
                            
                            const statusDiv = document.getElementById('chatHistorySettingsStatus');
                            if (statusDiv) {
                                statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">🔄 대화 이력이 초기화되었습니다.</div>';
                            }
                            
                            alert('✅ 대화 이력이 성공적으로 초기화되었습니다!');
                        }
                    }
                });
                console.log('✅ 대화 이력 초기화 버튼 이벤트 리스너 추가 완료');
            }

            // 대화 이력 내보내기 버튼
            const exportChatHistoryBtn = document.getElementById('exportChatHistoryBtn');
            if (exportChatHistoryBtn) {
                exportChatHistoryBtn.addEventListener('click', function() {
                    if (window.chatbot && window.chatbot.chatHistory.length > 0) {
                        const history = window.chatbot.chatHistory;
                        let exportText = '=== 피닉스 치과 AI 챗봇 대화 이력 ===\n\n';
                        
                        history.forEach((msg, index) => {
                            const role = msg.role === 'user' ? '사용자' : 'AI 상담사';
                            const time = new Date(msg.timestamp).toLocaleString();
                            exportText += `[${index + 1}] ${role} (${time})\n`;
                            exportText += `${msg.content}\n\n`;
                        });
                        
                        // 파일 다운로드
                        const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `chatbot_history_${new Date().toISOString().slice(0, 10)}.txt`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        alert('✅ 대화 이력이 성공적으로 내보내기되었습니다!');
                    } else {
                        alert('내보낼 대화 이력이 없습니다.');
                    }
                });
                console.log('✅ 대화 이력 내보내기 버튼 이벤트 리스너 추가 완료');
            }

            // 대화 이력 상태 업데이트 함수
            function updateChatHistoryStatus() {
                const statusDiv = document.getElementById('chatHistoryStatus');
                if (statusDiv && window.chatbot) {
                    const historyCount = window.chatbot.chatHistory.length;
                    const maxHistory = window.chatbot.MAX_HISTORY;
                    statusDiv.innerHTML = `💬 현재 대화 이력: ${historyCount}개 메시지 | 최대 저장: ${maxHistory}개 메시지`;
                }
            }
            
            console.log('✅ 관리자 페이지 이벤트 리스너 설정 완료');
        }

        // 관리자 설정 로드 함수
        function loadAdminSettings() {
            try {
                console.log('📋 관리자 페이지 설정 로드 시작');
                
                // 기존 설정 로드
                const apiSettings = JSON.parse(localStorage.getItem('chatbotApiSettings') || '{}');
                
                // OpenAI 설정 로드
                const openaiApiKey = document.getElementById('openaiApiKey');
                const openaiModel = document.getElementById('openaiModel');
                
                if (openaiApiKey) openaiApiKey.value = apiSettings.openai?.apiKey || '';
                if (openaiModel) openaiModel.value = apiSettings.openai?.model || 'gpt-4o';  // 기본값 설정
                
                // Google API 설정 로드
                if (apiSettings.google) {
                    const googleApiKey = document.getElementById('googleApiKey');
                    const googleModel = document.getElementById('googleModel');
                    
                    if (googleApiKey) googleApiKey.value = apiSettings.google.apiKey || '';
                    if (googleModel) googleModel.value = apiSettings.google.model || '';
                }
                
                // 대화 이력 설정 로드
                const historySettings = JSON.parse(localStorage.getItem('chatbotHistorySettings') || '{}');
                const maxHistorySelect = document.getElementById('maxHistorySelect');
                const maxTokensSelect = document.getElementById('maxTokensSelect');
                
                if (maxHistorySelect && historySettings.maxHistory) {
                    maxHistorySelect.value = historySettings.maxHistory;
                }
                if (maxTokensSelect && historySettings.maxTokens) {
                    maxTokensSelect.value = historySettings.maxTokens;
                }
                
                // 챗봇 인스턴스에 설정 적용
                if (window.chatbot && historySettings.maxHistory) {
                    window.chatbot.MAX_HISTORY = historySettings.maxHistory;
                }
                if (window.chatbot && historySettings.maxTokens) {
                    window.chatbot.MAX_TOKENS = historySettings.maxTokens;
                }
                
                if (window.updateKnowledgeStatus) {
                    window.updateKnowledgeStatus();
                }
                if (window.updateChatHistoryStatus) {
                    window.updateChatHistoryStatus();
                }
                console.log('✅ 관리자 페이지 설정 로드 완료');
                
            } catch (error) {
                console.error('❌ 관리자 페이지 설정 로드 실패:', error);
            }
        }

        console.log('✅ Tax Agent 양도세 챗봇 초기화 완료 (최적화 버전)');
    </script>

    <!-- AI 챗봇 관리 페이지 -->
    <div class="popup-page" id="chatbotAdminPage" style="display: none;">
        <div class="admin-header">
            <div class="admin-title">⚙️ Tax Agent 관리 시스템</div>
            <div class="admin-nav">
                <button class="nav-btn" onclick="closeChatbotAdmin()">💰 Tax Agent로 돌아가기</button>
            </div>
        </div>
        
        <div class="admin-content">
            <!-- 답변 우선순위 정보 -->
            <div class="admin-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="section-header">
                    <h3>🎯 Tax Agent 답변 우선순위</h3>
                </div>
                <div style="padding: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 15px;">
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 15px; text-align: center;">
                        양도세 질문 답변 처리 순서
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">1차</div>
                            <div>💰 양도세 기본 정보</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">2차</div>
                            <div>📚 지식베이스 검색</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">3차</div>
                            <div>❓ 기본 FAQ 답변</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">4차</div>
                            <div>🤖 AI API 호출</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">5차</div>
                            <div>🎭 시뮬레이션 답변</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; text-align: center; font-size: 13px;">
                        <span id="adminApiStatus">
                            ${this.hasActiveAPI() ? '🟢 AI API 연결됨' : '🔴 AI API 설정 필요'}
                        </span>
                    </div>
                </div>
            </div>

            <!-- AI 모델 API 설정 -->
            <div class="admin-section">
                <div class="section-header">
                    <h3>🤖 Tax Agent AI 모델 연결하기</h3>
                </div>
                
                <div class="api-form">
                    <!-- OpenAI 설정 -->
                    <div class="form-group">
                        <label for="openaiApiKey">OpenAI API Key</label>
                        <input type="password" id="openaiApiKey" placeholder="sk-proj-...">
                    </div>
                    <div class="form-group">
                        <label for="openaiModel">OpenAI 모델선택</label>
                        <select id="openaiModel">
                            <option value="">-- OpenAI 모델을 선택하세요 --</option>
                            <option value="gpt-4o" selected>GPT-4o (최신 멀티모달)</option>
                            <option value="gpt-4o-mini">GPT-4o Mini (경제적)</option>
                        </select>
                    </div>

                    <!-- Google API 설정 -->
                    <div class="form-group" style="margin-top: 25px;">
                        <label for="googleApiKey">Google API Key</label>
                        <input type="password" id="googleApiKey" placeholder="AIza...">
                    </div>
                    <div class="form-group">
                        <label for="googleModel">Google 모델선택</label>
                        <select id="googleModel">
                            <option value="">-- Google 모델을 선택하세요 --</option>
                            <option value="gemini-flash-2.5">Gemini Flash 2.5 (빠른 응답)</option>
                            <option value="gemini-pro-2.5">Gemini Pro 2.5 (고성능)</option>
                        </select>
                    </div>

                    <!-- API 설정 저장 버튼 -->
                    <div class="btn-group" style="margin-top: 30px;">
                        <button class="btn btn-success" id="saveApiBtn">💾 API 설정 저장</button>
                        <button class="btn btn-primary" id="testApiBtn">🔍 API 연결 테스트</button>
                        <button class="btn btn-danger" id="clearApiBtn">🗑️ API 설정 초기화</button>
                    </div>
                    
                    <!-- 전역 설정 관리 -->
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-info" id="loadGlobalConfigBtn">🌐 전역 설정 로드</button>
                        <button class="btn btn-info" id="exportSettingsBtn">📤 설정 내보내기</button>
                        <button class="btn btn-info" id="importSettingsBtn">📥 설정 가져오기</button>
                    </div>
                    
                    <div id="apiSettingsStatus" class="status-message"></div>



                </div>
            </div>

            <!-- AI 지식 파일 업로드 -->
            <div class="admin-section">
                <div class="section-header">
                    <h3>📚 AI 지식 파일 업로드</h3>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">클릭하거나 파일을 여기로 드래그하세요</div>
                    <div class="upload-types">💡 <strong>지원 형식: 텍스트(.txt), JSONL(.jsonl)</strong><br>
                    <small style="color: #666;">※ 지원 형식: .txt, .jsonl | PDF는 텍스트로 변환 후 업로드해주세요</small></div>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".txt,.jsonl" multiple>
                
                <div class="file-list" id="fileList">
                    <!-- 업로드된 파일들이 여기에 표시됩니다 -->
                </div>
                
                <div id="knowledgeStatus" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 14px;">
                    📖 업로드된 지식 파일: 0개 | 상태: 비활성
                </div>
                
                <!-- 지식 파일 설정 저장 버튼 -->
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-success" id="saveKnowledgeBtn">💾 지식 파일 설정 저장</button>
                    <button class="btn btn-primary" id="testKnowledgeBtn">🔍 지식 검색 테스트</button>
                    <button class="btn" style="background: #17a2b8; color: white;" id="showParsedDataBtn">📋 파싱된 Q&A 보기</button>
                    <button class="btn btn-danger" id="clearKnowledgeBtn">🗑️ 모든 지식 삭제</button>
                </div>
                <div id="knowledgeSettingsStatus" class="status-message"></div>
                
                <!-- 파싱된 Q&A 표시 영역 -->
                <div id="parsedDataView" style="display: none; margin-top: 20px; background: white; border-radius: 10px; padding: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">📋 파싱된 Q&A 데이터</h4>
                    <div id="parsedDataContent"></div>
                </div>
            </div>

            <!-- 대화 이력 관리 -->
            <div class="admin-section">
                <div class="section-header">
                    <h3>💬 대화 이력 관리</h3>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">📊 대화 이력 현황</h4>
                        <div id="chatHistoryStatus" style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #4facfe;">
                            💬 현재 대화 이력: 0개 메시지 | 최대 저장: 20개 메시지
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">⚙️ 대화 이력 설정</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <label style="font-weight: bold; display: block; margin-bottom: 5px;">최대 대화 이력 개수</label>
                                <select id="maxHistorySelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="10">10개</option>
                                    <option value="20" selected>20개</option>
                                    <option value="30">30개</option>
                                    <option value="50">50개</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight: bold; display: block; margin-bottom: 5px;">API 호출 최대 토큰</label>
                                <select id="maxTokensSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="1000">1,000 토큰</option>
                                    <option value="1500" selected>1,500 토큰</option>
                                    <option value="2000">2,000 토큰</option>
                                    <option value="3000">3,000 토큰</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 대화 이력 관리 버튼 -->
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" id="viewChatHistoryBtn">👁️ 대화 이력 보기</button>
                        <button class="btn btn-success" id="saveHistorySettingsBtn">💾 설정 저장</button>
                        <button class="btn btn-warning" id="clearChatHistoryBtn">🗑️ 대화 이력 초기화</button>
                        <button class="btn" style="background: #17a2b8; color: white;" id="exportChatHistoryBtn">📤 대화 이력 내보내기</button>
                    </div>
                    <div id="chatHistorySettingsStatus" class="status-message"></div>
                    
                    <!-- 대화 이력 표시 영역 -->
                    <div id="chatHistoryView" style="display: none; margin-top: 20px; background: white; border-radius: 10px; padding: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd;">
                        <h4 style="margin-bottom: 15px; color: #2c3e50;">💬 현재 대화 이력</h4>
                        <div id="chatHistoryContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* 관리자 페이지 스타일 */
        .popup-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .admin-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .admin-title {
            font-size: 24px;
            font-weight: bold;
            flex: 1;
            min-width: 200px;
        }

        .admin-login-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 250px;
        }

        .admin-nav {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: #2980b9;
        }

        .nav-btn.logout {
            background: #e74c3c;
        }

        .nav-btn.logout:hover {
            background: #c0392b;
        }

        .admin-content {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
            max-height: 80vh;
            overflow-y: auto;
        }

        .admin-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 20px;
        }

        /* API 설정 스타일 */
        .api-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .btn-primary {
            background: #4facfe;
            color: white;
        }

        .btn-primary:hover {
            background: #3d8bfe;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        /* 파일 업로드 스타일 */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .upload-types {
            font-size: 14px;
            color: #666;
        }

        .file-input {
            display: none;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            margin-bottom: 10px;
        }

        .status-message {
            margin-top: 15px;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .admin-title {
                font-size: 20px;
                min-width: auto;
            }
            
            .admin-login-info {
                min-width: auto;
                width: 100%;
                max-width: 300px;
                margin: 0 auto;
            }
            
            .admin-nav {
                width: 100%;
                justify-content: center;
            }
            
            .admin-content {
                padding: 15px;
                max-height: 90vh;
            }
            
            .admin-section {
                padding: 15px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .upload-area {
                padding: 20px;
            }
            
            .upload-icon {
                font-size: 36px;
            }
            
            .upload-text {
                font-size: 16px;
            }
        }
    </style>
</body>
</html>