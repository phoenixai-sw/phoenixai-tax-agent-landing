<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tax-Agent</title>
    
    <!-- ìºì‹œ ë°©ì§€ ë° ëª¨ë°”ì¼ ìµœì í™” ë©”íƒ€ íƒœê·¸ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="address=no">
    <meta name="format-detection" content="email=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4facfe">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --vh: 1vh;
            --primary-color: #4facfe;
            --secondary-color: #00f2fe;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
        }

        html, body {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .chatbot-main {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: white;
            position: relative;
        }

        /* í—¤ë” */
        .chatbot-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 18px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-title {
            font-size: 20px;
            font-weight: bold;
            margin: 0;
            flex: 1;
        }

        .back-link {
            position: absolute;
            left: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            width: 60px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            transition: all 0.3s ease;
            text-decoration: none;
            z-index: 1000;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .home-icon {
            font-size: 24px;
            line-height: 1;
        }

        .home-arrow {
            font-size: 14px;
            line-height: 1;
            margin-top: 2px;
        }

        /* API ìƒíƒœ í‘œì‹œ */
        #apiStatus {
            position: absolute;
            top: 10px;
            right: 140px;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
            font-weight: bold;
            z-index: 1001;
        }

        /* n8n ì—”ì§„ On ìƒíƒœ ì• ë‹ˆë©”ì´ì…˜ */
        .ai-on {
            background: #d4edda !important;
            color: #155724 !important;
            border-color: #c3e6cb !important;
        }

        .ai-on .blink {
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* AI OFF ìƒíƒœ */
        .ai-off {
            background: #f8d7da !important;
            color: #721c24 !important;
            border-color: #f5c6cb !important;
        }

        /* ì–¸ì–´ ì„ íƒ ë“œë¡­ë‹¤ìš´ */
        .header-language-dropdown {
            position: absolute;
            right: 15px;
            z-index: 2000;
        }

        .language-dropdown {
            position: relative;
            display: inline-block;
        }

        .language-current {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border: 2px solid #ffbf00;
            color: black !important;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 100px;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.4);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .language-current:hover {
            background: linear-gradient(135deg, #ffbf00 0%, #ffd700 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 215, 0, 0.6);
        }

        .language-current:active {
            transform: scale(0.95);
        }

        .language-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 3000;
            display: none;
            min-width: 120px;
            margin-top: 5px;
            animation: menuSlideDown 0.2s ease-out;
        }

        @keyframes menuSlideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .language-menu.show {
            display: block;
        }

        .language-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            color: black !important;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .language-option:last-child {
            border-bottom: none;
        }

        .language-option:hover {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        }

        .language-option:active {
            background: linear-gradient(135deg, #ffbf00 0%, #ffd700 100%);
            transform: scale(0.98);
        }

        .language-option.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white !important;
        }

        /* ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡ ë¸Œë¼ìš°ì € ìµœì í™” */
        .android-kakao .language-current {
            min-height: 36px;  /* 44pxì—ì„œ 36pxë¡œ ì¤„ì„ */
            min-width: 80px;   /* 100pxì—ì„œ 80pxë¡œ ì¤„ì„ */
            padding: 8px 8px;  /* 8px 12pxì—ì„œ 8px 8pxë¡œ ì¤„ì„ */
            font-size: 12px;    /* 14pxì—ì„œ 12pxë¡œ ì¤„ì„ */
        }

        .android-kakao .language-option {
            min-height: 36px;   /* 44pxì—ì„œ 36pxë¡œ ì¤„ì„ */
            min-width: 80px;    /* 120pxì—ì„œ 80pxë¡œ ì¤„ì„ */
            padding: 8px 8px;   /* 8px 12pxì—ì„œ 8px 8pxë¡œ ì¤„ì„ */
            font-size: 12px;    /* 14pxì—ì„œ 12pxë¡œ ì¤„ì„ */
        }

        .android-kakao .language-menu {
            margin-top: 8px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        /* ìœˆë„ìš° ë¸Œë¼ìš°ì € ìµœì í™” */
        .windows-browser .language-current {
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }

        .windows-browser .language-current:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5) !important;
        }

        .windows-browser .language-option {
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }

        .windows-browser .language-option:hover {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%) !important;
            transform: translateX(2px) !important;
        }

        .windows-browser .language-menu {
            animation: menuSlideDown 0.3s ease-out !important;
        }

        /* ë©”ì‹œì§€ ì˜ì—­ */
        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 80px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .message.user .message-avatar {
            background: #e9ecef;
            color: #495057;
        }

        .message-content {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 14px;
            word-wrap: break-word;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.user .message-content {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 6px;
        }

        /* ë¹ ë¥¸ ë²„íŠ¼ ìµœì í™” */
        .quick-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .quick-button {
            background: #f0f8ff;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-radius: 15px;
            padding: 10px 8px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            will-change: transform, box-shadow;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .quick-button:active {
            transform: translateY(0);
        }

        /* íŠ¹ë³„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .clinic-hours-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%) !important;
            color: #333 !important;
            border: none !important;
        }

        .treatment-cost-btn {
            background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%) !important;
            color: white !important;
            border: none !important;
        }

        .reservation-btn {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%) !important;
            color: white !important;
            border: none !important;
        }

        .directions-btn {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%) !important;
            color: white !important;
            border: none !important;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .chatbot-input {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #ddd;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .chatbot-input textarea {
            flex: 1;
            border: 2px solid var(--primary-color);
            border-radius: 20px;
            padding: 12px 16px;
            font-size: 16px;
            resize: none;
            outline: none;
            min-height: 45px;
            max-height: 120px;
            line-height: 1.4;
            -webkit-user-select: text;
            user-select: text;
            touch-action: manipulation;
            font-family: inherit;
        }

        .chatbot-input textarea:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }

        .chatbot-send {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 90px;
            height: 45px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .chatbot-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .chatbot-send:active {
            transform: scale(0.95);
        }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 80% { content: '...'; }
            100% { content: ''; }
        }

        /* ì˜ˆì•½ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .reservation-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%) !important;
            color: white !important;
            border: none !important;
            padding: 12px 24px !important;
            border-radius: 25px !important;
            font-size: 14px !important;
            font-weight: bold !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            text-decoration: none !important;
            display: inline-block !important;
            margin: 10px 0 !important;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3) !important;
            touch-action: manipulation !important;
            -webkit-tap-highlight-color: transparent !important;
        }

        .reservation-button:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5) !important;
        }

        .reservation-message {
            margin-top: 15px !important;
            padding: 15px !important;
            background: #f8f9fa !important;
            border-radius: 10px !important;
            border-left: 4px solid var(--primary-color) !important;
            text-align: center !important;
        }

        .reservation-message-text {
            font-size: 14px !important;
            color: #666 !important;
            margin-bottom: 10px !important;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .chatbot-header {
                padding: 12px 8px;
            }
            
            .chatbot-title {
                font-size: 16px;
                margin: 0 80px;
            }
            
            .back-link {
                width: 50px;
                height: 50px;
                left: 8px;
            }
            
            .home-icon {
                font-size: 20px;
            }
            
            .home-arrow {
                font-size: 12px;
            }
            
            #apiStatus {
                right: 90px;
                font-size: 10px;
                padding: 3px 6px;
            }
            
            .header-language-dropdown {
                right: 8px;
            }
            
            .language-current {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 80px;
            }
            
            .chatbot-messages {
                padding: 12px;
                margin-bottom: 75px;
            }
            
            .message-content {
                max-width: 85%;
                font-size: 13px;
            }
            
            .quick-buttons {
                gap: 6px;
                max-width: 280px;
            }
            
            .quick-button {
                font-size: 11px;
                padding: 8px 6px;
                min-height: 40px;
            }
            
            .chatbot-input {
                padding: 10px;
            }
            
            .chatbot-send {
                min-width: 70px;
                padding: 10px 16px;
                font-size: 14px;
            }
            
            /* ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡ ë¸Œë¼ìš°ì € ëª¨ë°”ì¼ ìµœì í™” */
            .android-kakao .language-current {
                padding: 6px 8px;
                font-size: 12px;
                min-width: 75px;
                min-height: 40px;
            }
            
            .android-kakao .language-option {
                padding: 8px 8px;
                font-size: 12px;
                min-height: 40px;
            }
            
            .android-kakao .language-menu {
                margin-top: 6px;
                min-width: 85px;
            }
        }

        @media (max-width: 480px) {
            .chatbot-title {
                font-size: 14px;
                margin: 0 70px;
            }
            
            .back-link {
                width: 45px;
                height: 45px;
                left: 5px;
            }
            
            .home-icon {
                font-size: 18px;
            }
            
            .home-arrow {
                font-size: 10px;
            }
            
            #apiStatus {
                right: 75px;
                font-size: 9px;
                padding: 2px 4px;
            }
            
            .header-language-dropdown {
                right: 5px;
            }
            
            .language-current {
                padding: 5px 8px;
                font-size: 10px;
                min-width: 70px;
            }
            
            .chatbot-messages {
                padding: 8px;
                margin-bottom: 70px;
            }
            
            .quick-buttons {
                gap: 4px;
                max-width: 250px;
            }
            
            .quick-button {
                font-size: 10px;
                padding: 6px 4px;
                min-height: 36px;
            }
            
            .chatbot-input {
                padding: 8px;
            }
            
            .chatbot-send {
                min-width: 60px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        /* iOS Safari ìµœì í™” */
        @supports (-webkit-touch-callout: none) {
            .chatbot-main {
                height: 100vh;
                height: -webkit-fill-available;
            }
            
            .chatbot-input {
                padding-bottom: env(safe-area-inset-bottom, 15px);
            }
        }

        /* í‚¤ë³´ë“œ ì—´ë¦¼ ìƒíƒœ ìµœì í™” */
        .keyboard-open .chatbot-messages {
            padding-bottom: 20px;
        }

        /* PC ìµœì í™” */
        @media (min-width: 1024px) {
            .chatbot-main {
                max-width: 800px;
                margin: 0 auto;
                height: 90vh;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.1);
                margin-top: 5vh;
            }
            
            .chatbot-header {
                border-radius: 20px 20px 0 0;
            }
            
            .chatbot-input {
                border-radius: 0 0 20px 20px;
            }
            
            #apiStatus {
                right: 160px;
                font-size: 12px;
                padding: 6px 10px;
            }
            
            .language-current {
                min-width: 120px;
                font-size: 14px;
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="chatbot-main">
        <!-- í—¤ë” -->
        <div class="chatbot-header">
            <a href="admin.html" class="back-link">
                <span class="home-icon">âš™ï¸</span>
                <span class="home-arrow">ì„¤ì •</span>
            </a>
            <h1 class="chatbot-title">Tax-AgentğŸ’°</h1>
            
            <!-- API ì„¤ì • ìƒíƒœ í‘œì‹œ -->
            <div id="apiStatus" style="cursor: pointer;" onclick="showApiStatusInfo()">âŒ AI API ì„¤ì • ì•ˆë¨</div>
            
            <!-- ì–¸ì–´ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
            <div class="header-language-dropdown">
                <div class="language-dropdown">
                    <button class="language-current" onclick="toggleLanguageMenu()" ontouchstart="toggleLanguageMenu()">
                        <span id="currentLanguageText">ğŸ‡°ğŸ‡· KR</span>
                        <span>â–¼</span>
                    </button>
                    <div class="language-menu" id="languageMenu">
                        <div class="language-option active" data-lang="ko" onclick="selectLanguage('ko')" ontouchstart="selectLanguage('ko')">ğŸ‡°ğŸ‡· KR</div>
                        <div class="language-option" data-lang="en" onclick="selectLanguage('en')" ontouchstart="selectLanguage('en')">ğŸ‡ºğŸ‡¸ US</div>
                        <div class="language-option" data-lang="ru" onclick="selectLanguage('ru')" ontouchstart="selectLanguage('ru')">ğŸ‡·ğŸ‡º RU</div>
                        <div class="language-option" data-lang="ja" onclick="selectLanguage('ja')" ontouchstart="selectLanguage('ja')">ğŸ‡¯ğŸ‡µ JP</div>
                    </div>
                </div>
            </div>
        </div>



        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div class="chatbot-messages" id="chatbotMessages">
            <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <div class="chatbot-input">
            <textarea id="chatbotInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1" oninput="adjustTextareaHeight(this)" onkeydown="handleInputKeyDown(event)"></textarea>
            <button class="chatbot-send" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </div>

    <script>
        console.log('ğŸš€ Tax-Agent ì–‘ë„ì„¸ ì±—ë´‡ ì‹œì‘ (ìµœì í™” ë²„ì „)');

        // ğŸ¯ ì±—ë´‡ í•µì‹¬ í´ë˜ìŠ¤ (ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì ìš©)
        class TaxAgentChatbot {
            constructor() {
                this.currentLanguage = 'ko';
                this.apiSettings = null;
                this.knowledgeBase = { enabled: false, files: [], parsedData: [] };
                this.isProcessingMessage = false;
                this.lastMessageTime = 0;
                this.lastMessage = '';
                
                // ëŒ€í™” ì´ë ¥ ê´€ë¦¬
                this.chatHistory = [];
                this.MAX_HISTORY = 20; // ìµœëŒ€ ëŒ€í™” ì´ë ¥ ê°œìˆ˜
                this.MAX_TOKENS = 1500; // API í˜¸ì¶œ ìµœëŒ€ í† í°
                
                this.initializeTranslations();
                this.init();
            }
            
            // ë²ˆì—­ ë°ì´í„° ì´ˆê¸°í™”
            initializeTranslations() {
                this.translations = {
                    ko: {
                        title: 'Tax-AgentğŸ’°',
                        placeholder: 'ì–‘ë„ì„¸ ê´€ë ¨ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...',
                        sendButton: 'ì „ì†¡',
                        currentLanguage: 'ğŸ‡°ğŸ‡· KR',
                        welcomeMessage: 'Tax-Agent ì–‘ë„ì„¸ ì „ë¬¸ ìƒë‹´ì‚¬ì…ë‹ˆë‹¤!',
                        welcomeSubMessage: 'ìš°ì¸¡ ìƒë‹¨ì—ì„œ ì–¸ì–´ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤'
                    },
                    en: {
                        title: 'Tax-AgentğŸ’°',
                        placeholder: 'Enter your capital gains tax question...',
                        sendButton: 'Send',
                        currentLanguage: 'ğŸ‡ºğŸ‡¸ US',
                        welcomeMessage: 'I am Tax-Agent capital gains tax specialist!',
                        welcomeSubMessage: 'Language change available in top right menu'
                    },
                    ru: {
                        title: 'Tax-AgentğŸ’°',
                        placeholder: 'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğµ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°...',
                        sendButton: 'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ',
                        currentLanguage: 'ğŸ‡·ğŸ‡º RU',
                        welcomeMessage: 'Ğ¯ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ñƒ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ° Tax-Agent!',
                        welcomeSubMessage: 'Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ ÑĞ·Ñ‹ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ² Ğ¼ĞµĞ½Ñ ÑĞ¿Ñ€Ğ°Ğ²Ğ° Ğ²Ğ²ĞµÑ€Ñ…Ñƒ'
                    },
                    ja: {
                        title: 'Tax-AgentğŸ’°',
                        placeholder: 'è­²æ¸¡ç¨ã«é–¢ã™ã‚‹è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...',
                        sendButton: 'é€ä¿¡',
                        currentLanguage: 'ğŸ‡¯ğŸ‡µ JP',
                        welcomeMessage: 'Tax-Agentè­²æ¸¡ç¨å°‚é–€ç›¸è«‡å“¡ã§ã™ï¼',
                        welcomeSubMessage: 'å³ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§è¨€èªå¤‰æ›´ãŒå¯èƒ½ã§ã™'
                    }
                };
            }
            
            // ì´ˆê¸°í™” (ë¸Œë¼ìš°ì €ë³„ í˜¸í™˜ì„± ê°œì„ )
            async init() {
                console.log('ğŸ¤– Tax-Agent ì–‘ë„ì„¸ ì±—ë´‡ ì´ˆê¸°í™” ì‹œì‘');
                
                this.loadSettings();
                this.setupEventListeners();
                this.setupMobileOptimization();
                setTimeout(() => this.addWelcomeMessage(), 500);
                this.updateLanguageUI();
                
                // ë¸Œë¼ìš°ì €ë³„ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                try {
                    await this.testBrowserApiConnection();
                } catch (error) {
                    console.warn('âš ï¸ ë¸Œë¼ìš°ì €ë³„ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                }
                
                console.log('âœ… Tax-Agent ì–‘ë„ì„¸ ì±—ë´‡ ì´ˆê¸°í™” ì™„ë£Œ');
            }
            
            // ì„¤ì • ë¡œë”©
            loadSettings() {
                this.loadApiSettings();
                this.loadKnowledgeBaseSettings();
                this.loadHistorySettings();
                this.updateApiStatusDisplay();
            }
            
            // ğŸ¯ í•µì‹¬ ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜ (API ìš°ì„ ìˆœìœ„ ìµœìƒìœ„)
            async processMessage(message) {
                console.log('ğŸ¯ ë©”ì‹œì§€ ì²˜ë¦¬ ì‹œì‘:', message);
                
                // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
                if (this.isDuplicateMessage(message)) {
                    console.log('âš ï¸ ì¤‘ë³µ ë©”ì‹œì§€ ì°¨ë‹¨');
                    return;
                }
                
                this.setProcessingFlag(true);
                
                try {
                    // âœ… 1ì°¨: AI API í˜¸ì¶œ (ìµœìš°ì„ )
                    console.log('ğŸ¤– 1ì°¨: AI API í˜¸ì¶œ ì‹œë„');
                    if (this.hasActiveAPI()) {
                        console.log('âœ… í™œì„±í™”ëœ AI API ë°œê²¬');
                        
                        // ìƒì„¸ ì§ˆë¬¸ì´ë‚˜ íŠ¹ì • ì¹˜ë£Œë¹„ìš© ì§ˆë¬¸ì¸ ê²½ìš°ì—ë§Œ ìŠ¤ë§ˆíŠ¸ í•„í„°ë§ ì ìš©
                        const useSmartFiltering = this.isDetailedQuestion(message) || 
                                                 this.isSpecificTreatmentCostQuery(message);
                        
                        await this.generateAIResponse(message, useSmartFiltering);
                        return;
                    }
                    
                    // âœ… 2ì°¨: ì¸ì‚¬/ê°ì‚¬ ì²˜ë¦¬ (ë¹ ë¥¸ ì‘ë‹µ)
                    if (this.isGreetingOrThanks(message)) {
                        console.log('ğŸ˜Š 2ì°¨: ì¸ì‚¬/ê°ì‚¬ ì²˜ë¦¬');
                        const response = this.generateGreetingResponse(message);
                        this.addBotMessage(response);
                        return;
                    }
                    
                    // âœ… 3ì°¨: ì§€ì‹ë² ì´ìŠ¤ ê²€ìƒ‰
                    console.log('ğŸ“š 3ì°¨: ì§€ì‹ë² ì´ìŠ¤ ê²€ìƒ‰');
                    const knowledgeAnswer = this.searchInKnowledgeBase(message);
                    if (knowledgeAnswer) {
                        console.log('âœ… ì§€ì‹ë² ì´ìŠ¤ì—ì„œ ë‹µë³€ ë°œê²¬');
                        this.addBotMessage(knowledgeAnswer);
                        return;
                    }
                    
                    // âœ… 4ì°¨: ê¸°ë³¸ FAQ ë‹µë³€ (í‚¤ì›Œë“œ ê¸°ë°˜)
                    console.log('â“ 4ì°¨: ê¸°ë³¸ FAQ ê²€ìƒ‰');
                    const faqAnswer = this.getFAQAnswer(message);
                    if (faqAnswer) {
                        console.log('âœ… FAQ ë‹µë³€ ë°œê²¬:', faqAnswer.type);
                        this.addBotMessage(faqAnswer.content);
                        return;
                    }
                    
                    // íŠ¹ì • ì–‘ë„ì„¸ ê³„ì‚° ì§ˆë¬¸ ì²˜ë¦¬ ì¶”ê°€
                    if (this.isSpecificTaxCalculationQuery(message)) {
                        console.log('ğŸ’° íŠ¹ì • ì–‘ë„ì„¸ ê³„ì‚° ì§ˆë¬¸ ê°ì§€: í‚¤ì›Œë“œ ë‹µë³€ ì œê³µ');
                        const taxAnswer = this.createTaxCalculationContent(this.currentLanguage);
                        this.addBotMessage(taxAnswer);
                        return;
                    }
                    
                    // âœ… 5ì°¨: ì‹œë®¬ë ˆì´ì…˜ëœ ë‹µë³€ (ìµœí›„ ìˆ˜ë‹¨)
                    console.log('ğŸ­ 5ì°¨: ì‹œë®¬ë ˆì´ì…˜ëœ ë‹µë³€ ì‚¬ìš©');
                    setTimeout(() => {
                        const response = this.generateSimulatedResponse(message);
                        this.addBotMessage(response);
                    }, 800);
                    
                } catch (error) {
                    console.error('âŒ ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    
                    const errorMessages = {
                        ko: 'ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                        en: 'Sorry. A temporary error occurred. Please try again.',
                        ru: 'Ğ˜Ğ·Ğ²Ğ¸Ğ½Ğ¸Ñ‚Ğµ. ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·.',
                        ja: 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ä¸€æ™‚çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
                    };
                    
                    this.addBotMessage(errorMessages[this.currentLanguage] || errorMessages['ko']);
                } finally {
                    this.setProcessingFlag(false);
                }
            }
            
            // ì¤‘ë³µ ë©”ì‹œì§€ í™•ì¸ (ê°œì„ ë¨)
            isDuplicateMessage(message) {
                const currentTime = Date.now();
                const isDuplicate = this.isProcessingMessage || 
                                   (currentTime - this.lastMessageTime < 1000 && this.lastMessage === message);
                
                this.lastMessageTime = currentTime;
                this.lastMessage = message;
                return isDuplicate;
            }
            
            // ì²˜ë¦¬ í”Œë˜ê·¸ ì„¤ì •
            setProcessingFlag(processing) {
                this.isProcessingMessage = processing;
                if (processing) {
                    setTimeout(() => { this.isProcessingMessage = false; }, 5000);
                }
            }
            

            
            // ì¸ì‚¬/ê°ì‚¬ í™•ì¸
            isGreetingOrThanks(message) {
                const greetings = ['ì•ˆë…•', 'hello', 'hi', 'í•˜ì´', 'ë°˜ê°€ì›Œ', 'ì•ˆë…•í•˜ì„¸ìš”'];
                const thanks = ['ê°ì‚¬', 'ê³ ë§ˆì›Œ', 'thanks', 'thank you', 'ë•¡í'];
                const meaningless = /^(ë–¼|ë°|í…Œ|ë•Œ|ë—˜|ë—´|ë°ë°|ë–¼ë–¼){1,}$/i;
                
                const lower = message.toLowerCase();
                return greetings.some(g => lower.includes(g)) || 
                       thanks.some(t => lower.includes(t)) || 
                       meaningless.test(lower);
            }
            
            // ì¸ì‚¬/ê°ì‚¬ ì‘ë‹µ ìƒì„±
            generateGreetingResponse(message) {
                const lower = message.toLowerCase();
                const reservationText = this.getReservationText();
                
                const greetingResponses = {
                    ko: {
                        thanks: `ì²œë§Œì—ìš”! Tax-Agentë¥¼ ì´ìš©í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ë” ê¶ê¸ˆí•œ ì–‘ë„ì„¸ ê´€ë ¨ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¸ì˜í•´ì£¼ì„¸ìš” ğŸ˜Š`,
                        hello: `ì•ˆë…•í•˜ì„¸ìš”! Tax-Agent ì–‘ë„ì„¸ ì „ë¬¸ ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ì–‘ë„ì„¸ ê´€ë ¨ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ ì£¼ì„¸ìš” ğŸ˜Š`
                    },
                    en: {
                        thanks: `You're welcome! Thank you for using Tax-Agent. If you have any more capital gains tax questions, please feel free to ask anytime ğŸ˜Š`,
                        hello: `Hello! I am Tax-Agent capital gains tax specialist. If you have any tax-related questions, please feel free to ask anytime ğŸ˜Š`
                    },
                    ru: {
                        thanks: `ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°! Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾, Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ĞµÑÑŒ Tax-Agent. Ğ•ÑĞ»Ğ¸ Ñƒ Ğ²Ğ°Ñ ĞµÑÑ‚ÑŒ ĞµÑ‰Ğµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğµ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°, Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¾Ğ±Ñ€Ğ°Ñ‰Ğ°Ğ¹Ñ‚ĞµÑÑŒ Ğ² Ğ»ÑĞ±Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ ğŸ˜Š`,
                        hello: `Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ! Ğ¯ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ñƒ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ° Tax-Agent. Ğ•ÑĞ»Ğ¸ Ñƒ Ğ²Ğ°Ñ ĞµÑÑ‚ÑŒ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ°Ğ¼, Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¾Ğ±Ñ€Ğ°Ñ‰Ğ°Ğ¹Ñ‚ĞµÑÑŒ Ğ² Ğ»ÑĞ±Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ ğŸ˜Š`
                    },
                    ja: {
                        thanks: `ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼Tax-Agentã‚’ã”åˆ©ç”¨ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ä»–ã«è­²æ¸¡ç¨ã«é–¢ã™ã‚‹ã”è³ªå•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ã„ã¤ã§ã‚‚ãŠæ°—è»½ã«ãŠèã‹ã›ãã ã•ã„ ğŸ˜Š`,
                        hello: `ã“ã‚“ã«ã¡ã¯ï¼Tax-Agentè­²æ¸¡ç¨å°‚é–€ç›¸è«‡å“¡ã§ã™ã€‚è­²æ¸¡ç¨ã«é–¢ã™ã‚‹ã”è³ªå•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ã„ã¤ã§ã‚‚ãŠæ°—è»½ã«ãŠèã‹ã›ãã ã•ã„ ğŸ˜Š`
                    }
                };
                
                const currentResponses = greetingResponses[this.currentLanguage] || greetingResponses['ko'];
                
                if (lower.includes('ê°ì‚¬') || lower.includes('ê³ ë§ˆì›Œ') || lower.includes('thank') || 
                    lower.includes('ÑĞ¿Ğ°ÑĞ¸Ğ±Ğ¾') || lower.includes('ã‚ã‚ŠãŒã¨ã†')) {
                    return `${currentResponses.thanks}
                    
                    <div class="reservation-message">
                        <div class="reservation-message-text">${reservationText.message}</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                    </div>`;
                }
                
                return `${currentResponses.hello}
                
                <div class="reservation-message">
                    <div class="reservation-message-text">${reservationText.message}</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                </div>`;
            }
            
            // FAQ ë‹µë³€ ì²˜ë¦¬ (ìŠ¤ë§ˆíŠ¸ í‚¤ì›Œë“œ ë§¤ì¹­)
            getFAQAnswer(message) {
                // ìƒì„¸ ì§ˆë¬¸ì¸ ê²½ìš° í‚¤ì›Œë“œ ë§¤ì¹­ ìš°íšŒ
                if (this.isDetailedQuestion(message)) {
                    console.log(' ìƒì„¸ ì§ˆë¬¸ ê°ì§€: í‚¤ì›Œë“œ ë§¤ì¹­ ìš°íšŒ');
                    return null;
                }
                
                const keywordGroups = this.getKeywordGroups();
                const normalized = message.toLowerCase().trim();
                
                for (const [groupName, group] of Object.entries(keywordGroups)) {
                    if (this.matchesKeywords(normalized, group.keywords)) {
                        // ë™ì ìœ¼ë¡œ ì½˜í…ì¸  ìƒì„±
                        let content;
                        switch (group.type) {
                            case 'capitalGainsTax':
                                content = this.createCapitalGainsTaxContent(this.currentLanguage);
                                break;
                            case 'taxCalculation':
                                content = this.createTaxCalculationContent(this.currentLanguage);
                                break;
                            case 'taxFiling':
                                content = this.createTaxFilingContent(this.currentLanguage);
                                break;
                            case 'taxExemption':
                                content = this.createTaxExemptionContent(this.currentLanguage);
                                break;
                            default:
                                content = '';
                        }
                        
                        return {
                            type: group.type,
                            content: content
                        };
                    }
                }
                
                return null;
            }
            
            // í‚¤ì›Œë“œ ê·¸ë£¹ ì •ì˜ (ì–‘ë„ì„¸ ê´€ë ¨ í‚¤ì›Œë“œ)
            getKeywordGroups() {
                return {
                    capitalGainsTax: {
                        keywords: [
                            // í•œêµ­ì–´ (7ê°œ)
                            'ì–‘ë„ì„¸', 'ì–‘ë„ì†Œë“ì„¸', 'ì–‘ë„ì†Œë“', 'ì–‘ë„', 'ì–‘ë„ì„¸ìœ¨', 'ì–‘ë„ì„¸ê³„ì‚°', 'ì–‘ë„ì„¸ì‹ ê³ ',
                            // ì˜ì–´ (7ê°œ)
                            'capital gains tax', 'capital gains', 'gains tax', 'tax on gains', 'capital gains rate', 'tax calculation',
                            // ëŸ¬ì‹œì•„ì–´ (7ê°œ)
                            'Ğ½Ğ°Ğ»Ğ¾Ğ³ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°', 'Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°', 'Ğ½Ğ°Ğ»Ğ¾Ğ³ Ğ½Ğ° Ğ´Ğ¾Ñ…Ğ¾Ğ´Ñ‹', 'Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ğ°Ğ²ĞºĞ°',
                            // ì¼ë³¸ì–´ (7ê°œ)
                            'è­²æ¸¡ç¨', 'è­²æ¸¡æ‰€å¾—ç¨', 'è­²æ¸¡æ‰€å¾—', 'è­²æ¸¡', 'è­²æ¸¡ç¨ç‡', 'è­²æ¸¡ç¨è¨ˆç®—'
                        ],
                        type: 'capitalGainsTax'
                    },
                    taxCalculation: {
                        keywords: [
                            // í•œêµ­ì–´ (7ê°œ)
                            'ì„¸ê¸ˆê³„ì‚°', 'ì–‘ë„ì„¸ê³„ì‚°', 'ì„¸ìœ¨', 'ê³¼ì„¸í‘œì¤€', 'ì„¸ì•¡', 'ê³µì œ', 'ê°ë©´',
                            // ì˜ì–´ (7ê°œ)
                            'tax calculation', 'tax rate', 'taxable income', 'tax amount', 'deduction', 'exemption',
                            // ëŸ¬ì‹œì•„ì–´ (7ê°œ)
                            'Ñ€Ğ°ÑÑ‡ĞµÑ‚ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ°', 'Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ğ°Ğ²ĞºĞ°', 'Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ¾Ğ±Ğ»Ğ°Ğ³Ğ°ĞµĞ¼Ñ‹Ğ¹ Ğ´Ğ¾Ñ…Ğ¾Ğ´', 'Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°',
                            // ì¼ë³¸ì–´ (7ê°œ)
                            'ç¨é‡‘è¨ˆç®—', 'è­²æ¸¡ç¨è¨ˆç®—', 'ç¨ç‡', 'èª²ç¨æ¨™æº–', 'ç¨é¡', 'æ§é™¤', 'æ¸›å…'
                        ],
                        type: 'taxCalculation'
                    },
                    taxFiling: {
                        keywords: [
                            // í•œêµ­ì–´ (6ê°œ)
                            'ì„¸ê¸ˆì‹ ê³ ', 'ì–‘ë„ì„¸ì‹ ê³ ', 'ì‹ ê³ ', 'ì‹ ê³ ê¸°í•œ', 'ì‹ ê³ ì„œ', 'ì‹ ê³ ë°©ë²•',
                            // ì˜ì–´ (6ê°œ)
                            'tax filing', 'tax return', 'filing', 'deadline', 'tax form', 'filing method',
                            // ëŸ¬ì‹œì•„ì–´ (6ê°œ)
                            'Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ Ğ´ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ñ', 'Ğ´ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ñ', 'ÑÑ€Ğ¾Ğº Ğ¿Ğ¾Ğ´Ğ°Ñ‡Ğ¸', 'Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ°',
                            // ì¼ë³¸ì–´ (6ê°œ)
                            'ç¨é‡‘ç”³å‘Š', 'è­²æ¸¡ç¨ç”³å‘Š', 'ç”³å‘Š', 'ç”³å‘ŠæœŸé™', 'ç”³å‘Šæ›¸', 'ç”³å‘Šæ–¹æ³•'
                        ],
                        type: 'taxFiling'
                    },
                    taxExemption: {
                        keywords: [
                            // í•œêµ­ì–´ (8ê°œ)
                            'ë¹„ê³¼ì„¸', 'ë©´ì„¸', 'ê³µì œ', 'ê°ë©´', 'ë¹„ê³¼ì„¸ìš”ê±´', 'ë©´ì„¸ìš”ê±´', 'ê³µì œìš”ê±´', 'ê°ë©´ìš”ê±´',
                            // ì˜ì–´ (8ê°œ)
                            'tax exemption', 'exemption', 'deduction', 'non-taxable', 'exemption requirements', 'deduction requirements',
                            // ëŸ¬ì‹œì•„ì–´ (8ê°œ)
                            'Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğµ Ğ»ÑŒĞ³Ğ¾Ñ‚Ñ‹', 'Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ', 'Ğ²Ñ‹Ñ‡ĞµÑ‚', 'Ğ½ĞµĞ¾Ğ±Ğ»Ğ°Ğ³Ğ°ĞµĞ¼Ñ‹Ğ¹', 'Ğ»ÑŒĞ³Ğ¾Ñ‚Ğ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ',
                            // ì¼ë³¸ì–´ (8ê°œ)
                            'éèª²ç¨', 'å…ç¨', 'æ§é™¤', 'æ¸›å…', 'éèª²ç¨è¦ä»¶', 'å…ç¨è¦ä»¶', 'æ§é™¤è¦ä»¶', 'æ¸›å…è¦ä»¶'
                        ],
                        type: 'taxExemption'
                    }
                };
            }
            
            // í‚¤ì›Œë“œ ë§¤ì¹­ (ë” ì •í™•í•œ ì•Œê³ ë¦¬ì¦˜)
            matchesKeywords(message, keywords) {
                return keywords.some(keyword => {
                    // ì •í™•í•œ ë‹¨ì–´ ê²½ê³„ ë§¤ì¹­ ë˜ëŠ” ë¶€ë¶„ ë¬¸ìì—´ ë§¤ì¹­
                    const wordBoundary = new RegExp(`\\b${keyword.toLowerCase()}\\b`);
                    return wordBoundary.test(message) || message.includes(keyword.toLowerCase());
                });
            }
            
            // ìƒì„¸ ì§ˆë¬¸ íŒ¨í„´ ê°ì§€ í•¨ìˆ˜ ì¶”ê°€
            isDetailedQuestion(message) {
                const detailedPatterns = [
                    // ì§ˆë¬¸ì–´ íŒ¨í„´
                    /(ì–´ë–»ê²Œ|ì–´ë–¤|ì™œ|ì–¸ì œ|ì–´ë””ì„œ|ëˆ„ê°€|ë¬´ì—‡ì„|ì–´ë– í•œ|ì–´ë–¤ì§€|ì–´ë–»ê²Œìš”|ì–´ë–¤ê°€ìš”|ì™œìš”|ì–¸ì œìš”|ì–´ë””ì„œìš”|ëˆ„ê°€ìš”|ë¬´ì—‡ì„ìš”|ì–´ë– í•œê°€ìš”)/,
                    // ìƒì„¸ ì„¤ëª… ìš”ì²­ íŒ¨í„´
                    /(ìì„¸íˆ|ìƒì„¸íˆ|êµ¬ì²´ì ìœ¼ë¡œ|ì •í™•íˆ|ì •í™•í•œ|ìì„¸í•œ|ìƒì„¸í•œ|êµ¬ì²´ì ì¸|ì•Œë ¤ì£¼ì„¸ìš”|ì„¤ëª…í•´ì£¼ì„¸ìš”|ê°€ë¥´ì³ì£¼ì„¸ìš”|ì•Œë ¤ì£¼ì‹œê² ì–´ìš”|ì„¤ëª…í•´ì£¼ì‹œê² ì–´ìš”|ê°€ë¥´ì³ì£¼ì‹œê² ì–´ìš”)/,
                    // ë¹„êµ/ë¶„ì„ ìš”ì²­ íŒ¨í„´
                    /(ì°¨ì´ì |ë¹„êµ|ë¶„ì„|ì¥ë‹¨ì |ì¥ì |ë‹¨ì |ì–´ë–¤|ì–´ë–¤ ê²ƒì´|ì–´ë–¤ ê²ƒì´ ì¢‹ì€ì§€|ì–´ë–¤ ê²ƒì´ ë‚˜ìœì§€|ì–´ë–¤ ê²ƒì´ ë”|ì–´ë–¤ ê²ƒì´ ì í•©í•œì§€)/,
                    // ê³¼ì •/ì ˆì°¨ ìš”ì²­ íŒ¨í„´
                    /(ê³¼ì •|ì ˆì°¨|ìˆœì„œ|ë‹¨ê³„|ë°©ë²•|ì–´ë–»ê²Œ|ì–´ë–¤ ìˆœì„œë¡œ|ì–´ë–¤ ë‹¨ê³„ë¡œ|ì–´ë–¤ ê³¼ì •ì„|ì–´ë–¤ ì ˆì°¨ë¥¼|ì–´ë–¤ ë°©ë²•ìœ¼ë¡œ)/,
                    // ì›ì¸/ì´ìœ  ìš”ì²­ íŒ¨í„´
                    /(ì›ì¸|ì´ìœ |ì™œ|ì–´ë–¤ ì´ìœ ë¡œ|ì–´ë–¤ ì›ì¸ìœ¼ë¡œ|ì™œ ê·¸ëŸ°ì§€|ì–´ë–¤ ì´ìœ ì¸ì§€|ì–´ë–¤ ì›ì¸ì¸ì§€|ì™œ ê·¸ëŸ°ê°€ìš”|ì–´ë–¤ ì´ìœ ì¸ê°€ìš”|ì–´ë–¤ ì›ì¸ì¸ê°€ìš”)/
                ];
                
                const normalized = message.toLowerCase().trim();
                return detailedPatterns.some(pattern => pattern.test(normalized));
            }
            
            // íŠ¹ì • ì–‘ë„ì„¸ ê³„ì‚° ì§ˆë¬¸ ê°ì§€ í•¨ìˆ˜ ì¶”ê°€
            isSpecificTaxCalculationQuery(message) {
                const taxKeywords = [
                    // ì–‘ë„ì„¸ ì¢…ë¥˜ë³„ í‚¤ì›Œë“œ
                    'ë¶€ë™ì‚°', 'ì£¼ì‹', 'í† ì§€', 'ê±´ë¬¼', 'ì•„íŒŒíŠ¸', 'ë¹Œë¼', 'ìƒê°€', 'í† ì§€ì–‘ë„', 'ë¶€ë™ì‚°ì–‘ë„', 'ì£¼ì‹ì–‘ë„',
                    'real estate', 'stock', 'land', 'building', 'apartment', 'villa', 'commercial property', 'land transfer', 'real estate transfer', 'stock transfer',
                    'Ğ½ĞµĞ´Ğ²Ğ¸Ğ¶Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ', 'Ğ°ĞºÑ†Ğ¸Ğ¸', 'Ğ·ĞµĞ¼Ğ»Ñ', 'Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ', 'ĞºĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ğ°', 'Ğ²Ğ¸Ğ»Ğ»Ğ°', 'ĞºĞ¾Ğ¼Ğ¼ĞµÑ€Ñ‡ĞµÑĞºĞ°Ñ Ğ½ĞµĞ´Ğ²Ğ¸Ğ¶Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ',
                    'ä¸å‹•ç”£', 'æ ªå¼', 'åœŸåœ°', 'å»ºç‰©', 'ã‚¢ãƒ‘ãƒ¼ãƒˆ', 'ãƒãƒ³ã‚·ãƒ§ãƒ³', 'å•†æ¥­æ–½è¨­', 'åœŸåœ°è­²æ¸¡', 'ä¸å‹•ç”£è­²æ¸¡', 'æ ªå¼è­²æ¸¡'
                ];
                
                const calculationKeywords = [
                    // ê³„ì‚° ê´€ë ¨ í‚¤ì›Œë“œ
                    'ê³„ì‚°', 'ì„¸ìœ¨', 'ì„¸ê¸ˆ', 'ì–‘ë„ì„¸', 'ì–¼ë§ˆ', 'ê¸ˆì•¡', 'ì›',
                    'calculation', 'tax rate', 'tax', 'capital gains tax', 'amount', 'money',
                    'Ñ€Ğ°ÑÑ‡ĞµÑ‚', 'Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ğ°Ğ²ĞºĞ°', 'Ğ½Ğ°Ğ»Ğ¾Ğ³', 'ÑÑƒĞ¼Ğ¼Ğ°', 'Ğ´ĞµĞ½ÑŒĞ³Ğ¸',
                    'è¨ˆç®—', 'ç¨ç‡', 'ç¨é‡‘', 'è­²æ¸¡ç¨', 'é‡‘é¡', 'ãŠé‡‘', 'å††'
                ];
                
                const normalized = message.toLowerCase().trim();
                const hasTaxKeyword = taxKeywords.some(keyword => normalized.includes(keyword));
                const hasCalculationKeyword = calculationKeywords.some(keyword => normalized.includes(keyword));
                
                return hasTaxKeyword && hasCalculationKeyword;
            }
            
            // ìŠ¤ë§ˆíŠ¸ ëŒ€í™” ì´ë ¥ í•„í„°ë§ í•¨ìˆ˜ ì¶”ê°€
            getSmartFilteredHistory(message) {
                const recentHistory = this.chatHistory.slice(-this.MAX_HISTORY);
                
                // ì§ˆë¬¸ ìœ í˜•ì— ë”°ë¥¸ í•„í„°ë§
                if (this.isSpecificTaxCalculationQuery(message)) {
                    // ì–‘ë„ì„¸ ê³„ì‚° ì§ˆë¬¸: ì´ë ¥ ì œì™¸ (ì •í™•í•œ ë‹µë³€ì„ ìœ„í•´)
                    console.log('ğŸ’° ì–‘ë„ì„¸ ê³„ì‚° ì§ˆë¬¸ ê°ì§€: ëŒ€í™” ì´ë ¥ ì œì™¸');
                    return [];
                } else if (this.isDetailedQuestion(message)) {
                    // ìƒì„¸ ì§ˆë¬¸: ìµœê·¼ 5ê°œ ë©”ì‹œì§€ë§Œ í¬í•¨ (ê´€ë ¨ì„± ë†’ì€ ì»¨í…ìŠ¤íŠ¸ë§Œ)
                    console.log(' ìƒì„¸ ì§ˆë¬¸ ê°ì§€: ìµœê·¼ 5ê°œ ë©”ì‹œì§€ë§Œ í¬í•¨');
                    return recentHistory.slice(-5).map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));
                } else {
                    // ì¼ë°˜ ì§ˆë¬¸: ê¸°ì¡´ ë¡œì§ ì‚¬ìš©
                    console.log(' ì¼ë°˜ ì§ˆë¬¸: ê¸°ì¡´ ëŒ€í™” ì´ë ¥ ë¡œì§ ì‚¬ìš©');
                    return recentHistory.map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));
                }
            }
            
            // API í™œì„± ìƒíƒœ í™•ì¸ (ê¸°ë³¸ OpenAI í™œì„±í™”)
            hasActiveAPI() {
                const hasApi = this.apiSettings && (
                    (this.apiSettings.openai?.enabled) || // OpenAIëŠ” í™œì„±í™”ë§Œ ë˜ì–´ìˆìœ¼ë©´ ì‚¬ìš© ê°€ëŠ¥ (API í‚¤ëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬)
                    (this.apiSettings.google?.enabled && this.apiSettings.google?.apiKey) ||
                    (this.apiSettings.anthropic?.enabled && this.apiSettings.anthropic?.apiKey)
                );
                
                // ë¸Œë¼ìš°ì €ë³„ ì¶”ê°€ ê²€ì¦
                if (hasApi) {
                    const userAgent = navigator.userAgent;
                    const isChrome = /Chrome/.test(userAgent) && !/Edge/.test(userAgent);
                    
                    // Chrome ë¸Œë¼ìš°ì €ì—ì„œ ì¶”ê°€ ê²€ì¦
                    if (isChrome) {
                        console.log('ğŸ” Chrome ë¸Œë¼ìš°ì €ì—ì„œ API ìƒíƒœ ì¶”ê°€ ê²€ì¦');
                        // Chromeì—ì„œëŠ” ì‹¤ì œ ì—°ê²° í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŒ
                    }
                }
                
                return hasApi;
            }
            
            // ë¸Œë¼ìš°ì €ë³„ API ì—°ê²° í…ŒìŠ¤íŠ¸
            async testBrowserApiConnection() {
                const userAgent = navigator.userAgent;
                const browserInfo = {
                    isChrome: /Chrome/.test(userAgent) && !/Edge/.test(userAgent),
                    isEdge: /Edge/.test(userAgent),
                    isFirefox: /Firefox/.test(userAgent),
                    isSafari: /Safari/.test(userAgent) && !/Chrome/.test(userAgent),
                    isKakaoTalk: /KAKAO/.test(userAgent),
                    userAgent: userAgent.substring(0, 100)
                };
                
                console.log('ğŸ§ª ë¸Œë¼ìš°ì €ë³„ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘:', browserInfo);
                
                try {
                    // ê°„ë‹¨í•œ API ì—°ê²° í…ŒìŠ¤íŠ¸
                    const testResponse = await fetch('/.netlify/functions/ask-ai', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o',
                            messages: [{ role: 'user', content: 'test' }],
                            max_tokens: 10
                        })
                    });
                    
                    const testResult = {
                        status: testResponse.status,
                        ok: testResponse.ok,
                        browser: browserInfo,
                        timestamp: new Date().toISOString()
                    };
                    
                    console.log('âœ… ë¸Œë¼ìš°ì €ë³„ API ì—°ê²° í…ŒìŠ¤íŠ¸ ê²°ê³¼:', testResult);
                    
                    // í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                    const testHistory = JSON.parse(localStorage.getItem('browserApiTestHistory') || '[]');
                    testHistory.push(testResult);
                    
                    // ìµœê·¼ 10ê°œë§Œ ìœ ì§€
                    if (testHistory.length > 10) {
                        testHistory.splice(0, testHistory.length - 10);
                    }
                    
                    localStorage.setItem('browserApiTestHistory', JSON.stringify(testHistory));
                    
                    return testResult;
                    
                } catch (error) {
                    console.error('âŒ ë¸Œë¼ìš°ì €ë³„ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                    
                    const testResult = {
                        status: 'error',
                        error: error.message,
                        browser: browserInfo,
                        timestamp: new Date().toISOString()
                    };
                    
                    // ì˜¤ë¥˜ ê²°ê³¼ë„ ì €ì¥
                    const testHistory = JSON.parse(localStorage.getItem('browserApiTestHistory') || '[]');
                    testHistory.push(testResult);
                    
                    if (testHistory.length > 10) {
                        testHistory.splice(0, testHistory.length - 10);
                    }
                    
                    localStorage.setItem('browserApiTestHistory', JSON.stringify(testHistory));
                    
                    return testResult;
                }
            }
            
            // í™œì„±í™”ëœ API ì œê³µì ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ OpenAI í™œì„±í™”)
            getActiveProvider() {
                if (this.apiSettings?.openai?.enabled) {
                    return 'openai'; // OpenAIëŠ” í™œì„±í™”ë§Œ ë˜ì–´ìˆìœ¼ë©´ ì‚¬ìš© ê°€ëŠ¥
                } else if (this.apiSettings?.google?.enabled && this.apiSettings.google?.apiKey) {
                    return 'google';
                } else if (this.apiSettings?.anthropic?.enabled && this.apiSettings.anthropic?.apiKey) {
                    return 'anthropic';
                }
                return null;
            }
            
            // ì§€ì‹ë² ì´ìŠ¤ì—ì„œ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ì¶”ì¶œ
            getContextFromKnowledgeBase() {
                if (!this.knowledgeBase.enabled || this.knowledgeBase.parsedData.length === 0) {
                    return '';
                }
                
                // ëª¨ë“  Q&Aë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ ì •ë¦¬
                let context = '\n\n=== ì–‘ë„ì„¸ ì „ë¬¸ ì§€ì‹ ì •ë³´ ===\n';
                this.knowledgeBase.parsedData.forEach((qa, index) => {
                    context += `${index + 1}. Q: ${qa.question}\n   A: ${qa.answer}\n`;
                });
                
                return context;
            }
            
            // ì–¸ì–´ë³„ ì˜ˆì•½ í…ìŠ¤íŠ¸ ë°˜í™˜
            getReservationText() {
                const texts = {
                    ko: {
                        message: 'ìì„¸í•œ ì–‘ë„ì„¸ ìƒë‹´ì€ ì „ë¬¸ ì„¸ë¬´ì‚¬ì™€ ìƒë‹´í•˜ì„¸ìš”!',
                        button: 'ğŸ“ ì„¸ë¬´ì‚¬ ìƒë‹´'
                    },
                    en: {
                        message: 'For detailed capital gains tax consultation, please consult with a tax professional!',
                        button: 'ğŸ“ Tax Professional Consultation'
                    },
                    ru: {
                        message: 'Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ñƒ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°, Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¼Ñƒ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ñƒ!',
                        button: 'ğŸ“ ĞšĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ñ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ğ°'
                    },
                    ja: {
                        message: 'è©³ç´°ãªè­²æ¸¡ç¨ç›¸è«‡ã¯å°‚é–€ç¨ç†å£«ã«ã”ç›¸è«‡ãã ã•ã„ï¼',
                        button: 'ğŸ“ ç¨ç†å£«ç›¸è«‡'
                    }
                };
                
                return texts[this.currentLanguage] || texts['ko'];
            }
            
            // ì–¸ì–´ë³„ ì „ë¬¸ìƒë‹´ì› í…ìŠ¤íŠ¸ ë°˜í™˜
            getConsultantText() {
                const texts = {
                    ko: {
                        message: 'ì „ë¬¸ ì„¸ë¬´ì‚¬ì—ê²Œ 1:1 ì–‘ë„ì„¸ ìƒë‹´ ë°›ì•„ë³´ì„¸ìš”!<br><br>(<strong>ê°€ëŠ¥ì–¸ì–´</strong> í•œêµ­ì–´, ì˜ì–´, ëŸ¬ì‹œì•„ì–´, ì¼ë³¸ì–´)<br><br>(<strong>ìš´ì˜ì‹œê°„</strong> ì˜¤ì „9-ì˜¤í›„9ì‹œ, ì ì‹¬ 12ì‹œ-13ì‹œ)',
                        button: 'ğŸ’¬ ì „ë¬¸ ì„¸ë¬´ì‚¬ 1:1'
                    },
                    en: {
                        message: 'Get 1:1 capital gains tax consultation with a professional tax consultant!<br><br>(<strong>Available Languages</strong> Korean, English, Russian, Japanese)<br><br>(<strong>Operating Hours</strong> 9AM-9PM, Lunch 12PM-1PM)',
                        button: 'ğŸ’¬ Professional Tax Consultant 1:1'
                    },
                    ru: {
                        message: 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚Ğµ Ğ¸Ğ½Ğ´Ğ¸Ğ²Ğ¸Ğ´ÑƒĞ°Ğ»ÑŒĞ½ÑƒÑ ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ñƒ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ° Ñƒ Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ğ½Ñ‚Ğ°!<br><br>(<strong>Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ÑĞ·Ñ‹ĞºĞ¸</strong> ĞºĞ¾Ñ€ĞµĞ¹ÑĞºĞ¸Ğ¹, Ğ°Ğ½Ğ³Ğ»Ğ¸Ğ¹ÑĞºĞ¸Ğ¹, Ñ€ÑƒÑÑĞºĞ¸Ğ¹, ÑĞ¿Ğ¾Ğ½ÑĞºĞ¸Ğ¹)<br><br>(<strong>Ğ§Ğ°ÑÑ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹</strong> 9:00-21:00, ĞĞ±ĞµĞ´ 12:00-13:00)',
                        button: 'ğŸ’¬ ĞŸÑ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ğ½Ñ‚ 1:1'
                    },
                    ja: {
                        message: 'å°‚é–€ç¨ç†å£«ã«1å¯¾1è­²æ¸¡ç¨ç›¸è«‡ã‚’å—ã‘ã¦ãã ã•ã„ï¼<br><br>ï¼ˆ<strong>å¯¾å¿œè¨€èª</strong> éŸ“å›½èªã€è‹±èªã€ãƒ­ã‚·ã‚¢èªã€æ—¥æœ¬èªï¼‰<br><br>ï¼ˆ<strong>å–¶æ¥­æ™‚é–“</strong> åˆå‰9æ™‚-åˆå¾Œ9æ™‚ã€æ˜¼ä¼‘ã¿ 12æ™‚-13æ™‚ï¼‰',
                        button: 'ğŸ’¬ å°‚é–€ç¨ç†å£« 1:1'
                    }
                };
                
                return texts[this.currentLanguage] || texts['ko'];
            }
            
            // API í˜¸ì¶œ í•¨ìˆ˜
            async callAPI(provider, message, contextInfo, useSmartFiltering = false) {
                const settings = this.apiSettings[provider];
                
                switch (provider) {
                    case 'openai':
                        return await this.callOpenAIAPI(message, settings, contextInfo, useSmartFiltering);
                    case 'google':
                        return await this.callGoogleAPI(message, settings, contextInfo, useSmartFiltering);
                    case 'anthropic':
                        return await this.callClaudeAPI(message, settings, contextInfo, useSmartFiltering);
                    default:
                        throw new Error('ì§€ì›í•˜ì§€ ì•ŠëŠ” API ì œê³µìì…ë‹ˆë‹¤.');
                }
            }
            
            // OpenAI API í˜¸ì¶œ
            async callOpenAIAPI(message, settings, contextInfo, useSmartFiltering = false) {
                const systemPrompt = `ë‹¹ì‹ ì€ Tax-Agentì˜ ì „ë¬¸ ì–‘ë„ì„¸ ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. 
                ë§¤ìš° ì¹œì ˆí•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.

                ì–‘ë„ì„¸ ê¸°ë³¸ ì •ë³´:
                â€¢ ì–‘ë„ì†Œë“ì„¸: ìì‚°ì„ ì–‘ë„í•  ë•Œ ë°œìƒí•˜ëŠ” ì†Œë“ì— ëŒ€í•œ ì„¸ê¸ˆ
                â€¢ ê³¼ì„¸ëŒ€ìƒ: ë¶€ë™ì‚°, ì£¼ì‹, í† ì§€, ê±´ë¬¼, ê¸°íƒ€ ìì‚°ì˜ ì–‘ë„
                â€¢ ê³¼ì„¸í‘œì¤€: ì–‘ë„ê°€ì•¡ - ì·¨ë“ê°€ì•¡ - í•„ìš”ê²½ë¹„
                â€¢ ì„¸ìœ¨: ê³¼ì„¸í‘œì¤€ì— ë”°ë¼ 6%~45% (ëˆ„ì§„ì„¸ìœ¨)
                â€¢ ì‹ ê³ ê¸°í•œ: ì–‘ë„ì¼ì´ ì†í•˜ëŠ” ì—°ë„ì˜ ë‹¤ìŒ ì—°ë„ 5ì›” 31ì¼ê¹Œì§€
                â€¢ ì‹ ê³ ë°©ë²•: êµ­ì„¸ì²­ í™ˆíƒìŠ¤ ë˜ëŠ” ì„¸ë¬´ì„œ ë°©ë¬¸

                ì£¼ìš” ì–‘ë„ì„¸ ì¢…ë¥˜:
                â€¢ ë¶€ë™ì‚°ì–‘ë„ì†Œë“ì„¸: ë¶€ë™ì‚°, í† ì§€, ê±´ë¬¼ ì–‘ë„ ì‹œ
                â€¢ ì£¼ì‹ì–‘ë„ì†Œë“ì„¸: ì£¼ì‹, ì§€ë¶„ ì–‘ë„ ì‹œ
                â€¢ ê¸°íƒ€ìì‚°ì–‘ë„ì†Œë“ì„¸: ê¸°íƒ€ ìì‚° ì–‘ë„ ì‹œ

                ë¹„ê³¼ì„¸ ìš”ê±´:
                â€¢ 1ì„¸ëŒ€ 1ì£¼íƒ ë¹„ê³¼ì„¸: ì¡°ê±´ ì¶©ì¡± ì‹œ ìµœëŒ€ 12ì–µì›ê¹Œì§€ ë¹„ê³¼ì„¸
                â€¢ ì¥ê¸°ë³´ìœ íŠ¹ë³„ê³µì œ: ë³´ìœ ê¸°ê°„ì— ë”°ë¼ ê³µì œìœ¨ ì ìš©
                â€¢ ê¸°ë³¸ê³µì œ: ì—°ê°„ 250ë§Œì› ê¸°ë³¸ê³µì œ

                ${contextInfo}

                ë‹µë³€ ì‘ì„± ì›ì¹™:
                1. ë§¤ìš° ì¹œì ˆí•˜ê³  ë”°ëœ»í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”
                2. ì „ë¬¸ì ì´ë©´ì„œë„ ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•˜ì„¸ìš”
                3. êµ¬ì²´ì ì¸ ì •ë³´ë¥¼ ì œê³µí•˜ë˜, ì •í™•í•˜ì§€ ì•Šì€ ì„¸ë¬´ ì¡°ì–¸ì€ í”¼í•˜ì„¸ìš”
                4. ì „ë¬¸ ì„¸ë¬´ì‚¬ ìƒë‹´ì´ í•„ìš”í•œ ê²½ìš° ì ê·¹ ì•ˆë‚´í•˜ì„¸ìš”
                5. ë‹µë³€ì„ êµ¬ì¡°í™”í•˜ì—¬ ì½ê¸° ì‰½ê²Œ ì •ë¦¬í•´ì£¼ì„¸ìš”
                6. ì–‘ë„ì„¸ìœ¨, ì–‘ë„ì„¸ê³„ì‚°, ì–‘ë„ì„¸ì‹ ê³ , ë¹„ê³¼ì„¸ìš”ê±´ ë“± ì£¼ìš” ì§ˆë¬¸ì— ëŒ€í•´ì„œëŠ” ìì—°ìŠ¤ëŸ½ê³  ìƒì„¸í•œ ì„¤ëª…ì„ ì œê³µí•˜ì„¸ìš”
                7. ì‚¬ìš©ìì˜ í¸ì˜ë¥¼ ê³ ë ¤í•œ ì‹¤ìš©ì ì¸ ì¡°ì–¸ì„ í¬í•¨í•´ì£¼ì„¸ìš”
                8. ê³ ê°ì´ ë³´ê¸° í¸í•˜ê²Œ ì •ë¦¬ë˜ì–´ì„œ ë‚˜ê°€ì•¼ í•©ë‹ˆë‹¤
                9. ë‹¨ì–´ì™€ ë¬¸ì¥ì— ì í•©í•œ ì´ëª¨í‹°ì½˜ë„ ì ì ˆíˆ ì‚¬ìš©í•˜ì„¸ìš”
                10. ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”ë¥¼ ì´ì–´ê°€ì„¸ìš”

                ë‹µë³€ í˜•ì‹ ê°€ì´ë“œë¼ì¸ (êµ¬ì¡°í™”ëœ í˜•ì‹):
                - ë©”ì¸ ì œëª©: # ì œëª© (ì˜ˆ: # ì–‘ë„ì„¸ ê¸°ë³¸ ì •ë³´)
                - ë¶€ì œëª©: ## ì œëª© (ì˜ˆ: ## ì–‘ë„ì„¸ ê³„ì‚° ë°©ë²•)
                - ì†Œì œëª©: ### ì œëª© (ì˜ˆ: ### ë¹„ê³¼ì„¸ ìš”ê±´)
                - ì¤‘ìš” ì •ë³´ëŠ” **êµµê²Œ** í‘œì‹œí•˜ì—¬ ê°•ì¡°
                - ë¦¬ìŠ¤íŠ¸ëŠ” â€¢ ë˜ëŠ” ë²ˆí˜¸ë¡œ ì •ë¦¬
                - ì„¹ì…˜ êµ¬ë¶„ì€ === ë˜ëŠ” --- ì‚¬ìš©
                - ì¸ìš©êµ¬ëŠ” > í…ìŠ¤íŠ¸ í˜•íƒœë¡œ ì‘ì„±
                - ê²°ë¡  ì„¹ì…˜ì€ "ê²°ë¡ " ë˜ëŠ” "ìš”ì•½" í‚¤ì›Œë“œë¡œ ì‹œì‘
                - ì „ì²´ì ìœ¼ë¡œ ê³ ê°ì´ ë³´ê¸° í¸í•˜ê³  ì½ê¸° ì‰¬ìš´ í˜•ì‹ìœ¼ë¡œ êµ¬ì„±
                - ê° ì„¹ì…˜ì€ ëª…í™•í•˜ê²Œ êµ¬ë¶„ë˜ì–´ì•¼ í•¨`;

                // ëŒ€í™” ì´ë ¥ ê°€ì ¸ì˜¤ê¸° (ìŠ¤ë§ˆíŠ¸ í•„í„°ë§ ì˜µì…˜)
                const chatHistory = useSmartFiltering ? 
                    this.getSmartFilteredHistory(message) : 
                    this.getChatHistoryForAPI();
                
                // ë©”ì‹œì§€ ë°°ì—´ êµ¬ì„± (ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ + ëŒ€í™” ì´ë ¥ + í˜„ì¬ ë©”ì‹œì§€)
                const messages = [
                    {
                        role: "system",
                        content: systemPrompt
                    },
                    ...chatHistory,
                    {
                        role: "user",
                        content: message
                    }
                ];

                console.log('ğŸ¤– ChatGPT API í˜¸ì¶œ - ëŒ€í™” ì´ë ¥ í¬í•¨:', {
                    historyCount: chatHistory.length,
                    totalMessages: messages.length,
                    currentMessage: message.substring(0, 100) + '...'
                });

                // ë¸Œë¼ìš°ì €ë³„ í˜¸í™˜ì„±ì„ ìœ„í•œ fetch ì˜µì…˜ ì„¤ì •
                const fetchOptions = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // ë¸Œë¼ìš°ì €ë³„ í˜¸í™˜ì„±ì„ ìœ„í•œ ì¶”ê°€ í—¤ë”
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        model: settings.model,
                        messages: messages,
                        max_tokens: 3000,
                        temperature: 0.7
                    })
                };

                // ë¸Œë¼ìš°ì € ê°ì§€ ë° íŠ¹ë³„ ì²˜ë¦¬
                const userAgent = navigator.userAgent;
                const isChrome = /Chrome/.test(userAgent) && !/Edge/.test(userAgent);
                const isEdge = /Edge/.test(userAgent);
                const isFirefox = /Firefox/.test(userAgent);
                const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
                
                console.log('ğŸŒ ë¸Œë¼ìš°ì € ê°ì§€:', {
                    userAgent: userAgent.substring(0, 100),
                    isChrome,
                    isEdge,
                    isFirefox,
                    isSafari
                });

                // Chrome íŠ¹ë³„ ì²˜ë¦¬ (ìºì‹œ ë°©ì§€)
                if (isChrome) {
                    fetchOptions.headers['Cache-Control'] = 'no-cache';
                    fetchOptions.headers['Pragma'] = 'no-cache';
                    console.log('ğŸ”§ Chrome ë¸Œë¼ìš°ì € ê°ì§€ - ìºì‹œ ë°©ì§€ í—¤ë” ì¶”ê°€');
                }

                // Edge íŠ¹ë³„ ì²˜ë¦¬ (íƒ€ì„ì•„ì›ƒ ì„¤ì •)
                if (isEdge) {
                    console.log('ğŸ”§ Edge ë¸Œë¼ìš°ì € ê°ì§€ - íƒ€ì„ì•„ì›ƒ ì„¤ì • ì ìš©');
                }

                try {
                    const response = await fetch('/.netlify/functions/ask-ai', fetchOptions);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    // Edge ë¸Œë¼ìš°ì €ì—ì„œ ë§ˆì§€ë§‰ ë‹¨ì–´ ì¤‘ë³µ ë¬¸ì œ í•´ê²°
                    let content = data.choices[0].message.content;
                    if (isEdge && content) {
                        // ë§ˆì§€ë§‰ ë‹¨ì–´ ì¤‘ë³µ ì œê±° ë¡œì§
                        const words = content.split(' ');
                        if (words.length > 1) {
                            const lastWord = words[words.length - 1];
                            const secondLastWord = words[words.length - 2];
                            if (lastWord === secondLastWord) {
                                words.pop();
                                content = words.join(' ');
                                console.log('ğŸ”§ Edge ë¸Œë¼ìš°ì €: ë§ˆì§€ë§‰ ë‹¨ì–´ ì¤‘ë³µ ì œê±°');
                            }
                        }
                    }
                    
                    return content;
                } catch (error) {
                    console.error('âŒ ChatGPT API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                    
                    // ë¸Œë¼ìš°ì €ë³„ ì˜¤ë¥˜ ë©”ì‹œì§€
                    const browserErrorMessages = {
                        ko: {
                            chrome: 'Chrome ë¸Œë¼ìš°ì €ì—ì„œ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.',
                            edge: 'Edge ë¸Œë¼ìš°ì €ì—ì„œ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.',
                            firefox: 'Firefox ë¸Œë¼ìš°ì €ì—ì„œ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.',
                            safari: 'Safari ë¸Œë¼ìš°ì €ì—ì„œ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.',
                            default: 'ë¸Œë¼ìš°ì €ì—ì„œ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.'
                        }
                    };
                    
                    let errorMessage = browserErrorMessages.ko.default;
                    if (isChrome) errorMessage = browserErrorMessages.ko.chrome;
                    else if (isEdge) errorMessage = browserErrorMessages.ko.edge;
                    else if (isFirefox) errorMessage = browserErrorMessages.ko.firefox;
                    else if (isSafari) errorMessage = browserErrorMessages.ko.safari;
                    
                    throw new Error(errorMessage);
                }
            }
            
            // Google API í˜¸ì¶œ
            async callGoogleAPI(message, settings, contextInfo, useSmartFiltering = false) {
                // ëŒ€í™” ì´ë ¥ ê°€ì ¸ì˜¤ê¸° (ìŠ¤ë§ˆíŠ¸ í•„í„°ë§ ì˜µì…˜)
                const chatHistory = useSmartFiltering ? 
                    this.getSmartFilteredHistory(message) : 
                    this.getChatHistoryForAPI();
                
                // Geminiìš© ëŒ€í™” ì´ë ¥ êµ¬ì„±
                let conversationContext = '';
                if (chatHistory.length > 0) {
                    conversationContext = '\n\n=== ì´ì „ ëŒ€í™” ë‚´ìš© ===\n';
                    chatHistory.forEach((msg, index) => {
                        const role = msg.role === 'user' ? 'ì‚¬ìš©ì' : 'AI ìƒë‹´ì‚¬';
                        conversationContext += `${role}: ${msg.content}\n`;
                    });
                    conversationContext += '\n=== í˜„ì¬ ì§ˆë¬¸ ===\n';
                }

                const prompt = `ë‹¹ì‹ ì€ Tax-Agentì˜ ì „ë¬¸ ì–‘ë„ì„¸ ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. 
                ë§¤ìš° ì¹œì ˆí•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.

                ì–‘ë„ì„¸ ê¸°ë³¸ ì •ë³´:
                â€¢ ì–‘ë„ì†Œë“ì„¸: ìì‚°ì„ ì–‘ë„í•  ë•Œ ë°œìƒí•˜ëŠ” ì†Œë“ì— ëŒ€í•œ ì„¸ê¸ˆ
                â€¢ ê³¼ì„¸ëŒ€ìƒ: ë¶€ë™ì‚°, ì£¼ì‹, í† ì§€, ê±´ë¬¼, ê¸°íƒ€ ìì‚°ì˜ ì–‘ë„
                â€¢ ê³¼ì„¸í‘œì¤€: ì–‘ë„ê°€ì•¡ - ì·¨ë“ê°€ì•¡ - í•„ìš”ê²½ë¹„
                â€¢ ì„¸ìœ¨: ê³¼ì„¸í‘œì¤€ì— ë”°ë¼ 6%~45% (ëˆ„ì§„ì„¸ìœ¨)
                â€¢ ì‹ ê³ ê¸°í•œ: ì–‘ë„ì¼ì´ ì†í•˜ëŠ” ì—°ë„ì˜ ë‹¤ìŒ ì—°ë„ 5ì›” 31ì¼ê¹Œì§€
                â€¢ ì‹ ê³ ë°©ë²•: êµ­ì„¸ì²­ í™ˆíƒìŠ¤ ë˜ëŠ” ì„¸ë¬´ì„œ ë°©ë¬¸

                ì£¼ìš” ì–‘ë„ì„¸ ì¢…ë¥˜:
                â€¢ ë¶€ë™ì‚°ì–‘ë„ì†Œë“ì„¸: ë¶€ë™ì‚°, í† ì§€, ê±´ë¬¼ ì–‘ë„ ì‹œ
                â€¢ ì£¼ì‹ì–‘ë„ì†Œë“ì„¸: ì£¼ì‹, ì§€ë¶„ ì–‘ë„ ì‹œ
                â€¢ ê¸°íƒ€ìì‚°ì–‘ë„ì†Œë“ì„¸: ê¸°íƒ€ ìì‚° ì–‘ë„ ì‹œ

                ë¹„ê³¼ì„¸ ìš”ê±´:
                â€¢ 1ì„¸ëŒ€ 1ì£¼íƒ ë¹„ê³¼ì„¸: ì¡°ê±´ ì¶©ì¡± ì‹œ ìµœëŒ€ 12ì–µì›ê¹Œì§€ ë¹„ê³¼ì„¸
                â€¢ ì¥ê¸°ë³´ìœ íŠ¹ë³„ê³µì œ: ë³´ìœ ê¸°ê°„ì— ë”°ë¼ ê³µì œìœ¨ ì ìš©
                â€¢ ê¸°ë³¸ê³µì œ: ì—°ê°„ 250ë§Œì› ê¸°ë³¸ê³µì œ

                ${contextInfo}

                ë‹µë³€ ì‘ì„± ì›ì¹™:
                1. ë§¤ìš° ì¹œì ˆí•˜ê³  ë”°ëœ»í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”
                2. ì „ë¬¸ì ì´ë©´ì„œë„ ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•˜ì„¸ìš”
                3. êµ¬ì²´ì ì¸ ì •ë³´ë¥¼ ì œê³µí•˜ë˜, ì •í™•í•˜ì§€ ì•Šì€ ì„¸ë¬´ ì¡°ì–¸ì€ í”¼í•˜ì„¸ìš”
                4. ì „ë¬¸ ì„¸ë¬´ì‚¬ ìƒë‹´ì´ í•„ìš”í•œ ê²½ìš° ì ê·¹ ì•ˆë‚´í•˜ì„¸ìš”
                5. ë‹µë³€ì„ êµ¬ì¡°í™”í•˜ì—¬ ì½ê¸° ì‰½ê²Œ ì •ë¦¬í•´ì£¼ì„¸ìš”
                6. ì–‘ë„ì„¸ìœ¨, ì–‘ë„ì„¸ê³„ì‚°, ì–‘ë„ì„¸ì‹ ê³ , ë¹„ê³¼ì„¸ìš”ê±´ ë“± ì£¼ìš” ì§ˆë¬¸ì— ëŒ€í•´ì„œëŠ” ìì—°ìŠ¤ëŸ½ê³  ìƒì„¸í•œ ì„¤ëª…ì„ ì œê³µí•˜ì„¸ìš”
                7. ì‚¬ìš©ìì˜ í¸ì˜ë¥¼ ê³ ë ¤í•œ ì‹¤ìš©ì ì¸ ì¡°ì–¸ì„ í¬í•¨í•´ì£¼ì„¸ìš”
                8. ê³ ê°ì´ ë³´ê¸° í¸í•˜ê²Œ ì •ë¦¬ë˜ì–´ì„œ ë‚˜ê°€ì•¼ í•©ë‹ˆë‹¤
                9. ë‹¨ì–´ì™€ ë¬¸ì¥ì— ì í•©í•œ ì´ëª¨í‹°ì½˜ë„ ì ì ˆíˆ ì‚¬ìš©í•˜ì„¸ìš”
                10. ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”ë¥¼ ì´ì–´ê°€ì„¸ìš”

                ë‹µë³€ í˜•ì‹ ê°€ì´ë“œë¼ì¸ (êµ¬ì¡°í™”ëœ í˜•ì‹):
                - ë©”ì¸ ì œëª©: # ì œëª© (ì˜ˆ: # ì–‘ë„ì„¸ ê¸°ë³¸ ì •ë³´)
                - ë¶€ì œëª©: ## ì œëª© (ì˜ˆ: ## ì–‘ë„ì„¸ ê³„ì‚° ë°©ë²•)
                - ì†Œì œëª©: ### ì œëª© (ì˜ˆ: ### ë¹„ê³¼ì„¸ ìš”ê±´)
                - ì¤‘ìš” ì •ë³´ëŠ” **êµµê²Œ** í‘œì‹œí•˜ì—¬ ê°•ì¡°
                - ë¦¬ìŠ¤íŠ¸ëŠ” â€¢ ë˜ëŠ” ë²ˆí˜¸ë¡œ ì •ë¦¬
                - ì„¹ì…˜ êµ¬ë¶„ì€ === ë˜ëŠ” --- ì‚¬ìš©
                - ì¸ìš©êµ¬ëŠ” > í…ìŠ¤íŠ¸ í˜•íƒœë¡œ ì‘ì„±
                - ê²°ë¡  ì„¹ì…˜ì€ "ê²°ë¡ " ë˜ëŠ” "ìš”ì•½" í‚¤ì›Œë“œë¡œ ì‹œì‘
                - ì „ì²´ì ìœ¼ë¡œ ê³ ê°ì´ ë³´ê¸° í¸í•˜ê³  ì½ê¸° ì‰¬ìš´ í˜•ì‹ìœ¼ë¡œ êµ¬ì„±
                - ê° ì„¹ì…˜ì€ ëª…í™•í•˜ê²Œ êµ¬ë¶„ë˜ì–´ì•¼ í•¨

                ${conversationContext}
                ì§ˆë¬¸: ${message}`;

                console.log('ğŸ¤– Gemini API í˜¸ì¶œ - ëŒ€í™” ì´ë ¥ í¬í•¨:', {
                    historyCount: chatHistory.length,
                    conversationContext: conversationContext.substring(0, 100) + '...',
                    currentMessage: message.substring(0, 100) + '...'
                });

                const response = await fetch('/.netlify/functions/ask-gemini', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: settings.model,
                        prompt: prompt,
                        maxOutputTokens: 3000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            }
            
            // Claude API í˜¸ì¶œ
            async callClaudeAPI(message, settings, contextInfo, useSmartFiltering = false) {
                // ëŒ€í™” ì´ë ¥ ê°€ì ¸ì˜¤ê¸° (ìŠ¤ë§ˆíŠ¸ í•„í„°ë§ ì˜µì…˜)
                const chatHistory = useSmartFiltering ? 
                    this.getSmartFilteredHistory(message) : 
                    this.getChatHistoryForAPI();
                
                // Claudeìš© ëŒ€í™” ì´ë ¥ êµ¬ì„±
                let conversationContext = '';
                if (chatHistory.length > 0) {
                    conversationContext = '\n\n=== ì´ì „ ëŒ€í™” ë‚´ìš© ===\n';
                    chatHistory.forEach((msg, index) => {
                        const role = msg.role === 'user' ? 'ì‚¬ìš©ì' : 'AI ìƒë‹´ì‚¬';
                        conversationContext += `${role}: ${msg.content}\n`;
                    });
                    conversationContext += '\n=== í˜„ì¬ ì§ˆë¬¸ ===\n';
                }

                const prompt = `ë‹¹ì‹ ì€ Tax-Agentì˜ ì „ë¬¸ ì–‘ë„ì„¸ ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. 
                ë§¤ìš° ì¹œì ˆí•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.

                ì–‘ë„ì„¸ ê¸°ë³¸ ì •ë³´:
                â€¢ ì–‘ë„ì†Œë“ì„¸: ìì‚°ì„ ì–‘ë„í•  ë•Œ ë°œìƒí•˜ëŠ” ì†Œë“ì— ëŒ€í•œ ì„¸ê¸ˆ
                â€¢ ê³¼ì„¸ëŒ€ìƒ: ë¶€ë™ì‚°, ì£¼ì‹, í† ì§€, ê±´ë¬¼, ê¸°íƒ€ ìì‚°ì˜ ì–‘ë„
                â€¢ ê³¼ì„¸í‘œì¤€: ì–‘ë„ê°€ì•¡ - ì·¨ë“ê°€ì•¡ - í•„ìš”ê²½ë¹„
                â€¢ ì„¸ìœ¨: ê³¼ì„¸í‘œì¤€ì— ë”°ë¼ 6%~45% (ëˆ„ì§„ì„¸ìœ¨)
                â€¢ ì‹ ê³ ê¸°í•œ: ì–‘ë„ì¼ì´ ì†í•˜ëŠ” ì—°ë„ì˜ ë‹¤ìŒ ì—°ë„ 5ì›” 31ì¼ê¹Œì§€
                â€¢ ì‹ ê³ ë°©ë²•: êµ­ì„¸ì²­ í™ˆíƒìŠ¤ ë˜ëŠ” ì„¸ë¬´ì„œ ë°©ë¬¸

                ì£¼ìš” ì–‘ë„ì„¸ ì¢…ë¥˜:
                â€¢ ë¶€ë™ì‚°ì–‘ë„ì†Œë“ì„¸: ë¶€ë™ì‚°, í† ì§€, ê±´ë¬¼ ì–‘ë„ ì‹œ
                â€¢ ì£¼ì‹ì–‘ë„ì†Œë“ì„¸: ì£¼ì‹, ì§€ë¶„ ì–‘ë„ ì‹œ
                â€¢ ê¸°íƒ€ìì‚°ì–‘ë„ì†Œë“ì„¸: ê¸°íƒ€ ìì‚° ì–‘ë„ ì‹œ

                ë¹„ê³¼ì„¸ ìš”ê±´:
                â€¢ 1ì„¸ëŒ€ 1ì£¼íƒ ë¹„ê³¼ì„¸: ì¡°ê±´ ì¶©ì¡± ì‹œ ìµœëŒ€ 12ì–µì›ê¹Œì§€ ë¹„ê³¼ì„¸
                â€¢ ì¥ê¸°ë³´ìœ íŠ¹ë³„ê³µì œ: ë³´ìœ ê¸°ê°„ì— ë”°ë¼ ê³µì œìœ¨ ì ìš©
                â€¢ ê¸°ë³¸ê³µì œ: ì—°ê°„ 250ë§Œì› ê¸°ë³¸ê³µì œ

                ${contextInfo}

                ë‹µë³€ ì‘ì„± ì›ì¹™:
                1. ë§¤ìš° ì¹œì ˆí•˜ê³  ë”°ëœ»í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”
                2. ì „ë¬¸ì ì´ë©´ì„œë„ ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•˜ì„¸ìš”
                3. êµ¬ì²´ì ì¸ ì •ë³´ë¥¼ ì œê³µí•˜ë˜, ì •í™•í•˜ì§€ ì•Šì€ ì„¸ë¬´ ì¡°ì–¸ì€ í”¼í•˜ì„¸ìš”
                4. ì „ë¬¸ ì„¸ë¬´ì‚¬ ìƒë‹´ì´ í•„ìš”í•œ ê²½ìš° ì ê·¹ ì•ˆë‚´í•˜ì„¸ìš”
                5. ë‹µë³€ì„ êµ¬ì¡°í™”í•˜ì—¬ ì½ê¸° ì‰½ê²Œ ì •ë¦¬í•´ì£¼ì„¸ìš”
                6. ì–‘ë„ì„¸ìœ¨, ì–‘ë„ì„¸ê³„ì‚°, ì–‘ë„ì„¸ì‹ ê³ , ë¹„ê³¼ì„¸ìš”ê±´ ë“± ì£¼ìš” ì§ˆë¬¸ì— ëŒ€í•´ì„œëŠ” ìì—°ìŠ¤ëŸ½ê³  ìƒì„¸í•œ ì„¤ëª…ì„ ì œê³µí•˜ì„¸ìš”
                7. ì‚¬ìš©ìì˜ í¸ì˜ë¥¼ ê³ ë ¤í•œ ì‹¤ìš©ì ì¸ ì¡°ì–¸ì„ í¬í•¨í•´ì£¼ì„¸ìš”
                8. ê³ ê°ì´ ë³´ê¸° í¸í•˜ê²Œ ì •ë¦¬ë˜ì–´ì„œ ë‚˜ê°€ì•¼ í•©ë‹ˆë‹¤
                9. ë‹¨ì–´ì™€ ë¬¸ì¥ì— ì í•©í•œ ì´ëª¨í‹°ì½˜ë„ ì ì ˆíˆ ì‚¬ìš©í•˜ì„¸ìš”
                10. ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”ë¥¼ ì´ì–´ê°€ì„¸ìš”

                ë‹µë³€ í˜•ì‹ ê°€ì´ë“œë¼ì¸ (êµ¬ì¡°í™”ëœ í˜•ì‹):
                - ë©”ì¸ ì œëª©: # ì œëª© (ì˜ˆ: # ì–‘ë„ì„¸ ê¸°ë³¸ ì •ë³´)
                - ë¶€ì œëª©: ## ì œëª© (ì˜ˆ: ## ì–‘ë„ì„¸ ê³„ì‚° ë°©ë²•)
                - ì†Œì œëª©: ### ì œëª© (ì˜ˆ: ### ë¹„ê³¼ì„¸ ìš”ê±´)
                - ì¤‘ìš” ì •ë³´ëŠ” **êµµê²Œ** í‘œì‹œí•˜ì—¬ ê°•ì¡°
                - ë¦¬ìŠ¤íŠ¸ëŠ” â€¢ ë˜ëŠ” ë²ˆí˜¸ë¡œ ì •ë¦¬
                - ì„¹ì…˜ êµ¬ë¶„ì€ === ë˜ëŠ” --- ì‚¬ìš©
                - ì¸ìš©êµ¬ëŠ” > í…ìŠ¤íŠ¸ í˜•íƒœë¡œ ì‘ì„±
                - ê²°ë¡  ì„¹ì…˜ì€ "ê²°ë¡ " ë˜ëŠ” "ìš”ì•½" í‚¤ì›Œë“œë¡œ ì‹œì‘
                - ì „ì²´ì ìœ¼ë¡œ ê³ ê°ì´ ë³´ê¸° í¸í•˜ê³  ì½ê¸° ì‰¬ìš´ í˜•ì‹ìœ¼ë¡œ êµ¬ì„±
                - ê° ì„¹ì…˜ì€ ëª…í™•í•˜ê²Œ êµ¬ë¶„ë˜ì–´ì•¼ í•¨

                ${conversationContext}
                ì§ˆë¬¸: ${message}`;

                console.log('ğŸ¤– Claude API í˜¸ì¶œ - ëŒ€í™” ì´ë ¥ í¬í•¨:', {
                    historyCount: chatHistory.length,
                    conversationContext: conversationContext.substring(0, 100) + '...',
                    currentMessage: message.substring(0, 100) + '...'
                });

                const response = await fetch('/.netlify/functions/ask-claude', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: settings.model,
                        max_tokens: 3000,
                        messages: [{
                            role: "user",
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                return data.content[0].text;
            }
            
            // AI ì‘ë‹µ í¬ë§·íŒ…
            formatAIResponse(response, provider) {
                const reservationText = this.getReservationText();
                const consultantText = this.getConsultantText();
                
                // AI ë‹µë³€ì„ ê¹”ë”í•˜ê²Œ ì •ë¦¬
                const formattedResponse = this.formatAIResponseContent(response);
                
                return `${formattedResponse}
                
                <div class="reservation-message">
                    <div class="reservation-message-text">${consultantText.message}</div>
                    <button class="reservation-button" onclick="window.open('http://pf.kakao.com/_DiIin/chat', '_blank')">${consultantText.button}</button>
                </div>
                <div class="reservation-message">
                    <div class="reservation-message-text">${reservationText.message}</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                </div>`;
            }
            
            // AI ì‘ë‹µ ë‚´ìš© í¬ë§·íŒ… (êµ¬ì¡°í™”ëœ í˜•ì‹)
            formatAIResponseContent(response) {
                // ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
                let formatted = response.replace(/\n/g, '<br>');
                
                // ê°•ì¡° í…ìŠ¤íŠ¸ ì²˜ë¦¬ (**í…ìŠ¤íŠ¸** -> <strong>í…ìŠ¤íŠ¸</strong>)
                formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                // ë¦¬ìŠ¤íŠ¸ í•­ëª© ì²˜ë¦¬ (â€¢ ë˜ëŠ” - ë¡œ ì‹œì‘í•˜ëŠ” ì¤„)
                formatted = formatted.replace(/^[â€¢\-]\s*(.*?)$/gm, '<div style="margin: 8px 0; padding-left: 20px; line-height: 1.6;">â€¢ $1</div>');
                
                // ë²ˆí˜¸ê°€ ìˆëŠ” ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬ (1. 2. ë“±)
                formatted = formatted.replace(/^(\d+)\.\s*(.*?)$/gm, '<div style="margin: 8px 0; padding-left: 20px; line-height: 1.6;">$1. $2</div>');
                
                // ì„¹ì…˜ êµ¬ë¶„ì„  ì²˜ë¦¬ (=== ë˜ëŠ” ---) - ë” ëˆˆì— ë„ëŠ” êµ¬ë¶„ì„ ìœ¼ë¡œ ë³€ê²½
                formatted = formatted.replace(/^={3,}$/gm, '<div style="height: 2px; background: linear-gradient(90deg, #4facfe, #00f2fe); margin: 20px 0; border-radius: 1px;"></div>');
                formatted = formatted.replace(/^-{3,}$/gm, '<div style="height: 1px; background: #e9ecef; margin: 15px 0;"></div>');
                
                // ì œëª© ì²˜ë¦¬ (### ì œëª©) - ë” ê°•ì¡°ëœ ìŠ¤íƒ€ì¼
                formatted = formatted.replace(/^###\s*(.*?)$/gm, '<div style="font-size: 16px; font-weight: bold; color: #2c3e50; margin: 20px 0 12px 0; padding: 8px 12px; background: #f8f9fa; border-left: 4px solid #4facfe; border-radius: 4px;">ğŸ“‹ $1</div>');
                
                // ë¶€ì œëª© ì²˜ë¦¬ (## ì œëª©) - ë” ê°•ì¡°ëœ ìŠ¤íƒ€ì¼
                formatted = formatted.replace(/^##\s*(.*?)$/gm, '<div style="font-size: 18px; font-weight: bold; color: #2c3e50; margin: 25px 0 15px 0; padding: 10px 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 6px;">ğŸ’¡ $1</div>');
                
                // ë©”ì¸ ì œëª© ì²˜ë¦¬ (# ì œëª©) - ë” ê°•ì¡°ëœ ìŠ¤íƒ€ì¼
                formatted = formatted.replace(/^#\s*(.*?)$/gm, '<div style="font-size: 20px; font-weight: bold; color: #2c3e50; margin: 30px 0 20px 0; padding: 15px 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border-radius: 8px; text-align: center;">ğŸ’° $1</div>');
                
                // ì¸ìš©êµ¬ ì²˜ë¦¬ (> í…ìŠ¤íŠ¸) - ë” ëˆˆì— ë„ëŠ” ë°•ìŠ¤ë¡œ ë³€ê²½
                formatted = formatted.replace(/^>\s*(.*?)$/gm, '<div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 15px 20px; margin: 15px 0; border-radius: 8px; border-left: 5px solid #4facfe; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">ğŸ’¬ $1</div>');
                
                // ì½”ë“œ ë¸”ë¡ ì²˜ë¦¬ (```ì½”ë“œ```) - ì œê±°
                formatted = formatted.replace(/```(.*?)```/gs, '');
                
                // ì¸ë¼ì¸ ì½”ë“œ ì²˜ë¦¬ (`ì½”ë“œ`) - ì œê±°
                formatted = formatted.replace(/`(.*?)`/g, '$1');
                
                // í° ê´„í˜¸ë¡œ ê°ì‹¸ì§„ í…ìŠ¤íŠ¸ ê°•ì¡° ì²˜ë¦¬
                formatted = formatted.replace(/\((.*?)\)/g, '<span style="color: #4facfe; font-weight: 600;">($1)</span>');
                
                // ê²°ë¡  ì„¹ì…˜ ê°•ì¡° ì²˜ë¦¬ (ê²°ë¡ , ìš”ì•½, ë§ˆë¬´ë¦¬ ë“±ì˜ í‚¤ì›Œë“œ)
                formatted = formatted.replace(/(ê²°ë¡ |ìš”ì•½|ë§ˆë¬´ë¦¬|ì •ë¦¬|ë§ˆì§€ë§‰|ë§ˆì§€ë§‰ìœ¼ë¡œ|ìš”ì•½í•˜ë©´|ì •ë¦¬í•˜ë©´|ê²°ë¡ ì ìœ¼ë¡œ)/gi, '<div style="font-size: 16px; font-weight: bold; color: #2c3e50; margin: 20px 0 12px 0; padding: 10px 15px; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-radius: 6px; border-left: 4px solid #ffc107;">ğŸ¯ $1</div>');
                
                return formatted;
            }
            
            // AI ì‘ë‹µ ìƒì„±
            async generateAIResponse(message, useSmartFiltering = false) {
                const loadingMessages = {
                    ko: 'ğŸ’° Tax-Agent ì–‘ë„ì„¸ ì „ë¬¸ ìƒë‹´ì‚¬ê°€ ë‹µë³€ì„ ì¤€ë¹„ ì¤‘ ì…ë‹ˆë‹¤...â°<span class="loading-dots"></span>',
                    en: 'ğŸ’° Tax-Agent capital gains tax specialist is preparing an answer...â°<span class="loading-dots"></span>',
                    ru: 'ğŸ’° Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ñƒ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ° Tax-Agent Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚...â°<span class="loading-dots"></span>',
                    ja: 'ğŸ’° Tax-Agentè­²æ¸¡ç¨å°‚é–€ç›¸è«‡å“¡ãŒå›ç­”ã‚’æº–å‚™ä¸­ã§ã™...â°<span class="loading-dots"></span>'
                };
                
                const loadingMessage = this.addBotMessage(loadingMessages[this.currentLanguage] || loadingMessages['ko']);
                
                try {
                    // API í˜¸ì¶œ ë¡œì§
                    const activeProvider = this.getActiveProvider();
                    const contextInfo = this.getContextFromKnowledgeBase();
                    
                    // ìŠ¤ë§ˆíŠ¸ í•„í„°ë§ ì˜µì…˜ ì „ë‹¬
                    const response = await this.callAPI(activeProvider, message, contextInfo, useSmartFiltering);
                    this.removeMessage(loadingMessage);
                    this.addBotMessage(this.formatAIResponse(response, activeProvider));
                } catch (error) {
                    console.error('AI API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                    this.removeMessage(loadingMessage);
                    
                    // ì˜¤ë¥˜ ìœ í˜•ë³„ ìƒì„¸ ë©”ì‹œì§€
                    let errorMessage = '';
                    if (error.message.includes('API key not configured')) {
                        errorMessage = {
                            ko: 'ğŸ”‘ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.',
                            en: 'ğŸ”‘ API key is not configured. Please set up API key in admin page.',
                            ru: 'ğŸ”‘ ĞšĞ»ÑÑ‡ API Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ ĞºĞ»ÑÑ‡ API Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°.',
                            ja: 'ğŸ”‘ APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ãƒšãƒ¼ã‚¸ã§APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚'
                        };
                    } else if (error.message.includes('rate limit') || error.message.includes('quota')) {
                        errorMessage = {
                            ko: 'â° API ì‚¬ìš© í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                            en: 'â° API rate limit exceeded. Please try again later.',
                            ru: 'â° ĞŸÑ€ĞµĞ²Ñ‹ÑˆĞµĞ½ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ API. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.',
                            ja: 'â° APIä½¿ç”¨åˆ¶é™ã‚’è¶…éã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚'
                        };
                    } else if (error.message.includes('network') || error.message.includes('fetch')) {
                        errorMessage = {
                            ko: 'ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜ì…ë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.',
                            en: 'ğŸŒ Network connection error. Please check your internet connection.',
                            ru: 'ğŸŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚ĞµĞ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚Ñƒ.',
                            ja: 'ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼ã§ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
                        };
                    } else {
                        errorMessage = {
                            ko: 'ğŸ¤– AI API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤.',
                            en: 'ğŸ¤– An error occurred while calling AI API. Providing default answer.',
                            ru: 'ğŸ¤– ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğµ Ğ˜Ğ˜ API. ĞŸÑ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚.',
                            ja: 'ğŸ¤– AI APIå‘¼ã³å‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå›ç­”ã‚’æä¾›ã—ã¾ã™ã€‚'
                        };
                    }
                    
                    this.addBotMessage(errorMessage[this.currentLanguage] || errorMessage['ko']);
                    const fallbackResponse = this.generateSimulatedResponse(message);
                    this.addBotMessage(fallbackResponse);
                }
            }
            
            // ì‹œë®¬ë ˆì´ì…˜ëœ ì‘ë‹µ ìƒì„± (ë” ìì—°ìŠ¤ëŸ½ê²Œ)
            generateSimulatedResponse(message) {
                const responses = {
                    ko: [
                        `ì•ˆë…•í•˜ì„¸ìš”! "${message}"ì— ëŒ€í•œ ë‹µë³€ì„ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`,
                        'Tax-Agent ì–‘ë„ì„¸ ì „ë¬¸ ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ë” ìì„¸í•œ ìƒë‹´ì´ í•„ìš”í•˜ì‹œë©´ ì–¸ì œë“  ì—°ë½ì£¼ì„¸ìš”!',
                        'ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–‘ë„ì„¸ìœ¨, ì–‘ë„ì„¸ê³„ì‚°, ì–‘ë„ì„¸ì‹ ê³ , ë¹„ê³¼ì„¸ìš”ê±´ ë“±ì„ ì…ë ¥í•´ë³´ì„¸ìš”.'
                    ],
                    en: [
                        `Hello! I'll help you with an answer about "${message}".`,
                        'I am Tax-Agent capital gains tax specialist. Please contact us anytime if you need more detailed consultation!',
                        'If you have any questions, please try entering capital gains tax rates, tax calculation, tax filing, exemption requirements, etc.'
                    ],
                    ru: [
                        `Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ! Ğ¯ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ñƒ Ğ²Ğ°Ğ¼ Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ¼ Ğ½Ğ° "${message}".`,
                        'Ğ¯ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ñƒ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ° Tax-Agent. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¾Ğ±Ñ€Ğ°Ñ‰Ğ°Ğ¹Ñ‚ĞµÑÑŒ Ğ² Ğ»ÑĞ±Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ, ĞµÑĞ»Ğ¸ Ğ²Ğ°Ğ¼ Ğ½ÑƒĞ¶Ğ½Ğ° Ğ±Ğ¾Ğ»ĞµĞµ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ°Ñ ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ñ!',
                        'Ğ•ÑĞ»Ğ¸ Ñƒ Ğ²Ğ°Ñ ĞµÑÑ‚ÑŒ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ²Ğ²ĞµÑÑ‚Ğ¸ ÑÑ‚Ğ°Ğ²ĞºĞ¸ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°, Ñ€Ğ°ÑÑ‡ĞµÑ‚ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ°, Ğ¿Ğ¾Ğ´Ğ°Ñ‡Ñƒ Ğ´ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ğ¸, Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğº Ğ»ÑŒĞ³Ğ¾Ñ‚Ğ°Ğ¼ Ğ¸ Ñ‚.Ğ´.'
                    ],
                    ja: [
                        `ã“ã‚“ã«ã¡ã¯ï¼"${message}"ã«ã¤ã„ã¦ã®å›ç­”ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚`,
                        'Tax-Agentè­²æ¸¡ç¨å°‚é–€ç›¸è«‡å“¡ã§ã™ã€‚ã‚ˆã‚Šè©³ç´°ãªç›¸è«‡ãŒå¿…è¦ã§ã—ãŸã‚‰ã€ã„ã¤ã§ã‚‚ã”é€£çµ¡ãã ã•ã„ï¼',
                        'ã”è³ªå•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€è­²æ¸¡ç¨ç‡ã€è­²æ¸¡ç¨è¨ˆç®—ã€è­²æ¸¡ç¨ç”³å‘Šã€éèª²ç¨è¦ä»¶ãªã©ã‚’å…¥åŠ›ã—ã¦ã¿ã¦ãã ã•ã„ã€‚'
                    ]
                };
                
                const quickMenu = {
                    ko: {
                        title: 'ğŸ’¡ <strong>ë¹ ë¥¸ ì–‘ë„ì„¸ ë¬¸ì˜ ë©”ë‰´</strong>',
                        capitalGainsTax: 'â€¢ "ì–‘ë„ì„¸" - ì–‘ë„ì†Œë“ì„¸ ê¸°ë³¸ ì •ë³´',
                        taxCalculation: 'â€¢ "ì–‘ë„ì„¸ê³„ì‚°" - ì–‘ë„ì„¸ ê³„ì‚° ë°©ë²•',
                        taxFiling: 'â€¢ "ì–‘ë„ì„¸ì‹ ê³ " - ì–‘ë„ì„¸ ì‹ ê³  ë°©ë²•',
                        taxExemption: 'â€¢ "ë¹„ê³¼ì„¸ìš”ê±´" - ì–‘ë„ì„¸ ë¹„ê³¼ì„¸ ìš”ê±´',
                        directInquiry: 'ğŸ“ <strong>ì§ì ‘ ë¬¸ì˜:</strong> 070-1234-1234'
                    },
                    en: {
                        title: 'ğŸ’¡ <strong>Quick Capital Gains Tax Inquiry Menu</strong>',
                        capitalGainsTax: 'â€¢ "Capital Gains Tax" - Basic capital gains tax information',
                        taxCalculation: 'â€¢ "Tax Calculation" - How to calculate capital gains tax',
                        taxFiling: 'â€¢ "Tax Filing" - How to file capital gains tax',
                        taxExemption: 'â€¢ "Exemption Requirements" - Capital gains tax exemption requirements',
                        directInquiry: 'ğŸ“ <strong>Direct Inquiry:</strong> 070-1234-1234'
                    },
                    ru: {
                        title: 'ğŸ’¡ <strong>Ğ‘Ñ‹ÑÑ‚Ñ€Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ñƒ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°</strong>',
                        capitalGainsTax: 'â€¢ "ĞĞ°Ğ»Ğ¾Ğ³ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°" - ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğµ',
                        taxCalculation: 'â€¢ "Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ°" - ĞšĞ°Ğº Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ½Ğ°Ğ»Ğ¾Ğ³ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°',
                        taxFiling: 'â€¢ "ĞŸĞ¾Ğ´Ğ°Ñ‡Ğ° Ğ´ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ğ¸" - ĞšĞ°Ğº Ğ¿Ğ¾Ğ´Ğ°Ñ‚ÑŒ Ğ´ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ñƒ',
                        taxExemption: 'â€¢ "Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğº Ğ»ÑŒĞ³Ğ¾Ñ‚Ğ°Ğ¼" - Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğº Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ°',
                        directInquiry: 'ğŸ“ <strong>ĞŸÑ€ÑĞ¼Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ:</strong> 070-1234-1234'
                    },
                    ja: {
                        title: 'ğŸ’¡ <strong>ã‚¯ã‚¤ãƒƒã‚¯è­²æ¸¡ç¨å•ã„åˆã‚ã›ãƒ¡ãƒ‹ãƒ¥ãƒ¼</strong>',
                        capitalGainsTax: 'â€¢ "è­²æ¸¡ç¨" - è­²æ¸¡æ‰€å¾—ç¨åŸºæœ¬æƒ…å ±',
                        taxCalculation: 'â€¢ "è­²æ¸¡ç¨è¨ˆç®—" - è­²æ¸¡ç¨è¨ˆç®—æ–¹æ³•',
                        taxFiling: 'â€¢ "è­²æ¸¡ç¨ç”³å‘Š" - è­²æ¸¡ç¨ç”³å‘Šæ–¹æ³•',
                        taxExemption: 'â€¢ "éèª²ç¨è¦ä»¶" - è­²æ¸¡ç¨éèª²ç¨è¦ä»¶',
                        directInquiry: 'ğŸ“ <strong>ç›´æ¥å•ã„åˆã‚ã›:</strong> 070-1234-1234'
                    }
                };
                
                const apiStatus = {
                    ko: this.hasActiveAPI() ? 
                        'ğŸ¤– AI APIê°€ ì—°ê²°ë˜ì–´ ìˆì–´ ë” ì •í™•í•œ ë‹µë³€ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' : 
                        'âŒ AI APIê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ê¸°ë³¸ ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤. (ê´€ë¦¬ì ë©”ë‰´ì—ì„œ AI API ì„¤ì • ê°€ëŠ¥)',
                    en: this.hasActiveAPI() ? 
                        'ğŸ¤– AI API is connected and can provide more accurate answers.' : 
                        'âŒ AI API is not set up, providing basic answers. (AI API can be set up in admin menu)',
                    ru: this.hasActiveAPI() ? 
                        'ğŸ¤– Ğ˜Ğ˜ API Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½ Ğ¸ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ğ»ĞµĞµ Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹.' : 
                        'âŒ Ğ˜Ğ˜ API Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½, Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑÑÑ‚ÑÑ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹. (Ğ˜Ğ˜ API Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ² Ğ¼ĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°)',
                    ja: this.hasActiveAPI() ? 
                        'ğŸ¤– AI APIãŒæ¥ç¶šã•ã‚Œã¦ãŠã‚Šã€ã‚ˆã‚Šæ­£ç¢ºãªå›ç­”ã‚’æä¾›ã§ãã¾ã™ã€‚' : 
                        'âŒ AI APIãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€åŸºæœ¬çš„ãªå›ç­”ã‚’æä¾›ã—ã¾ã™ã€‚ï¼ˆç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§AI APIè¨­å®šå¯èƒ½ï¼‰'
                };
                
                const currentResponses = responses[this.currentLanguage] || responses['ko'];
                const currentQuickMenu = quickMenu[this.currentLanguage] || quickMenu['ko'];
                const currentApiStatus = apiStatus[this.currentLanguage] || apiStatus['ko'];
                const reservationText = this.getReservationText();
                
                return currentResponses[Math.floor(Math.random() * currentResponses.length)] + `
                
<div style="margin: 15px 0;">
${currentQuickMenu.title}
</div>

<div style="margin: 10px 0;">
${currentQuickMenu.capitalGainsTax}
${currentQuickMenu.taxCalculation}
${currentQuickMenu.taxFiling}
${currentQuickMenu.taxExemption}
</div>

<div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #4facfe;">
${currentApiStatus}
</div>

<div style="margin: 15px 0;">
${currentQuickMenu.directInquiry}
</div>

<div class="reservation-message">
    <div class="reservation-message-text">${reservationText.message}</div>
    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
</div>`;
            }
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addUserMessage(message) {
                const messagesContainer = document.getElementById('chatbotMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user';
                messageDiv.innerHTML = `
                    <div class="message-avatar">ğŸ‘¤</div>
                    <div class="message-content">${this.escapeHtml(message)}</div>
                `;
                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                // ëŒ€í™” ì´ë ¥ì— ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
                this.addToChatHistory('user', message);
            }
            
            // ë´‡ ë©”ì‹œì§€ ì¶”ê°€
            addBotMessage(message) {
                const messagesContainer = document.getElementById('chatbotMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';
                messageDiv.innerHTML = `
                    <div class="message-avatar">ğŸ’°</div>
                    <div class="message-content">${message}</div>
                `;
                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                // ëŒ€í™” ì´ë ¥ì— ë´‡ ë©”ì‹œì§€ ì¶”ê°€ (HTML íƒœê·¸ ì œê±°)
                const cleanMessage = this.stripHtmlTags(message);
                this.addToChatHistory('assistant', cleanMessage);
                
                return messageDiv;
            }
            
            // ëŒ€í™” ì´ë ¥ì— ë©”ì‹œì§€ ì¶”ê°€
            addToChatHistory(role, content) {
                this.chatHistory.push({
                    role: role,
                    content: content,
                    timestamp: Date.now()
                });
                
                // ìµœëŒ€ ì´ë ¥ ê°œìˆ˜ ì œí•œ
                if (this.chatHistory.length > this.MAX_HISTORY * 2) {
                    this.chatHistory = this.chatHistory.slice(-this.MAX_HISTORY * 2);
                }
                
                console.log(`ğŸ’¬ ëŒ€í™” ì´ë ¥ ì¶”ê°€: ${role} - ${content.substring(0, 50)}...`);
            }
            
            // HTML íƒœê·¸ ì œê±°
            stripHtmlTags(html) {
                const div = document.createElement('div');
                div.innerHTML = html;
                return div.textContent || div.innerText || '';
            }
            
            // AI APIìš© ëŒ€í™” ì´ë ¥ ê°€ì ¸ì˜¤ê¸° (í† í° í•œë„ ìµœì í™”)
            getChatHistoryForAPI() {
                // í† í° í•œë„ë¥¼ ê³ ë ¤í•˜ì—¬ ëŒ€í™” ì´ë ¥ ì œí•œ
                const maxHistoryForAPI = Math.min(this.MAX_HISTORY, 10); // ìµœëŒ€ 10ê°œë¡œ ì œí•œ
                const recentHistory = this.chatHistory.slice(-maxHistoryForAPI);
                
                // ê° ë©”ì‹œì§€ì˜ ê¸¸ì´ë¥¼ í™•ì¸í•˜ê³  ë„ˆë¬´ ê¸´ ë©”ì‹œì§€ëŠ” ì¶•ì•½
                const optimizedHistory = recentHistory.map(msg => {
                    let content = msg.content;
                    
                    // ë©”ì‹œì§€ê°€ ë„ˆë¬´ ê¸¸ë©´ ì¶•ì•½ (HTML íƒœê·¸ ì œê±° í›„ ê¸¸ì´ í™•ì¸)
                    const plainText = this.stripHtmlTags(content);
                    if (plainText.length > 500) {
                        content = plainText.substring(0, 500) + '...';
                    }
                    
                    return {
                        role: msg.role,
                        content: content
                    };
                });
                
                console.log(`ğŸ“ APIìš© ëŒ€í™” ì´ë ¥ ìµœì í™”: ${recentHistory.length}ê°œ â†’ ${optimizedHistory.length}ê°œ`);
                
                return optimizedHistory;
            }
            
            // ëŒ€í™” ì´ë ¥ ì´ˆê¸°í™”
            clearChatHistory() {
                this.chatHistory = [];
                console.log('ğŸ—‘ï¸ ëŒ€í™” ì´ë ¥ ì´ˆê¸°í™” ì™„ë£Œ');
            }
            
            // HTML ì´ìŠ¤ì¼€ì´í”„
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // ë©”ì‹œì§€ ì œê±°
            removeMessage(messageElement) {
                if (messageElement && messageElement.parentNode) {
                    messageElement.parentNode.removeChild(messageElement);
                }
            }
            
            // ìŠ¤í¬ë¡¤ í•˜ë‹¨ ì´ë™
            scrollToBottom() {
                const messagesContainer = document.getElementById('chatbotMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€
            addWelcomeMessage() {
                const t = this.translations[this.currentLanguage];
                
                const quickButtons = {
                    ko: {
                        capitalGainsTax: { text: 'ğŸ’° ì–‘ë„ì„¸', message: 'ì–‘ë„ì„¸ ê¸°ë³¸ ì •ë³´ ì•Œë ¤ì£¼ì„¸ìš”' },
                        taxCalculation: { text: 'ğŸ§® ì–‘ë„ì„¸ê³„ì‚°', message: 'ì–‘ë„ì„¸ ê³„ì‚° ë°©ë²• ê¶ê¸ˆí•´ìš”' },
                        taxFiling: { text: 'ğŸ“‹ ì–‘ë„ì„¸ì‹ ê³ ', message: 'ì–‘ë„ì„¸ ì‹ ê³  ë°©ë²• ì•Œë ¤ì£¼ì„¸ìš”' },
                        taxExemption: { text: 'âœ… ë¹„ê³¼ì„¸ìš”ê±´', message: 'ì–‘ë„ì„¸ ë¹„ê³¼ì„¸ ìš”ê±´ ê¶ê¸ˆí•´ìš”' }
                    },
                    en: {
                        capitalGainsTax: { text: 'ğŸ’° Capital Gains Tax', message: 'Tell me about capital gains tax basics' },
                        taxCalculation: { text: 'ğŸ§® Tax Calculation', message: 'I want to know how to calculate capital gains tax' },
                        taxFiling: { text: 'ğŸ“‹ Tax Filing', message: 'Tell me how to file capital gains tax' },
                        taxExemption: { text: 'âœ… Exemption Requirements', message: 'I want to know about exemption requirements' }
                    },
                    ru: {
                        capitalGainsTax: { text: 'ğŸ’° ĞĞ°Ğ»Ğ¾Ğ³ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°', message: 'Ğ Ğ°ÑÑĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¾Ğ± Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ñ… Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°' },
                        taxCalculation: { text: 'ğŸ§® Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ°', message: 'Ğ¥Ğ¾Ñ‡Ñƒ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ ĞºĞ°Ğº Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ½Ğ°Ğ»Ğ¾Ğ³ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°' },
                        taxFiling: { text: 'ğŸ“‹ ĞŸĞ¾Ğ´Ğ°Ñ‡Ğ° Ğ´ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ğ¸', message: 'Ğ Ğ°ÑÑĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ°Ğº Ğ¿Ğ¾Ğ´Ğ°Ñ‚ÑŒ Ğ´ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ñƒ' },
                        taxExemption: { text: 'âœ… Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğº Ğ»ÑŒĞ³Ğ¾Ñ‚Ğ°Ğ¼', message: 'Ğ¥Ğ¾Ñ‡Ñƒ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ Ğ¾ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸ÑÑ… Ğº Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ°' }
                    },
                    ja: {
                        capitalGainsTax: { text: 'ğŸ’° è­²æ¸¡ç¨', message: 'è­²æ¸¡ç¨ã®åŸºæœ¬æƒ…å ±ã‚’æ•™ãˆã¦ãã ã•ã„' },
                        taxCalculation: { text: 'ğŸ§® è­²æ¸¡ç¨è¨ˆç®—', message: 'è­²æ¸¡ç¨ã®è¨ˆç®—æ–¹æ³•ã‚’çŸ¥ã‚ŠãŸã„ã§ã™' },
                        taxFiling: { text: 'ğŸ“‹ è­²æ¸¡ç¨ç”³å‘Š', message: 'è­²æ¸¡ç¨ã®ç”³å‘Šæ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„' },
                        taxExemption: { text: 'âœ… éèª²ç¨è¦ä»¶', message: 'è­²æ¸¡ç¨ã®éèª²ç¨è¦ä»¶ã‚’çŸ¥ã‚ŠãŸã„ã§ã™' }
                    }
                };
                
                const currentButtons = quickButtons[this.currentLanguage] || quickButtons['ko'];
                
                const welcomeMessage = `
                    <div style="text-align: center; color: #333;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #2c3e50;">
                            ${t.welcomeMessage}
                        </div>
                        <div style="font-size: 14px; color: #666; line-height: 1.5; margin-bottom: 15px;">
                            ${t.welcomeSubMessage}
                        </div>
                        <div class="quick-buttons">
                            <button class="quick-button clinic-hours-btn" onclick="chatbot.handleQuickMessage('${currentButtons.capitalGainsTax.message}')">
                                ${currentButtons.capitalGainsTax.text}
                            </button>
                            <button class="quick-button treatment-cost-btn" onclick="chatbot.handleQuickMessage('${currentButtons.taxCalculation.message}')">
                                ${currentButtons.taxCalculation.text}
                            </button>
                            <button class="quick-button reservation-btn" onclick="chatbot.handleQuickMessage('${currentButtons.taxFiling.message}')">
                                ${currentButtons.taxFiling.text}
                            </button>
                            <button class="quick-button directions-btn" onclick="chatbot.handleQuickMessage('${currentButtons.taxExemption.message}')">
                                ${currentButtons.taxExemption.text}
                            </button>
                        </div>
                    </div>
                `;
                
                this.addBotMessage(welcomeMessage);
            }
            
            // ë¹ ë¥¸ ë©”ì‹œì§€ ì²˜ë¦¬
            handleQuickMessage(message) {
                console.log('âš¡ ë¹ ë¥¸ ë©”ì‹œì§€:', message);
                this.addUserMessage(message);
                this.processMessage(message);
            }
            
                    // ì–¸ì–´ UI ì—…ë°ì´íŠ¸
        updateLanguageUI() {
            const t = this.translations[this.currentLanguage];
            
            document.querySelector('.chatbot-title').textContent = t.title;
            document.getElementById('chatbotInput').placeholder = t.placeholder;
            document.querySelector('.chatbot-send').textContent = t.sendButton;
            document.getElementById('currentLanguageText').textContent = t.currentLanguage;
            
            // ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-lang') === this.currentLanguage) {
                    option.classList.add('active');
                }
            });
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        setupEventListeners() {
            // ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡ ë¸Œë¼ìš°ì € ìµœì í™”ëœ ë“œë¡­ë‹¤ìš´ ì²˜ë¦¬
            this.setupLanguageDropdown();
            
            // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸° (ì•ˆë“œë¡œì´ë“œ ìµœì í™”)
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.language-dropdown')) {
                    this.closeLanguageMenu();
                }
            });
            
            // í„°ì¹˜ ì´ë²¤íŠ¸ë¡œ ì™¸ë¶€ í´ë¦­ ê°ì§€ (ì•ˆë“œë¡œì´ë“œ ëŒ€ì‘)
            document.addEventListener('touchend', (e) => {
                if (!e.target.closest('.language-dropdown')) {
                    this.closeLanguageMenu();
                }
            });
        }
        
        // ì–¸ì–´ ë“œë¡­ë‹¤ìš´ ì„¤ì • (ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡ ë¸Œë¼ìš°ì € ìµœì í™”)
        setupLanguageDropdown() {
            const languageButton = document.querySelector('.language-current');
            const languageMenu = document.getElementById('languageMenu');
            
            if (!languageButton || !languageMenu) return;
            
            // ë¸Œë¼ìš°ì € ê°ì§€
            const userAgent = navigator.userAgent;
            const isAndroidKakao = /Android/.test(userAgent) && /KAKAO/.test(userAgent);
            const isWindows = /Windows/.test(userAgent);
            const isChrome = /Chrome/.test(userAgent) && !/Edge/.test(userAgent);
            const isEdge = /Edge/.test(userAgent);
            const isFirefox = /Firefox/.test(userAgent);
            
            console.log('ë¸Œë¼ìš°ì € ê°ì§€:', {
                userAgent: userAgent,
                isAndroidKakao: isAndroidKakao,
                isWindows: isWindows,
                isChrome: isChrome,
                isEdge: isEdge,
                isFirefox: isFirefox
            });
            
            if (isAndroidKakao) {
                // ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡ ë¸Œë¼ìš°ì €ìš© í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
                let touchStartTime = 0;
                let touchEndTime = 0;
                let isMenuOpen = false;
                
                // í„°ì¹˜ ì‹œì‘
                languageButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    touchStartTime = Date.now();
                    console.log('ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡: í„°ì¹˜ ì‹œì‘');
                }, { passive: false });
                
                // í„°ì¹˜ ì¢…ë£Œ
                languageButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    touchEndTime = Date.now();
                    const touchDuration = touchEndTime - touchStartTime;
                    
                    console.log('ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡: í„°ì¹˜ ì¢…ë£Œ, ì§€ì†ì‹œê°„:', touchDuration);
                    
                    // ì§§ì€ í„°ì¹˜ë§Œ ì²˜ë¦¬ (1ì´ˆ ë¯¸ë§Œ)
                    if (touchDuration < 1000) {
                        if (isMenuOpen) {
                            this.closeLanguageMenu();
                            isMenuOpen = false;
                        } else {
                            this.openLanguageMenu();
                            isMenuOpen = true;
                        }
                    }
                }, { passive: false });
                
                // í´ë¦­ ì´ë²¤íŠ¸ë„ í•¨ê»˜ ì²˜ë¦¬ (ë°±ì—…)
                languageButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡: í´ë¦­ ì´ë²¤íŠ¸');
                    
                    if (isMenuOpen) {
                        this.closeLanguageMenu();
                        isMenuOpen = false;
                    } else {
                        this.openLanguageMenu();
                        isMenuOpen = true;
                    }
                });
                
                // ì–¸ì–´ ì˜µì…˜ ì„ íƒ ì‹œ ë©”ë‰´ ë‹«ê¸°
                document.querySelectorAll('.language-option').forEach(option => {
                    option.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡: ì–¸ì–´ ì˜µì…˜ ì„ íƒ');
                        isMenuOpen = false;
                    }, { passive: false });
                    
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡: ì–¸ì–´ ì˜µì…˜ í´ë¦­');
                        isMenuOpen = false;
                    });
                });
                
            } else {
                // ìœˆë„ìš° ë¸Œë¼ìš°ì € ë° ì¼ë°˜ ë¸Œë¼ìš°ì €ìš© ì²˜ë¦¬
                let isMenuOpen = false;
                
                // í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
                languageButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ìœˆë„ìš°/ì¼ë°˜ ë¸Œë¼ìš°ì €: í´ë¦­ ì´ë²¤íŠ¸');
                    
                    if (isMenuOpen) {
                        this.closeLanguageMenu();
                        isMenuOpen = false;
                    } else {
                        this.openLanguageMenu();
                        isMenuOpen = true;
                    }
                });
                
                // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ìœˆë„ìš° ë¸Œë¼ìš°ì € ìµœì í™”)
                if (isWindows) {
                    languageButton.addEventListener('mouseenter', (e) => {
                        console.log('ìœˆë„ìš° ë¸Œë¼ìš°ì €: ë§ˆìš°ìŠ¤ ì§„ì…');
                    });
                    
                    languageButton.addEventListener('mouseleave', (e) => {
                        console.log('ìœˆë„ìš° ë¸Œë¼ìš°ì €: ë§ˆìš°ìŠ¤ ì´íƒˆ');
                    });
                }
                
                // ì–¸ì–´ ì˜µì…˜ ì„ íƒ ì‹œ ë©”ë‰´ ë‹«ê¸°
                document.querySelectorAll('.language-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ìœˆë„ìš°/ì¼ë°˜ ë¸Œë¼ìš°ì €: ì–¸ì–´ ì˜µì…˜ í´ë¦­');
                        isMenuOpen = false;
                    });
                    
                    // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ë„ ì¶”ê°€
                    option.addEventListener('mouseenter', (e) => {
                        console.log('ì–¸ì–´ ì˜µì…˜ ë§ˆìš°ìŠ¤ ì§„ì…');
                    });
                    
                    option.addEventListener('mouseleave', (e) => {
                        console.log('ì–¸ì–´ ì˜µì…˜ ë§ˆìš°ìŠ¤ ì´íƒˆ');
                    });
                });
            }
        }
        
        // ì–¸ì–´ ë©”ë‰´ ì—´ê¸°
        openLanguageMenu() {
            const menu = document.getElementById('languageMenu');
            if (menu) {
                menu.classList.add('show');
                console.log('ì–¸ì–´ ë©”ë‰´ ì—´ê¸°');
            }
        }
        
        // ì–¸ì–´ ë©”ë‰´ ë‹«ê¸°
        closeLanguageMenu() {
            const menu = document.getElementById('languageMenu');
            if (menu) {
                menu.classList.remove('show');
                console.log('ì–¸ì–´ ë©”ë‰´ ë‹«ê¸°');
            }
        }
        
        // ì–¸ì–´ ë©”ë‰´ í† ê¸€
        toggleLanguageMenu() {
            const menu = document.getElementById('languageMenu');
            if (menu) {
                menu.classList.toggle('show');
                console.log('ì–¸ì–´ ë©”ë‰´ í† ê¸€');
            }
        }
            
                    // ëª¨ë°”ì¼ ìµœì í™” ì„¤ì •
        setupMobileOptimization() {
            this.setViewportHeight();
            window.addEventListener('resize', () => this.setViewportHeight());
            window.addEventListener('orientationchange', () => {
                setTimeout(() => this.setViewportHeight(), 100);
            });
            
            // í‚¤ë³´ë“œ ê°ì§€
            this.setupKeyboardDetection();
            
            // ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡ ë¸Œë¼ìš°ì € ê°ì§€ ë° ìµœì í™”
            this.detectAndroidKakaoBrowser();
        }
        
        // ë¸Œë¼ìš°ì € ê°ì§€ (ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡ + ìœˆë„ìš° ë¸Œë¼ìš°ì €)
        detectAndroidKakaoBrowser() {
            const userAgent = navigator.userAgent;
            const isAndroid = /Android/.test(userAgent);
            const isKakao = /KAKAO/.test(userAgent);
            const isWindows = /Windows/.test(userAgent);
            const isChrome = /Chrome/.test(userAgent) && !/Edge/.test(userAgent);
            const isEdge = /Edge/.test(userAgent);
            const isFirefox = /Firefox/.test(userAgent);
            
            console.log('ë¸Œë¼ìš°ì € ê°ì§€ ê²°ê³¼:', {
                isAndroid: isAndroid,
                isKakao: isKakao,
                isWindows: isWindows,
                isChrome: isChrome,
                isEdge: isEdge,
                isFirefox: isFirefox
            });
            
            if (isAndroid && isKakao) {
                console.log('ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡ ë¸Œë¼ìš°ì € ê°ì§€ë¨');
                document.body.classList.add('android-kakao');
                
                // ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡ ë¸Œë¼ìš°ì € íŠ¹ë³„ ìµœì í™”
                this.setupAndroidKakaoOptimizations();
            } else if (isWindows) {
                console.log('ìœˆë„ìš° ë¸Œë¼ìš°ì € ê°ì§€ë¨');
                document.body.classList.add('windows-browser');
                
                // ìœˆë„ìš° ë¸Œë¼ìš°ì € íŠ¹ë³„ ìµœì í™”
                this.setupWindowsBrowserOptimizations();
            }
        }
        
        // ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡ ë¸Œë¼ìš°ì € ìµœì í™”
        setupAndroidKakaoOptimizations() {
            // í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™”
            const allButtons = document.querySelectorAll('button, .language-current, .language-option');
            allButtons.forEach(button => {
                button.style.setProperty('-webkit-tap-highlight-color', 'transparent', 'important');
                button.style.setProperty('touch-action', 'manipulation', 'important');
                button.style.setProperty('-webkit-touch-callout', 'none', 'important');
                button.style.setProperty('-webkit-user-select', 'none', 'important');
                button.style.setProperty('user-select', 'none', 'important');
            });
            
            // ìŠ¤í¬ë¡¤ ìµœì í™”
            const messagesContainer = document.getElementById('chatbotMessages');
            if (messagesContainer) {
                messagesContainer.style.setProperty('-webkit-overflow-scrolling', 'touch', 'important');
                messagesContainer.style.setProperty('overscroll-behavior', 'contain', 'important');
            }
            
            console.log('ì•ˆë“œë¡œì´ë“œ ì¹´ì¹´ì˜¤í†¡ ë¸Œë¼ìš°ì € ìµœì í™” ì ìš© ì™„ë£Œ');
        }
        
        // ìœˆë„ìš° ë¸Œë¼ìš°ì € ìµœì í™”
        setupWindowsBrowserOptimizations() {
            // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ìµœì í™”
            const allButtons = document.querySelectorAll('button, .language-current, .language-option');
            allButtons.forEach(button => {
                button.style.setProperty('cursor', 'pointer', 'important');
                button.style.setProperty('user-select', 'none', 'important');
                button.style.setProperty('-webkit-user-select', 'none', 'important');
            });
            
            // ì–¸ì–´ ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ íŠ¹ë³„ ìµœì í™”
            const languageButton = document.querySelector('.language-current');
            if (languageButton) {
                languageButton.style.setProperty('transition', 'all 0.2s ease', 'important');
                languageButton.style.setProperty('cursor', 'pointer', 'important');
                
                // í˜¸ë²„ íš¨ê³¼ ê°•í™”
                languageButton.addEventListener('mouseenter', () => {
                    languageButton.style.setProperty('transform', 'translateY(-1px)', 'important');
                    languageButton.style.setProperty('box-shadow', '0 4px 12px rgba(255, 215, 0, 0.5)', 'important');
                });
                
                languageButton.addEventListener('mouseleave', () => {
                    languageButton.style.setProperty('transform', 'translateY(0)', 'important');
                    languageButton.style.setProperty('box-shadow', '0 3px 10px rgba(255, 215, 0, 0.4)', 'important');
                });
            }
            
            // ì–¸ì–´ ì˜µì…˜ í˜¸ë²„ íš¨ê³¼
            const languageOptions = document.querySelectorAll('.language-option');
            languageOptions.forEach(option => {
                option.style.setProperty('transition', 'all 0.2s ease', 'important');
                option.style.setProperty('cursor', 'pointer', 'important');
                
                option.addEventListener('mouseenter', () => {
                    option.style.setProperty('background', 'linear-gradient(135deg, #ffd700 0%, #ffed4e 100%)', 'important');
                    option.style.setProperty('transform', 'translateX(2px)', 'important');
                });
                
                option.addEventListener('mouseleave', () => {
                    if (!option.classList.contains('active')) {
                        option.style.setProperty('background', 'transparent', 'important');
                    }
                    option.style.setProperty('transform', 'translateX(0)', 'important');
                });
            });
            
            console.log('ìœˆë„ìš° ë¸Œë¼ìš°ì € ìµœì í™” ì ìš© ì™„ë£Œ');
        }
            
            // ë·°í¬íŠ¸ ë†’ì´ ì„¤ì •
            setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            // í‚¤ë³´ë“œ ê°ì§€ ì„¤ì •
            setupKeyboardDetection() {
                const initialHeight = window.innerHeight;
                
                window.addEventListener('resize', () => {
                    const currentHeight = window.innerHeight;
                    const heightDiff = initialHeight - currentHeight;
                    
                    if (heightDiff > 150) {
                        document.body.classList.add('keyboard-open');
                    } else {
                        document.body.classList.remove('keyboard-open');
                    }
                });
            }
            
            // API ì„¤ì • ë¡œë”© (ê¸°ë³¸ OpenAI í™œì„±í™”)
            loadApiSettings() {
                try {
                    // ìƒˆë¡œìš´ ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì €ì¥í•œ ì„¤ì •ë“¤ì„ ë¡œë“œ
                    const openaiSettings = JSON.parse(localStorage.getItem('openaiSettings') || '{}');
                    const googleSettings = JSON.parse(localStorage.getItem('googleSettings') || '{}');
                    const anthropicSettings = JSON.parse(localStorage.getItem('anthropicSettings') || '{}');
                    
                    this.apiSettings = {
                        openai: {
                            enabled: openaiSettings.enabled !== undefined ? openaiSettings.enabled : true, // ê¸°ë³¸ê°’: í™œì„±í™”
                            apiKey: openaiSettings.apiKey || '',
                            model: openaiSettings.model || 'gpt-4o'
                        },
                        google: {
                            enabled: googleSettings.enabled || false,
                            apiKey: googleSettings.apiKey || '',
                            model: googleSettings.model || 'gemini-flash-2.5'
                        },
                        anthropic: {
                            enabled: anthropicSettings.enabled || false,
                            apiKey: anthropicSettings.apiKey || '',
                            model: anthropicSettings.model || 'claude-3-5-sonnet-20241022'
                        }
                    };
                    
                    console.log('âœ… API ì„¤ì • ë¡œë“œ ì™„ë£Œ:', {
                        openai: this.apiSettings.openai.enabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”',
                        google: this.apiSettings.google.enabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”',
                        anthropic: this.apiSettings.anthropic.enabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'
                    });
                } catch (error) {
                    console.error('âŒ API ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.apiSettings = {
                        openai: { enabled: true, apiKey: '', model: 'gpt-4o' }, // ê¸°ë³¸ê°’: í™œì„±í™”
                        google: { enabled: false, apiKey: '', model: 'gemini-flash-2.5' },
                        anthropic: { enabled: false, apiKey: '', model: 'claude-3-5-sonnet-20241022' }
                    };
                }
            }
            
            // ì§€ì‹ë² ì´ìŠ¤ ì„¤ì • ë¡œë”©
            loadKnowledgeBaseSettings() {
                try {
                    const saved = localStorage.getItem('chatbotKnowledgeBase');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.knowledgeBase.enabled = parsed.enabled || false;
                        this.knowledgeBase.parsedData = parsed.parsedData || [];
                        console.log('âœ… ì§€ì‹ë² ì´ìŠ¤ ì„¤ì • ë¡œë“œ ì™„ë£Œ:', this.knowledgeBase.parsedData.length, 'ê°œ Q&A');
                    }
                } catch (error) {
                    console.error('âŒ ì§€ì‹ë² ì´ìŠ¤ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }
            
            // ëŒ€í™” ì´ë ¥ ì„¤ì • ë¡œë”©
            loadHistorySettings() {
                try {
                    const saved = localStorage.getItem('chatbotHistorySettings');
                    if (saved) {
                        const settings = JSON.parse(saved);
                        this.MAX_HISTORY = settings.maxHistory || 20;
                        this.MAX_TOKENS = settings.maxTokens || 1500;
                        console.log('âœ… ëŒ€í™” ì´ë ¥ ì„¤ì • ë¡œë“œ ì™„ë£Œ:', {
                            maxHistory: this.MAX_HISTORY,
                            maxTokens: this.MAX_TOKENS
                        });
                    }
                } catch (error) {
                    console.error('âŒ ëŒ€í™” ì´ë ¥ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }
            
            // API ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸ (ë¸Œë¼ìš°ì €ë³„ í˜¸í™˜ì„± ê°œì„ )
            updateApiStatusDisplay() {
                const apiStatus = document.getElementById('apiStatus');
                if (!apiStatus) return; // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ë¦¬í„´
                
                // ë¸Œë¼ìš°ì € ê°ì§€
                const userAgent = navigator.userAgent;
                const isChrome = /Chrome/.test(userAgent) && !/Edge/.test(userAgent);
                const isEdge = /Edge/.test(userAgent);
                const isFirefox = /Firefox/.test(userAgent);
                const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
                const isKakaoTalk = /KAKAO/.test(userAgent);
                
                if (!this.hasActiveAPI()) {
                    apiStatus.innerHTML = 'ğŸ”´ AI OFF';
                    apiStatus.className = 'ai-off';
                    
                    // ë¸Œë¼ìš°ì €ë³„ ì¶”ê°€ ì •ë³´ í‘œì‹œ
                    if (isChrome) {
                        apiStatus.title = 'Chrome ë¸Œë¼ìš°ì €ì—ì„œ API ì—°ê²° ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. Edgeë‚˜ ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.';
                    } else if (isEdge) {
                        apiStatus.title = 'Edge ë¸Œë¼ìš°ì €ì—ì„œ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.';
                    } else if (isFirefox) {
                        apiStatus.title = 'Firefox ë¸Œë¼ìš°ì €ì—ì„œ API ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    } else if (isSafari) {
                        apiStatus.title = 'Safari ë¸Œë¼ìš°ì €ì—ì„œ API ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    } else if (isKakaoTalk) {
                        apiStatus.title = 'ì¹´ì¹´ì˜¤í†¡ ë¸Œë¼ìš°ì €ì—ì„œ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.';
                    }
                    return;
                }
                
                const activeApis = [];
                if (this.apiSettings?.openai?.enabled) activeApis.push('OpenAI');
                if (this.apiSettings?.google?.enabled) activeApis.push('Google');
                
                // ë¸Œë¼ìš°ì €ë³„ ìƒíƒœ ë©”ì‹œì§€
                let statusText = `<span class="blink">ğŸŸ¢</span> n8n ì—”ì§„ On`;
                let statusTitle = `í™œì„±í™”ëœ API: ${activeApis.join(', ')}`;
                
                if (isChrome) {
                    statusTitle += ' (Chrome ë¸Œë¼ìš°ì € - ë¬¸ì œ ë°œìƒ ì‹œ Edgeë¡œ ì‹œë„í•´ë³´ì„¸ìš”)';
                } else if (isEdge) {
                    statusTitle += ' (Edge ë¸Œë¼ìš°ì € - ì •ìƒ ì‘ë™)';
                } else if (isFirefox) {
                    statusTitle += ' (Firefox ë¸Œë¼ìš°ì €)';
                } else if (isSafari) {
                    statusTitle += ' (Safari ë¸Œë¼ìš°ì €)';
                } else if (isKakaoTalk) {
                    statusTitle += ' (ì¹´ì¹´ì˜¤í†¡ ë¸Œë¼ìš°ì € - ì •ìƒ ì‘ë™)';
                }
                
                apiStatus.innerHTML = statusText;
                apiStatus.className = 'ai-on';
                apiStatus.title = statusTitle;
                
                console.log('ğŸŒ API ìƒíƒœ ì—…ë°ì´íŠ¸:', {
                    browser: {
                        isChrome,
                        isEdge,
                        isFirefox,
                        isSafari,
                        isKakaoTalk
                    },
                    activeApis,
                    userAgent: userAgent.substring(0, 100)
                });
            }
            
            // ì§€ì‹ë² ì´ìŠ¤ ê²€ìƒ‰ (ê°„ì†Œí™”ëœ ë²„ì „)
            searchInKnowledgeBase(message) {
                if (!this.knowledgeBase.enabled || this.knowledgeBase.parsedData.length === 0) {
                    return null;
                }
                
                const query = message.toLowerCase().trim();
                let bestMatch = null;
                let bestScore = 0;
                
                for (const qa of this.knowledgeBase.parsedData) {
                    const question = qa.question.toLowerCase();
                    const answer = qa.answer.toLowerCase();
                    
                    let score = 0;
                    
                    // ì™„ì „ ì¼ì¹˜
                    if (question === query) score += 1000;
                    
                    // ë¶€ë¶„ í¬í•¨
                    if (question.includes(query) || query.includes(question)) score += 500;
                    
                    // ë‹¨ì–´ ë§¤ì¹­
                    const queryWords = query.split(/\s+/).filter(w => w.length > 1);
                    for (const word of queryWords) {
                        if (question.includes(word)) score += 100;
                        if (answer.includes(word)) score += 50;
                    }
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = qa;
                    }
                }
                
                if (bestScore >= 50) {
                    const reservationText = this.getReservationText();
                    
                    const knowledgeResponse = {
                        ko: {
                            title: 'ğŸ“š <strong>í”¼ë‹‰ìŠ¤ ì¹˜ê³¼ ì „ë¬¸ ì§€ì‹ ë‹µë³€</strong>',
                            note: 'ğŸ’¡ ì „ë¬¸ ì§€ì‹ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì œê³µëœ ë‹µë³€ì…ë‹ˆë‹¤.'
                        },
                        en: {
                            title: 'ğŸ“š <strong>Phoenix Dental Professional Knowledge Answer</strong>',
                            note: 'ğŸ’¡ Answer provided from professional knowledge database.'
                        },
                        ru: {
                            title: 'ğŸ“š <strong>ĞŸÑ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Phoenix Dental</strong>',
                            note: 'ğŸ’¡ ĞÑ‚Ğ²ĞµÑ‚ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ±Ğ°Ğ·Ñ‹ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹.'
                        },
                        ja: {
                            title: 'ğŸ“š <strong>ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹æ­¯ç§‘å°‚é–€çŸ¥è­˜å›ç­”</strong>',
                            note: 'ğŸ’¡ å°‚é–€çŸ¥è­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æä¾›ã•ã‚ŒãŸå›ç­”ã§ã™ã€‚'
                        }
                    };
                    
                    const currentKnowledge = knowledgeResponse[this.currentLanguage] || knowledgeResponse['ko'];
                    
                    return `${currentKnowledge.title}<br><br>
                            <strong>Q:</strong> ${bestMatch.question}<br><br>
                            <strong>A:</strong> ${bestMatch.answer}<br><br>
                            <small>${currentKnowledge.note}</small>
                            
                            <div class="reservation-message">
                                <div class="reservation-message-text">${reservationText.message}</div>
                                <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                            </div>`;
                }
                
                return null;
            }
            
            // ì½˜í…ì¸  ìƒì„± ë©”ì„œë“œë“¤
            createCapitalGainsTaxContent(lang) {
                const content = {
                    ko: 'ğŸ’° <strong>ì–‘ë„ì†Œë“ì„¸ ê¸°ë³¸ ì •ë³´</strong><br><br>ğŸ“‹ <strong>ì •ì˜:</strong> ìì‚°ì„ ì–‘ë„í•  ë•Œ ë°œìƒí•˜ëŠ” ì†Œë“ì— ëŒ€í•œ ì„¸ê¸ˆ<br>ğŸ“‹ <strong>ê³¼ì„¸ëŒ€ìƒ:</strong> ë¶€ë™ì‚°, ì£¼ì‹, í† ì§€, ê±´ë¬¼, ê¸°íƒ€ ìì‚°ì˜ ì–‘ë„<br>ğŸ“‹ <strong>ê³¼ì„¸í‘œì¤€:</strong> ì–‘ë„ê°€ì•¡ - ì·¨ë“ê°€ì•¡ - í•„ìš”ê²½ë¹„<br>ğŸ“‹ <strong>ì„¸ìœ¨:</strong> ê³¼ì„¸í‘œì¤€ì— ë”°ë¼ 6%~45% (ëˆ„ì§„ì„¸ìœ¨)<br>ğŸ“‹ <strong>ì‹ ê³ ê¸°í•œ:</strong> ì–‘ë„ì¼ì´ ì†í•˜ëŠ” ì—°ë„ì˜ ë‹¤ìŒ ì—°ë„ 5ì›” 31ì¼ê¹Œì§€<br><br>ğŸ’¡ <strong>ì •í™•í•œ ê³„ì‚°ì€ ì „ë¬¸ ì„¸ë¬´ì‚¬ì™€ ìƒë‹´í•˜ì„¸ìš”!</strong>',
                    en: 'ğŸ’° <strong>Capital Gains Tax Basic Information</strong><br><br>ğŸ“‹ <strong>Definition:</strong> Tax on income from asset transfers<br>ğŸ“‹ <strong>Taxable Items:</strong> Real estate, stocks, land, buildings, other assets<br>ğŸ“‹ <strong>Tax Base:</strong> Transfer amount - Acquisition cost - Necessary expenses<br>ğŸ“‹ <strong>Tax Rate:</strong> 6%~45% based on tax base (progressive rate)<br>ğŸ“‹ <strong>Filing Deadline:</strong> May 31st of the year following the transfer<br><br>ğŸ’¡ <strong>For accurate calculation, consult with a tax professional!</strong>',
                    ru: 'ğŸ’° <strong>ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğµ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°</strong><br><br>ğŸ“‹ <strong>ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ:</strong> ĞĞ°Ğ»Ğ¾Ğ³ Ğ½Ğ° Ğ´Ğ¾Ñ…Ğ¾Ğ´ Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¾Ğ²<br>ğŸ“‹ <strong>ĞĞ±Ğ»Ğ°Ğ³Ğ°ĞµĞ¼Ñ‹Ğµ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ñ‹:</strong> ĞĞµĞ´Ğ²Ğ¸Ğ¶Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ, Ğ°ĞºÑ†Ğ¸Ğ¸, Ğ·ĞµĞ¼Ğ»Ñ, Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ, Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ñ‹<br>ğŸ“‹ <strong>ĞĞ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ Ğ±Ğ°Ğ·Ğ°:</strong> Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ - Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ¾Ğ±Ñ€ĞµÑ‚ĞµĞ½Ğ¸Ñ - ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ñ‹<br>ğŸ“‹ <strong>ĞĞ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ğ°Ğ²ĞºĞ°:</strong> 6%~45% Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ Ğ±Ğ°Ğ·Ñ‹ (Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ¸Ğ²Ğ½Ğ°Ñ ÑÑ‚Ğ°Ğ²ĞºĞ°)<br>ğŸ“‹ <strong>Ğ¡Ñ€Ğ¾Ğº Ğ¿Ğ¾Ğ´Ğ°Ñ‡Ğ¸:</strong> 31 Ğ¼Ğ°Ñ Ğ³Ğ¾Ğ´Ğ°, ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ·Ğ° Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡ĞµĞ¹<br><br>ğŸ’¡ <strong>Ğ”Ğ»Ñ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¼Ñƒ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ñƒ!</strong>',
                    ja: 'ğŸ’° <strong>è­²æ¸¡æ‰€å¾—ç¨åŸºæœ¬æƒ…å ±</strong><br><br>ğŸ“‹ <strong>å®šç¾©:</strong> è³‡ç”£è­²æ¸¡æ™‚ã«ç™ºç”Ÿã™ã‚‹æ‰€å¾—ã«å¯¾ã™ã‚‹ç¨é‡‘<br>ğŸ“‹ <strong>èª²ç¨å¯¾è±¡:</strong> ä¸å‹•ç”£ã€æ ªå¼ã€åœŸåœ°ã€å»ºç‰©ã€ãã®ä»–è³‡ç”£ã®è­²æ¸¡<br>ğŸ“‹ <strong>èª²ç¨æ¨™æº–:</strong> è­²æ¸¡ä¾¡é¡ - å–å¾—ä¾¡é¡ - å¿…è¦çµŒè²»<br>ğŸ“‹ <strong>ç¨ç‡:</strong> èª²ç¨æ¨™æº–ã«å¿œã˜ã¦6%~45%ï¼ˆç´¯é€²ç¨ç‡ï¼‰<br>ğŸ“‹ <strong>ç”³å‘ŠæœŸé™:</strong> è­²æ¸¡æ—¥ãŒå±ã™ã‚‹å¹´ã®ç¿Œå¹´5æœˆ31æ—¥ã¾ã§<br><br>ğŸ’¡ <strong>æ­£ç¢ºãªè¨ˆç®—ã¯å°‚é–€ç¨ç†å£«ã«ã”ç›¸è«‡ãã ã•ã„ï¼</strong>'
                };
                
                // í˜„ì¬ ì–¸ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ˆì•½ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
                const currentLang = lang || this.currentLanguage;
                const reservationText = this.getReservationText();
                
                return content[currentLang] + `<br><br><div class="reservation-message">
                    <div class="reservation-message-text">${reservationText.message}</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                </div>`;
            }
            
            createTaxCalculationContent(lang) {
                const content = {
                    ko: 'ğŸ§® <strong>ì–‘ë„ì„¸ ê³„ì‚° ë°©ë²•</strong><br><br>ğŸ“Š <strong>ê³¼ì„¸í‘œì¤€ ê³„ì‚°:</strong><br>â€¢ ì–‘ë„ê°€ì•¡ - ì·¨ë“ê°€ì•¡ - í•„ìš”ê²½ë¹„<br><br>ğŸ“Š <strong>ì„¸ìœ¨ ì ìš©:</strong><br>â€¢ 1,200ë§Œì› ì´í•˜: 6%<br>â€¢ 1,200ë§Œì› ì´ˆê³¼ ~ 4,600ë§Œì›: 15%<br>â€¢ 4,600ë§Œì› ì´ˆê³¼ ~ 8,800ë§Œì›: 24%<br>â€¢ 8,800ë§Œì› ì´ˆê³¼ ~ 1.5ì–µì›: 35%<br>â€¢ 1.5ì–µì› ì´ˆê³¼ ~ 3ì–µì›: 38%<br>â€¢ 3ì–µì› ì´ˆê³¼ ~ 5ì–µì›: 40%<br>â€¢ 5ì–µì› ì´ˆê³¼: 42%<br><br>ğŸ’¡ <strong>ì •í™•í•œ ê³„ì‚°ì€ ì „ë¬¸ ì„¸ë¬´ì‚¬ì™€ ìƒë‹´í•˜ì„¸ìš”!</strong>',
                    en: 'ğŸ§® <strong>Capital Gains Tax Calculation Method</strong><br><br>ğŸ“Š <strong>Tax Base Calculation:</strong><br>â€¢ Transfer amount - Acquisition cost - Necessary expenses<br><br>ğŸ“Š <strong>Tax Rate Application:</strong><br>â€¢ Up to 12 million KRW: 6%<br>â€¢ 12-46 million KRW: 15%<br>â€¢ 46-88 million KRW: 24%<br>â€¢ 88-150 million KRW: 35%<br>â€¢ 150-300 million KRW: 38%<br>â€¢ 300-500 million KRW: 40%<br>â€¢ Over 500 million KRW: 42%<br><br>ğŸ’¡ <strong>For accurate calculation, consult with a tax professional!</strong>',
                    ru: 'ğŸ§® <strong>ĞœĞµÑ‚Ğ¾Ğ´ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°</strong><br><br>ğŸ“Š <strong>Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ Ğ±Ğ°Ğ·Ñ‹:</strong><br>â€¢ Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ - Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ¾Ğ±Ñ€ĞµÑ‚ĞµĞ½Ğ¸Ñ - ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ñ‹<br><br>ğŸ“Š <strong>ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ğ°Ğ²ĞºĞ¸:</strong><br>â€¢ Ğ”Ğ¾ 12 Ğ¼Ğ»Ğ½ Ğ²Ğ¾Ğ½: 6%<br>â€¢ 12-46 Ğ¼Ğ»Ğ½ Ğ²Ğ¾Ğ½: 15%<br>â€¢ 46-88 Ğ¼Ğ»Ğ½ Ğ²Ğ¾Ğ½: 24%<br>â€¢ 88-150 Ğ¼Ğ»Ğ½ Ğ²Ğ¾Ğ½: 35%<br>â€¢ 150-300 Ğ¼Ğ»Ğ½ Ğ²Ğ¾Ğ½: 38%<br>â€¢ 300-500 Ğ¼Ğ»Ğ½ Ğ²Ğ¾Ğ½: 40%<br>â€¢ Ğ¡Ğ²Ñ‹ÑˆĞµ 500 Ğ¼Ğ»Ğ½ Ğ²Ğ¾Ğ½: 42%<br><br>ğŸ’¡ <strong>Ğ”Ğ»Ñ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¼Ñƒ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ñƒ!</strong>',
                    ja: 'ğŸ§® <strong>è­²æ¸¡ç¨è¨ˆç®—æ–¹æ³•</strong><br><br>ğŸ“Š <strong>èª²ç¨æ¨™æº–è¨ˆç®—:</strong><br>â€¢ è­²æ¸¡ä¾¡é¡ - å–å¾—ä¾¡é¡ - å¿…è¦çµŒè²»<br><br>ğŸ“Š <strong>ç¨ç‡é©ç”¨:</strong><br>â€¢ 1,200ä¸‡å††ä»¥ä¸‹: 6%<br>â€¢ 1,200ä¸‡å††è¶…ï½4,600ä¸‡å††: 15%<br>â€¢ 4,600ä¸‡å††è¶…ï½8,800ä¸‡å††: 24%<br>â€¢ 8,800ä¸‡å††è¶…ï½1.5å„„å††: 35%<br>â€¢ 1.5å„„å††è¶…ï½3å„„å††: 38%<br>â€¢ 3å„„å††è¶…ï½5å„„å††: 40%<br>â€¢ 5å„„å††è¶…: 42%<br><br>ğŸ’¡ <strong>æ­£ç¢ºãªè¨ˆç®—ã¯å°‚é–€ç¨ç†å£«ã«ã”ç›¸è«‡ãã ã•ã„ï¼</strong>'
                };
                
                // í˜„ì¬ ì–¸ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ˆì•½ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
                const currentLang = lang || this.currentLanguage;
                const reservationText = this.getReservationText();
                
                return content[currentLang] + `<br><br><div class="reservation-message">
                    <div class="reservation-message-text">${reservationText.message}</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                </div>`;
            }
            
            createTaxFilingContent(lang) {
                const content = {
                    ko: 'ğŸ“‹ <strong>ì–‘ë„ì„¸ ì‹ ê³  ë°©ë²•</strong><br><br>ğŸ“… <strong>ì‹ ê³ ê¸°í•œ:</strong> ì–‘ë„ì¼ì´ ì†í•˜ëŠ” ì—°ë„ì˜ ë‹¤ìŒ ì—°ë„ 5ì›” 31ì¼ê¹Œì§€<br>ğŸ“… <strong>ì‹ ê³ ë°©ë²•:</strong> êµ­ì„¸ì²­ í™ˆíƒìŠ¤ ë˜ëŠ” ì„¸ë¬´ì„œ ë°©ë¬¸<br>ğŸ“… <strong>í•„ìš”ì„œë¥˜:</strong> ì–‘ë„ê³„ì•½ì„œ, ì·¨ë“ì¦ë¹™ì„œë¥˜, ì–‘ë„ê°€ì•¡ ì¦ë¹™ì„œë¥˜<br>ğŸ“… <strong>ì‹ ê³ ì ˆì°¨:</strong> í™ˆíƒìŠ¤ ì ‘ì† â†’ ì–‘ë„ì†Œë“ì„¸ ì‹ ê³  â†’ ì„œë¥˜ ì—…ë¡œë“œ â†’ ì‹ ê³ ì„œ ì œì¶œ<br><br>ğŸ’¡ <strong>ì •í™•í•œ ì‹ ê³ ëŠ” ì „ë¬¸ ì„¸ë¬´ì‚¬ì™€ ìƒë‹´í•˜ì„¸ìš”!</strong>',
                    en: 'ğŸ“‹ <strong>Capital Gains Tax Filing Method</strong><br><br>ğŸ“… <strong>Filing Deadline:</strong> May 31st of the year following the transfer<br>ğŸ“… <strong>Filing Method:</strong> National Tax Service HomeTax or visit tax office<br>ğŸ“… <strong>Required Documents:</strong> Transfer contract, acquisition documents, transfer amount documents<br>ğŸ“… <strong>Filing Procedure:</strong> Access HomeTax â†’ File capital gains tax â†’ Upload documents â†’ Submit return<br><br>ğŸ’¡ <strong>For accurate filing, consult with a tax professional!</strong>',
                    ru: 'ğŸ“‹ <strong>ĞœĞµÑ‚Ğ¾Ğ´ Ğ¿Ğ¾Ğ´Ğ°Ñ‡Ğ¸ Ğ´ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ñƒ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°</strong><br><br>ğŸ“… <strong>Ğ¡Ñ€Ğ¾Ğº Ğ¿Ğ¾Ğ´Ğ°Ñ‡Ğ¸:</strong> 31 Ğ¼Ğ°Ñ Ğ³Ğ¾Ğ´Ğ°, ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ·Ğ° Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡ĞµĞ¹<br>ğŸ“… <strong>Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± Ğ¿Ğ¾Ğ´Ğ°Ñ‡Ğ¸:</strong> ĞĞ°Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑĞ»ÑƒĞ¶Ğ±Ğ° HomeTax Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾ÑĞµÑ‰ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ğ¸<br>ğŸ“… <strong>ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹:</strong> Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸, Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¾ Ğ¿Ñ€Ğ¸Ğ¾Ğ±Ñ€ĞµÑ‚ĞµĞ½Ğ¸Ğ¸, Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¾ ÑÑƒĞ¼Ğ¼Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸<br>ğŸ“… <strong>ĞŸÑ€Ğ¾Ñ†ĞµĞ´ÑƒÑ€Ğ° Ğ¿Ğ¾Ğ´Ğ°Ñ‡Ğ¸:</strong> Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº HomeTax â†’ ĞŸĞ¾Ğ´Ğ°Ñ‡Ğ° Ğ´ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ñƒ â†’ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² â†’ ĞŸĞ¾Ğ´Ğ°Ñ‡Ğ° Ğ´ĞµĞºĞ»Ğ°Ñ€Ğ°Ñ†Ğ¸Ğ¸<br><br>ğŸ’¡ <strong>Ğ”Ğ»Ñ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ°Ñ‡Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¼Ñƒ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ñƒ!</strong>',
                    ja: 'ğŸ“ <strong>ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹æ­¯ç§‘äºˆç´„</strong><br><br>ğŸ¥ <strong>ç—…é™¢å:</strong> ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹æ­¯ç§‘<br>ğŸ“ <strong>é›»è©±ç•ªå·:</strong> 070-1234-1234<br>ğŸ’¬ <strong>ã‚«ã‚«ã‚ªãƒˆãƒ¼ã‚¯:</strong> ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹æ­¯ç§‘<br>ğŸŒ <strong>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³:</strong> ãƒ›ãƒ¼ãƒ í˜ì´ì§€äºˆç´„ã‚·ã‚¹ãƒ†ãƒ <br><br>ğŸ’¡ <strong>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äºˆç´„ãŒæœ€ã‚‚ä¾¿åˆ©ã§ã™!</strong>'
                };
                
                // í˜„ì¬ ì–¸ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ˆì•½ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
                const currentLang = lang || this.currentLanguage;
                const reservationText = this.getReservationText();
                
                return content[currentLang] + `<br><br><div class="reservation-message">
                    <div class="reservation-message-text">${reservationText.message}</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                </div>`;
            }
            
            createTaxExemptionContent(lang) {
                const content = {
                    ko: 'âœ… <strong>ì–‘ë„ì„¸ ë¹„ê³¼ì„¸ ìš”ê±´</strong><br><br>ğŸ  <strong>1ì„¸ëŒ€ 1ì£¼íƒ ë¹„ê³¼ì„¸:</strong> ì¡°ê±´ ì¶©ì¡± ì‹œ ìµœëŒ€ 12ì–µì›ê¹Œì§€ ë¹„ê³¼ì„¸<br>ğŸ  <strong>ì¥ê¸°ë³´ìœ íŠ¹ë³„ê³µì œ:</strong> ë³´ìœ ê¸°ê°„ì— ë”°ë¼ ê³µì œìœ¨ ì ìš©<br>ğŸ  <strong>ê¸°ë³¸ê³µì œ:</strong> ì—°ê°„ 250ë§Œì› ê¸°ë³¸ê³µì œ<br>ğŸ  <strong>ê³µì œìš”ê±´:</strong> ë³´ìœ ê¸°ê°„, ê±°ì£¼ê¸°ê°„, ì†Œìœ ì£¼íƒ ìˆ˜ ë“± í™•ì¸ í•„ìš”<br><br>ğŸ’¡ <strong>ì •í™•í•œ ë¹„ê³¼ì„¸ ìš”ê±´ì€ ì „ë¬¸ ì„¸ë¬´ì‚¬ì™€ ìƒë‹´í•˜ì„¸ìš”!</strong>',
                    en: 'âœ… <strong>Capital Gains Tax Exemption Requirements</strong><br><br>ğŸ  <strong>1st Generation 1 House Exemption:</strong> Up to 1.2 billion KRW tax-free when conditions are met<br>ğŸ  <strong>Long-term Holding Special Deduction:</strong> Deduction rate applied based on holding period<br>ğŸ  <strong>Basic Deduction:</strong> 2.5 million KRW annual basic deduction<br>ğŸ  <strong>Deduction Requirements:</strong> Holding period, residence period, number of owned houses, etc. need to be verified<br><br>ğŸ’¡ <strong>For accurate exemption requirements, consult with a tax professional!</strong>',
                    ru: 'âœ… <strong>Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğº Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ€Ğ¾ÑÑ‚ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ°</strong><br><br>ğŸ  <strong>ĞÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ 1 Ğ¿Ğ¾ĞºĞ¾Ğ»ĞµĞ½Ğ¸Ñ 1 Ğ´Ğ¾Ğ¼Ğ°:</strong> Ğ”Ğ¾ 1.2 Ğ¼Ğ»Ñ€Ğ´ Ğ²Ğ¾Ğ½ Ğ±ĞµĞ· Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğ¹<br>ğŸ  <strong>Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ‹Ñ‡ĞµÑ‚ Ğ·Ğ° Ğ´Ğ¾Ğ»Ğ³Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾Ğµ Ğ²Ğ»Ğ°Ğ´ĞµĞ½Ğ¸Ğµ:</strong> Ğ¡Ñ‚Ğ°Ğ²ĞºĞ° Ğ²Ñ‹Ñ‡ĞµÑ‚Ğ° Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ° Ğ²Ğ»Ğ°Ğ´ĞµĞ½Ğ¸Ñ<br>ğŸ  <strong>Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ñ‹Ñ‡ĞµÑ‚:</strong> 2.5 Ğ¼Ğ»Ğ½ Ğ²Ğ¾Ğ½ Ğ³Ğ¾Ğ´Ğ¾Ğ²Ğ¾Ğ¹ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ñ‹Ñ‡ĞµÑ‚<br>ğŸ  <strong>Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğº Ğ²Ñ‹Ñ‡ĞµÑ‚Ñƒ:</strong> ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ Ğ²Ğ»Ğ°Ğ´ĞµĞ½Ğ¸Ñ, Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ, ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ñ€Ğ¸Ğ½Ğ°Ğ´Ğ»ĞµĞ¶Ğ°Ñ‰Ğ¸Ñ… Ğ´Ğ¾Ğ¼Ğ¾Ğ² Ğ¸ Ñ‚.Ğ´. Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ<br><br>ğŸ’¡ <strong>Ğ”Ğ»Ñ Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ñ… Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğº Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¼Ñƒ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ñƒ!</strong>',
                                          ja: 'âœ… <strong>è­²æ¸¡ç¨éèª²ç¨è¦ä»¶</strong><br><br>ğŸ  <strong>1ä¸–å¸¯1ä½å®…éèª²ç¨:</strong> æ¡ä»¶å……è¶³æ™‚æœ€å¤§12å„„å††ã¾ã§éèª²ç¨<br>ğŸ  <strong>é•·æœŸä¿æœ‰ç‰¹åˆ¥æ§é™¤:</strong> ä¿æœ‰æœŸé–“ã«å¿œã˜ã¦æ§é™¤ç‡é©ç”¨<br>ğŸ  <strong>åŸºæœ¬æ§é™¤:</strong> å¹´é–“250ä¸‡å††åŸºæœ¬æ§é™¤<br>ğŸ  <strong>æ§é™¤è¦ä»¶:</strong> ä¿æœ‰æœŸé–“ã€å±…ä½æœŸé–“ã€æ‰€æœ‰ä½å®…æ•°ãªã©ç¢ºèªå¿…è¦<br><br>ğŸ’¡ <strong>æ­£ç¢ºãªéèª²ç¨è¦ä»¶ã¯å°‚é–€ç¨ç†å£«ã«ã”ç›¸è«‡ãã ã•ã„ï¼</strong>'
                };
                
                // í˜„ì¬ ì–¸ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ˆì•½ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
                const currentLang = lang || this.currentLanguage;
                const reservationText = this.getReservationText();
                
                return content[currentLang] + `<br><br><div class="reservation-message">
                    <div class="reservation-message-text">${reservationText.message}</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">${reservationText.button}</button>
                </div>`;
            }
            

        }

        // ğŸ¯ ì „ì—­ ì±—ë´‡ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        let chatbot;
        
        // ë¸Œë¼ìš°ì €ë³„ ë””ë²„ê¹… ë„êµ¬ (ì „ì—­ í•¨ìˆ˜)
        window.debugBrowserApi = function() {
            if (window.chatbot) {
                console.log('ğŸ”§ ë¸Œë¼ìš°ì €ë³„ ë””ë²„ê¹… ë„êµ¬ ì‹¤í–‰');
                
                const userAgent = navigator.userAgent;
                const browserInfo = {
                    userAgent: userAgent,
                    isChrome: /Chrome/.test(userAgent) && !/Edge/.test(userAgent),
                    isEdge: /Edge/.test(userAgent),
                    isFirefox: /Firefox/.test(userAgent),
                    isSafari: /Safari/.test(userAgent) && !/Chrome/.test(userAgent),
                    isKakaoTalk: /KAKAO/.test(userAgent),
                    platform: navigator.platform,
                    language: navigator.language,
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine
                };
                
                console.log('ğŸŒ ë¸Œë¼ìš°ì € ì •ë³´:', browserInfo);
                console.log('ğŸ”§ ì±—ë´‡ ì„¤ì •:', window.chatbot.apiSettings);
                console.log('ğŸ“Š API ìƒíƒœ:', window.chatbot.hasActiveAPI());
                
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í…ŒìŠ¤íŠ¸
                try {
                    const testKey = 'browser_debug_test';
                    localStorage.setItem(testKey, 'test_value');
                    const testValue = localStorage.getItem(testKey);
                    localStorage.removeItem(testKey);
                    console.log('ğŸ’¾ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í…ŒìŠ¤íŠ¸:', testValue === 'test_value' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');
                } catch (error) {
                    console.error('âŒ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                }
                
                // API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                window.chatbot.testBrowserApiConnection().then(result => {
                    console.log('ğŸ§ª API ì—°ê²° í…ŒìŠ¤íŠ¸ ê²°ê³¼:', result);
                }).catch(error => {
                    console.error('âŒ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                });
                
                return browserInfo;
            } else {
                console.error('âŒ ì±—ë´‡ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return null;
            }
        };
        
        // ë¸Œë¼ìš°ì €ë³„ í…ŒìŠ¤íŠ¸ íˆìŠ¤í† ë¦¬ í™•ì¸
        window.showBrowserTestHistory = function() {
            try {
                const history = JSON.parse(localStorage.getItem('browserApiTestHistory') || '[]');
                console.log('ğŸ“Š ë¸Œë¼ìš°ì €ë³„ í…ŒìŠ¤íŠ¸ íˆìŠ¤í† ë¦¬:', history);
                return history;
            } catch (error) {
                console.error('âŒ í…ŒìŠ¤íŠ¸ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
                return [];
            }
        };
        
        // ë¸Œë¼ìš°ì €ë³„ ìºì‹œ í´ë¦¬ì–´
        window.clearBrowserCache = function() {
            try {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í´ë¦¬ì–´
                localStorage.clear();
                console.log('ğŸ—‘ï¸ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í´ë¦¬ì–´ ì™„ë£Œ');
                
                // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ í´ë¦¬ì–´
                sessionStorage.clear();
                console.log('ğŸ—‘ï¸ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ í´ë¦¬ì–´ ì™„ë£Œ');
                
                alert('ë¸Œë¼ìš°ì € ìºì‹œê°€ í´ë¦¬ì–´ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                return true;
            } catch (error) {
                console.error('âŒ ìºì‹œ í´ë¦¬ì–´ ì‹¤íŒ¨:', error);
                alert('ìºì‹œ í´ë¦¬ì–´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return false;
            }
        };

        // ğŸ¯ í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” (ë¸Œë¼ìš°ì €ë³„ í˜¸í™˜ì„± ê°œì„ )
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ í”¼ë‹‰ìŠ¤ ì¹˜ê³¼ AI ì±—ë´‡ í˜ì´ì§€ ë¡œë“œ');
            
            // ë¸Œë¼ìš°ì € ì •ë³´ ë¡œê¹…
            const userAgent = navigator.userAgent;
            console.log('ğŸŒ ë¸Œë¼ìš°ì € ì •ë³´:', {
                userAgent: userAgent.substring(0, 100),
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine
            });
            
            // ì±—ë´‡ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì´ˆê¸°í™”
            chatbot = new TaxAgentChatbot();
            window.chatbot = chatbot; // ì „ì—­ìœ¼ë¡œ ì„¤ì •
            
                    // í˜ì´ì§€ ë¡œë“œ í›„ ìë™ìœ¼ë¡œ ì „ì—­ ì„¤ì • ë¡œë“œ
        setTimeout(() => {
            autoLoadGlobalConfig();
        }, 1000);
        
        // API ìƒíƒœ ì •ë³´ í‘œì‹œ
        function showApiStatusInfo() {
            const statusDiv = document.getElementById('apiStatus');
            const currentStatus = statusDiv.textContent;
            
            if (currentStatus.includes('âŒ')) {
                alert('ğŸ¤– n8n ì—”ì§„ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤!\n\n' +
                      '1. ì¢Œì¸¡ ìƒë‹¨ ì„¤ì • ì•„ì´ì½˜(âš™ï¸) í´ë¦­\n' +
                      '2. ë¡œê·¸ì¸: tax004050 / tax004050\n' +
                      '3. "ğŸŒ ì „ì—­ ì„¤ì • ë¡œë“œ" ë²„íŠ¼ í´ë¦­\n' +
                      '4. "ğŸ’¾ API ì„¤ì • ì €ì¥" ë²„íŠ¼ í´ë¦­\n\n' +
                      'ë˜ëŠ” ê´€ë¦¬ìê°€ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í–ˆë‹¤ë©´\n' +
                      'í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ë³´ì„¸ìš”!');
            } else if (currentStatus.includes('ğŸŸ¢')) {
                alert('âœ… n8n ì—”ì§„ì´ ì •ìƒì ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤!\n\n' +
                      'ì–‘ë„ì„¸ ê´€ë ¨ ì§ˆë¬¸ì„ ììœ ë¡­ê²Œ ë¬¼ì–´ë³´ì„¸ìš”!');
            } else {
                alert('ğŸ”„ n8n ì—”ì§„ ìƒíƒœë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...\n\n' +
                      'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.');
            }
        }
        });

        // ğŸ¯ ì „ì—­ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ ì½”ë“œì™€ì˜ í˜¸í™˜ì„±)
        function sendMessage() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            chatbot.addUserMessage(message);
            input.value = '';
            input.style.height = 'auto';
            
            chatbot.processMessage(message);
        }

        function toggleLanguageMenu() {
            if (chatbot) {
                chatbot.toggleLanguageMenu();
            } else {
                const menu = document.getElementById('languageMenu');
                if (menu) {
                    menu.classList.toggle('show');
                    console.log('ì „ì—­ í•¨ìˆ˜: ì–¸ì–´ ë©”ë‰´ í† ê¸€');
                }
            }
        }

        function selectLanguage(language) {
            if (chatbot) {
                chatbot.currentLanguage = language;
                chatbot.updateLanguageUI();
                
                const changeMessages = {
                    ko: 'ğŸ‡°ğŸ‡· í•œêµ­ì–´ë¡œ ì–¸ì–´ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!',
                    en: 'ğŸ‡ºğŸ‡¸ Language changed to English!',
                    ru: 'ğŸ‡·ğŸ‡º Ğ¯Ğ·Ñ‹Ğº Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¸Ğ¹!',
                    ja: 'ğŸ‡¯ğŸ‡µ è¨€èªãŒæ—¥æœ¬èªã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸï¼'
                };
                
                chatbot.addBotMessage(changeMessages[language] || changeMessages['ko']);
                
                // ì–¸ì–´ ë³€ê²½ í›„ í™˜ì˜ ë©”ì‹œì§€ ë‹¤ì‹œ í‘œì‹œ
                setTimeout(() => {
                    chatbot.addWelcomeMessage();
                }, 1000);
                
                chatbot.closeLanguageMenu();
            }
        }

        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function handleInputKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleBackNavigation(event) {
            // ë’¤ë¡œê°€ê¸° ë¡œì§
            if (document.referrer) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }



        // ê´€ë¦¬ì í˜ì´ì§€ ì—´ê¸°
        function openAdminPage(event) {
            event.preventDefault();
            console.log('Tax Agent ê´€ë¦¬ í˜ì´ì§€ ë¡œê·¸ì¸ ì‹œë„');
            
            // ë¡œê·¸ì¸ í™•ì¸
            const username = prompt('ê´€ë¦¬ì ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            const password = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            
            if (username === 'tax004050' && password === 'tax004050') {
                console.log('âœ… ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ');
                document.getElementById('chatbotAdminPage').style.display = 'flex';
                
                // ê¸°ì¡´ ì„¤ì • ë¡œë“œ
                loadAdminSettings();
            } else {
                console.log('âŒ ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹¤íŒ¨');
                alert('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨! ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì „ì—­ ì„¤ì • ë¡œë“œ
        async function autoLoadGlobalConfig() {
            try {
                console.log('ğŸ”„ ìë™ ì „ì—­ ì„¤ì • ë¡œë“œ ì‹œì‘');
                const response = await fetch('/.netlify/functions/chatbot-config');
                if (response.ok) {
                    const config = await response.json();
                    console.log('âœ… ìë™ ì „ì—­ ì„¤ì • ë¡œë“œ ì„±ê³µ:', config);
                    
                    // API ì„¤ì •ì— ì ìš©
                    if (config.openai && config.openai.apiKey) {
                        const settings = {
                            openai: {
                                enabled: true,
                                apiKey: config.openai.apiKey,
                                model: config.openai.model || 'gpt-4o'
                            },
                            google: {
                                enabled: config.google && config.google.apiKey ? true : false,
                                apiKey: config.google ? config.google.apiKey : '',
                                model: config.google ? config.google.model : 'gemini-flash-2.5'
                            }
                        };
                        
                        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                        localStorage.setItem('chatbotApiSettings', JSON.stringify(settings));
                        
                        // ì±—ë´‡ ì¸ìŠ¤í„´ìŠ¤ ì—…ë°ì´íŠ¸
                        if (window.chatbot) {
                            window.chatbot.loadApiSettings();
                            window.chatbot.updateApiStatusDisplay();
                        }
                        
                        console.log('âœ… ìë™ API ì„¤ì • ì™„ë£Œ');
                        
                        // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ (ì²« ë°©ë¬¸ ì‹œì—ë§Œ)
                        const hasShownAutoSetup = localStorage.getItem('hasShownAutoSetup');
                        if (!hasShownAutoSetup) {
                            setTimeout(() => {
                                alert('ğŸ‰ ìë™ìœ¼ë¡œ n8n ì—”ì§„ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n' +
                                      'ì´ì œ ì–‘ë„ì„¸ ê´€ë ¨ ì§ˆë¬¸ì„ ììœ ë¡­ê²Œ ë¬¼ì–´ë³´ì„¸ìš”!\n\n' +
                                      'ğŸ’¡ ìš°ì¸¡ ìƒë‹¨ì˜ n8n ì—”ì§„ ìƒíƒœë¥¼ í´ë¦­í•˜ë©´\n' +
                                      'í˜„ì¬ ì„¤ì • ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                                localStorage.setItem('hasShownAutoSetup', 'true');
                            }, 2000);
                        }
                    }
                }
            } catch (error) {
                console.log('âš ï¸ ìë™ ì „ì—­ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨ (ì •ìƒì ì¸ ìƒí™©):', error.message);
            }
        }

        // ê´€ë¦¬ì í˜ì´ì§€ ë‹«ê¸°
        function closeChatbotAdmin() {
            console.log('Tax Agent ê´€ë¦¬ í˜ì´ì§€ ë‹«ê¸°');
            document.getElementById('chatbotAdminPage').style.display = 'none';
        }

        // ê´€ë¦¬ì í˜ì´ì§€ API ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateAdminApiStatus() {
            const adminApiStatus = document.getElementById('adminApiStatus');
            if (adminApiStatus && window.chatbot) {
                adminApiStatus.innerHTML = window.chatbot.hasActiveAPI() ? 'ğŸŸ¢ AI API ì—°ê²°ë¨' : 'ğŸ”´ AI API ì„¤ì • í•„ìš”';
            }
        }

        // ì „ì—­ ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ë“¤
        // ì „ì—­ ì„¤ì • ë¡œë“œ
        async function loadGlobalConfig() {
            try {
                console.log('ğŸŒ ì „ì—­ ì„¤ì • ë¡œë“œ ì‹œì‘');
                
                const statusDiv = document.getElementById('apiSettingsStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">ğŸ”„ ì „ì—­ ì„¤ì •ì„ ë¡œë“œí•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>';
                }
                
                const response = await fetch('/.netlify/functions/chatbot-config');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const config = await response.json();
                console.log('âœ… ì „ì—­ ì„¤ì • ë¡œë“œ ì„±ê³µ:', config);
                
                // API ì„¤ì •ì— ì ìš©
                if (config.openai) {
                    const openaiApiKey = document.getElementById('openaiApiKey');
                    const openaiModel = document.getElementById('openaiModel');
                    if (openaiApiKey) openaiApiKey.value = config.openai.apiKey || '';
                    if (openaiModel) openaiModel.value = config.openai.model || 'gpt-4o';
                }
                
                if (config.google) {
                    const googleApiKey = document.getElementById('googleApiKey');
                    const googleModel = document.getElementById('googleModel');
                    if (googleApiKey) googleApiKey.value = config.google.apiKey || '';
                    if (googleModel) googleModel.value = config.google.model || 'gemini-flash-2.5';
                }
                
                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                if (statusDiv) {
                    statusDiv.innerHTML = '<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">âœ… ì „ì—­ ì„¤ì •ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ì €ì¥ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>';
                }
                
                alert('âœ… ì „ì—­ ì„¤ì •ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì„¤ì •ì„ í™•ì¸í•˜ê³  "API ì„¤ì • ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
                
            } catch (error) {
                console.error('âŒ ì „ì—­ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
                
                const statusDiv = document.getElementById('apiSettingsStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = '<div style="color: #721c24; padding: 10px; background: #f8d7da; border-radius: 5px; margin-top: 10px;">âŒ ì „ì—­ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: ' + error.message + '</div>';
                }
                
                alert('âŒ ì „ì—­ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨!\n\nì˜¤ë¥˜: ' + error.message + '\n\nNetlify í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        // ì„¤ì • ë‚´ë³´ë‚´ê¸°
        function exportSettings() {
            try {
                console.log('ğŸ“¤ ì„¤ì • ë‚´ë³´ë‚´ê¸° ì‹œì‘');
                
                const settings = {
                    openai: {
                        apiKey: document.getElementById('openaiApiKey').value,
                        model: document.getElementById('openaiModel').value
                    },
                    google: {
                        apiKey: document.getElementById('googleApiKey').value,
                        model: document.getElementById('googleModel').value
                    },
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tax-agent-settings.json';
                a.click();
                URL.revokeObjectURL(url);
                
                console.log('âœ… ì„¤ì • ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
                alert('âœ… ì„¤ì •ì´ "tax-agent-settings.json" íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤!');
                
            } catch (error) {
                console.error('âŒ ì„¤ì • ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
                alert('âŒ ì„¤ì • ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        function importSettings() {
            try {
                console.log('ğŸ“¥ ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì‹œì‘');
                
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const settings = JSON.parse(e.target.result);
                            console.log('ğŸ“¥ ê°€ì ¸ì˜¨ ì„¤ì •:', settings);
                            
                            // API ì„¤ì •ì— ì ìš©
                            if (settings.openai) {
                                const openaiApiKey = document.getElementById('openaiApiKey');
                                const openaiModel = document.getElementById('openaiModel');
                                if (openaiApiKey) openaiApiKey.value = settings.openai.apiKey || '';
                                if (openaiModel) openaiModel.value = settings.openai.model || 'gpt-4o';
                            }
                            
                            if (settings.google) {
                                const googleApiKey = document.getElementById('googleApiKey');
                                const googleModel = document.getElementById('googleModel');
                                if (googleApiKey) googleApiKey.value = settings.google.apiKey || '';
                                if (googleModel) googleModel.value = settings.google.model || 'gemini-flash-2.5';
                            }
                            
                            console.log('âœ… ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ');
                            alert('âœ… ì„¤ì •ì´ ê°€ì ¸ì™€ì¡ŒìŠµë‹ˆë‹¤!\n\n"API ì„¤ì • ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì €ì¥í•˜ì„¸ìš”.');
                            
                        } catch (error) {
                            console.error('âŒ ì„¤ì • íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨:', error);
                            alert('âŒ ì„¤ì • íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì˜¬ë°”ë¥¸ JSON íŒŒì¼ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
                
            } catch (error) {
                console.error('âŒ ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                alert('âŒ ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ê´€ë¦¬ì í˜ì´ì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupAdminEventListeners() {
            console.log('ğŸ”§ ê´€ë¦¬ì í˜ì´ì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹œì‘');
            
            // API ì„¤ì • ì €ì¥ ë²„íŠ¼
            const saveApiBtn = document.getElementById('saveApiBtn');
            if (saveApiBtn) {
                saveApiBtn.addEventListener('click', function() {
                    try {
                        console.log('ğŸ’¾ API ì„¤ì • ì €ì¥ ì‹œì‘');
                        
                        // ì…ë ¥ í•„ë“œì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
                        const openaiApiKey = document.getElementById('openaiApiKey');
                        const openaiModel = document.getElementById('openaiModel');
                        const googleApiKey = document.getElementById('googleApiKey');
                        const googleModel = document.getElementById('googleModel');
                        
                        if (!openaiApiKey || !openaiModel || !googleApiKey || !googleModel) {
                            throw new Error('í•„ìˆ˜ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                        
                        const settings = {
                            openai: {
                                enabled: openaiModel.value !== '',  // ëª¨ë¸ì´ ì„ íƒë˜ë©´ í™œì„±í™”
                                apiKey: openaiApiKey.value.trim(),
                                model: openaiModel.value
                            },
                            google: {
                                enabled: googleModel.value !== '',  // ëª¨ë¸ì´ ì„ íƒë˜ë©´ í™œì„±í™”
                                apiKey: googleApiKey.value.trim(),
                                model: googleModel.value
                            }
                        };
                        
                        localStorage.setItem('chatbotApiSettings', JSON.stringify(settings));
                        console.log('âœ… API ì„¤ì • ì €ì¥ ì™„ë£Œ:', settings);
                        
                        // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                        const statusDiv = document.getElementById('apiSettingsStatus');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">âœ… API ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
                        }
                        
                        // ì±—ë´‡ ì¸ìŠ¤í„´ìŠ¤ ì—…ë°ì´íŠ¸
                        if (window.chatbot) {
                            window.chatbot.loadApiSettings();
                            window.chatbot.updateApiStatusDisplay();
                            console.log('âœ… ì±—ë´‡ API ì„¤ì • ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                        }
                        
                        // ê´€ë¦¬ì í˜ì´ì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
                        updateAdminApiStatus();
                        
                        // ì„±ê³µ ì•Œë¦¼
                        alert('âœ… API ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        
                    } catch (error) {
                        console.error('âŒ API ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
                        alert('âŒ API ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    }
                });
                console.log('âœ… API ì„¤ì • ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

                    // API ì—°ê²° í…ŒìŠ¤íŠ¸ ë²„íŠ¼
            const testApiBtn = document.getElementById('testApiBtn');
            if (testApiBtn) {
                testApiBtn.addEventListener('click', function() {
                    try {
                        console.log('ğŸ”— API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘');
                        
                        const statusDiv = document.getElementById('apiSettingsStatus');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">ğŸ”„ API ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>';
                        }
                        
                        setTimeout(() => {
                            try {
                                const settings = JSON.parse(localStorage.getItem('chatbotApiSettings') || '{}');
                                let activeApis = [];
                                
                                                if (settings.openai?.enabled) activeApis.push('OpenAI');
                                if (settings.google?.enabled) activeApis.push('Google');
                                
                                console.log('ğŸ” í™œì„±í™”ëœ API:', activeApis);
                                
                                if (activeApis.length > 0) {
                                    const successMessage = `âœ… ì—°ê²° ì„±ê³µ! í™œì„±í™”ëœ API: ${activeApis.join(', ')}`;
                                    if (statusDiv) {
                                        statusDiv.innerHTML = `<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">${successMessage}</div>`;
                                    }
                                    alert(successMessage);
                                    
                                    // ì±—ë´‡ ì¸ìŠ¤í„´ìŠ¤ ì—…ë°ì´íŠ¸
                                    if (window.chatbot) {
                                        window.chatbot.loadApiSettings();
                                        window.chatbot.updateApiStatusDisplay();
                                    }
                                    
                                    // ê´€ë¦¬ì í˜ì´ì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
                                    updateAdminApiStatus();
                                } else {
                                    const errorMessage = 'âŒ í™œì„±í™”ëœ APIê°€ ì—†ìŠµë‹ˆë‹¤. API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                                    if (statusDiv) {
                                        statusDiv.innerHTML = `<div style="color: #721c24; padding: 10px; background: #f8d7da; border-radius: 5px; margin-top: 10px;">${errorMessage}</div>`;
                                    }
                                    alert(errorMessage);
                                }
                            } catch (error) {
                                console.error('âŒ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
                                const errorMessage = 'âŒ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                                if (statusDiv) {
                                    statusDiv.innerHTML = `<div style="color: #721c24; padding: 10px; background: #f8d7da; border-radius: 5px; margin-top: 10px;">${errorMessage}</div>`;
                                }
                                alert(errorMessage);
                            }
                        }, 1000);
                        
                    } catch (error) {
                        console.error('âŒ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                        alert('âŒ API ì—°ê²° í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                });
                console.log('âœ… API ì—°ê²° í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

            // API ì„¤ì • ì´ˆê¸°í™” ë²„íŠ¼
            const clearApiBtn = document.getElementById('clearApiBtn');
            if (clearApiBtn) {
                clearApiBtn.addEventListener('click', function() {
                    try {
                        if (confirm('ì •ë§ë¡œ ëª¨ë“  API ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            console.log('ğŸ”„ API ì„¤ì • ì´ˆê¸°í™” ì‹œì‘');
                            
                            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                            const fields = [
                                'openaiApiKey', 'openaiModel',
                                'googleApiKey', 'googleModel'
                            ];
                            
                            fields.forEach(fieldId => {
                                const element = document.getElementById(fieldId);
                                if (element) {
                                    element.value = '';
                                }
                            });
                            
                            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì„¤ì • ì œê±°
                            localStorage.removeItem('chatbotApiSettings');
                            console.log('âœ… API ì„¤ì • ì´ˆê¸°í™” ì™„ë£Œ');
                            
                            // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                            const statusDiv = document.getElementById('apiSettingsStatus');
                            if (statusDiv) {
                                statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">ğŸ”„ API ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
                            }
                            
                            // ì±—ë´‡ ì¸ìŠ¤í„´ìŠ¤ ì—…ë°ì´íŠ¸
                            if (window.chatbot) {
                                window.chatbot.loadApiSettings();
                                window.chatbot.updateApiStatusDisplay();
                                console.log('âœ… ì±—ë´‡ API ì„¤ì • ì´ˆê¸°í™” ì™„ë£Œ');
                            }
                            
                            // ê´€ë¦¬ì í˜ì´ì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
                            updateAdminApiStatus();
                            
                            alert('âœ… API ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        }
                    } catch (error) {
                        console.error('âŒ API ì„¤ì • ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                        alert('âŒ API ì„¤ì • ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                });
                console.log('âœ… API ì„¤ì • ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

            // ì „ì—­ ì„¤ì • ë¡œë“œ ë²„íŠ¼
            const loadGlobalConfigBtn = document.getElementById('loadGlobalConfigBtn');
            if (loadGlobalConfigBtn) {
                loadGlobalConfigBtn.addEventListener('click', loadGlobalConfig);
                console.log('âœ… ì „ì—­ ì„¤ì • ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

            // ì„¤ì • ë‚´ë³´ë‚´ê¸° ë²„íŠ¼
            const exportSettingsBtn = document.getElementById('exportSettingsBtn');
            if (exportSettingsBtn) {
                exportSettingsBtn.addEventListener('click', exportSettings);
                console.log('âœ… ì„¤ì • ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

            // ì„¤ì • ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼
            const importSettingsBtn = document.getElementById('importSettingsBtn');
            if (importSettingsBtn) {
                importSettingsBtn.addEventListener('click', importSettings);
                console.log('âœ… ì„¤ì • ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }



            // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(event) {
                    const files = event.target.files;
                    processUploadedFiles(files);
                });
                console.log('âœ… íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

            // íŒŒì¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                // í´ë¦­ ì´ë²¤íŠ¸
                uploadArea.addEventListener('click', function() {
                    document.getElementById('fileInput').click();
                });
                
                // ë“œë˜ê·¸ ì˜¤ë²„ ì´ë²¤íŠ¸
                uploadArea.addEventListener('dragover', function(event) {
                    event.preventDefault();
                    this.style.borderColor = '#4facfe';
                });
                
                // ë“œë˜ê·¸ ë¦¬ë¸Œ ì´ë²¤íŠ¸
                uploadArea.addEventListener('dragleave', function(event) {
                    event.preventDefault();
                    this.style.borderColor = '#ddd';
                });
                
                // ë“œë¡­ ì´ë²¤íŠ¸
                uploadArea.addEventListener('drop', function(event) {
                    event.preventDefault();
                    this.style.borderColor = '#ddd';
                    
                    const files = event.dataTransfer.files;
                    processUploadedFiles(files);
                });
                console.log('âœ… íŒŒì¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

            // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ í•¨ìˆ˜ë“¤
            function processUploadedFiles(files) {
                console.log('íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ ì‹œì‘:', files.length, 'ê°œ');
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    console.log('íŒŒì¼ ì²˜ë¦¬ ì¤‘:', file.name, file.type, file.size);
                    
                    const fileData = {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploadTime: new Date(),
                        content: ''
                    };
                    
                    // íŒŒì¼ í™•ì¥ì í™•ì¸
                    const fileExtension = file.name.toLowerCase().split('.').pop();
                    
                    // PDF íŒŒì¼ ê²½ê³ 
                    if (fileExtension === 'pdf' || file.type === 'application/pdf') {
                        console.warn('PDF íŒŒì¼ ê°ì§€:', file.name);
                        alert('âŒ PDF íŒŒì¼ì€ í˜„ì¬ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nPDF ë‚´ìš©ì„ í…ìŠ¤íŠ¸ íŒŒì¼(.txt)ë¡œ ë³µì‚¬í•´ì„œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                        continue;
                    }
                    
                    // ì§€ì›ë˜ëŠ” íŒŒì¼ í˜•ì‹ ì²˜ë¦¬
                    if (fileExtension === 'txt' || file.type === 'text/plain' || file.type === '') {
                        // í…ìŠ¤íŠ¸ íŒŒì¼ ì²˜ë¦¬
                        processTextFile(file, fileData);

                    } else if (fileExtension === 'jsonl' || file.type === 'application/jsonl' || file.type === 'text/plain') {
                        // JSONL íŒŒì¼ ì²˜ë¦¬
                        processJsonlFile(file, fileData);
                    } else {
                        // ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹
                        console.warn('ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹:', file.name, file.type);
                        alert(`âŒ ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤: ${file.name}\n\nğŸ“ í˜„ì¬ ì§€ì›ë˜ëŠ” íŒŒì¼ í˜•ì‹:\nâ€¢ í…ìŠ¤íŠ¸ íŒŒì¼ (.txt)\nâ€¢ JSONL íŒŒì¼ (.jsonl)`);
                    }
                }
            }

            // í…ìŠ¤íŠ¸ íŒŒì¼ ì²˜ë¦¬
            function processTextFile(file, fileData) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        fileData.content = content;
                        processKnowledgeFile(fileData.name, content);
                    } catch (error) {
                        console.error('í…ìŠ¤íŠ¸ íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                        alert(`âŒ í…ìŠ¤íŠ¸ íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨: ${file.name}`);
                    }
                };
                reader.onerror = function() {
                    console.error('í…ìŠ¤íŠ¸ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜');
                    alert(`âŒ í…ìŠ¤íŠ¸ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${file.name}`);
                };
                reader.readAsText(file, 'UTF-8');
            }



            // JSONL íŒŒì¼ ì²˜ë¦¬
            function processJsonlFile(file, fileData) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        fileData.content = content;
                        processJsonlContent(fileData.name, content);
                    } catch (error) {
                        console.error('JSONL íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                        alert(`âŒ JSONL íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨: ${file.name}`);
                    }
                };
                reader.onerror = function() {
                    console.error('JSONL íŒŒì¼ ì½ê¸° ì˜¤ë¥˜');
                    alert(`âŒ JSONL íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${file.name}`);
                };
                reader.readAsText(file, 'UTF-8');
            }

            // JSONL ë‚´ìš© ì²˜ë¦¬
            function processJsonlContent(filename, content) {
                const lines = content.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);
                const qaList = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    try {
                        const jsonData = JSON.parse(line);
                        
                        let question = '';
                        let answer = '';
                        
                        if (jsonData.question && jsonData.answer) {
                            question = jsonData.question;
                            answer = jsonData.answer;
                        } else if (jsonData.q && jsonData.a) {
                            question = jsonData.q;
                            answer = jsonData.a;
                        } else if (jsonData.ì§ˆë¬¸ && jsonData.ë‹µë³€) {
                            question = jsonData.ì§ˆë¬¸;
                            answer = jsonData.ë‹µë³€;
                        } else if (jsonData.text && jsonData.response) {
                            question = jsonData.text;
                            answer = jsonData.response;
                        } else if (jsonData.prompt && jsonData.completion) {
                            question = jsonData.prompt;
                            answer = jsonData.completion;
                        } else if (jsonData.input && jsonData.output) {
                            question = jsonData.input;
                            answer = jsonData.output;
                        }
                        
                        if (question && answer && question.length > 2 && answer.length > 3) {
                            qaList.push({ question: question, answer: answer });
                        }
                        
                    } catch (error) {
                        console.warn(`JSONL ë¼ì¸ ${i + 1} íŒŒì‹± ì‹¤íŒ¨:`, error);
                        continue;
                    }
                }
                
                if (qaList.length > 0) {
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    knowledgeData.parsedData = knowledgeData.parsedData.concat(qaList);
                    localStorage.setItem('chatbotKnowledgeBase', JSON.stringify(knowledgeData));
                    
                    // íŒŒì¼ ëª©ë¡ì— ì¶”ê°€
                    const fileList = document.getElementById('fileList');
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-item';
                    fileDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                            <div>
                                <strong>ğŸ“„ ${filename}</strong>
                                <div style="font-size: 12px; color: #666;">í¬ê¸°: ${(content.length / 1024).toFixed(2)} KB | Q&A: ${qaList.length}ê°œ</div>
                            </div>
                            <button onclick="this.parentElement.remove(); updateKnowledgeStatus();" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">ì‚­ì œ</button>
                        </div>
                    `;
                    fileList.appendChild(fileDiv);
                }
                
                updateKnowledgeStatus();
            }

            // ì§€ì‹ íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
            function processKnowledgeFile(filename, content) {
                const fileList = document.getElementById('fileList');
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-item';
                fileDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                        <div>
                            <strong>ğŸ“„ ${filename}</strong>
                            <div style="font-size: 12px; color: #666;">í¬ê¸°: ${(content.length / 1024).toFixed(2)} KB</div>
                        </div>
                        <button onclick="this.parentElement.remove(); updateKnowledgeStatus();" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">ì‚­ì œ</button>
                    </div>
                `;
                fileList.appendChild(fileDiv);
                
                // Q&A íŒŒì‹±
                const qaList = parseQAFromContent(content);
                if (qaList.length > 0) {
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    knowledgeData.parsedData = knowledgeData.parsedData.concat(qaList);
                    localStorage.setItem('chatbotKnowledgeBase', JSON.stringify(knowledgeData));
                }
                
                updateKnowledgeStatus();
            }

            // Q&A íŒŒì‹± í•¨ìˆ˜
            function parseQAFromContent(content) {
                const lines = content.split('\n');
                const qaList = [];
                let currentQ = '';
                let currentA = '';
                
                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('Q:') || line.startsWith('Q.') || line.startsWith('ì§ˆë¬¸:')) {
                        if (currentQ && currentA) {
                            qaList.push({ question: currentQ, answer: currentA });
                        }
                        currentQ = line.replace(/^Q[:.]\s*|^ì§ˆë¬¸:\s*/, '');
                        currentA = '';
                    } else if (line.startsWith('A:') || line.startsWith('A.') || line.startsWith('ë‹µë³€:')) {
                        currentA = line.replace(/^A[:.]\s*|^ë‹µë³€:\s*/, '');
                    } else if (currentA) {
                        currentA += ' ' + line;
                    } else if (currentQ) {
                        currentQ += ' ' + line;
                    }
                }
                
                if (currentQ && currentA) {
                    qaList.push({ question: currentQ, answer: currentA });
                }
                
                return qaList;
            }

            // ì§€ì‹ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateKnowledgeStatus() {
                const fileItems = document.querySelectorAll('.file-item');
                const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                
                const statusDiv = document.getElementById('knowledgeStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = `ğŸ“– ì—…ë¡œë“œëœ ì§€ì‹ íŒŒì¼: ${fileItems.length}ê°œ | íŒŒì‹±ëœ Q&A: ${knowledgeData.parsedData.length}ê°œ | ìƒíƒœ: ${knowledgeData.enabled ? 'í™œì„±' : 'ë¹„í™œì„±'}`;
                }
            }

            // ì§€ì‹ ì„¤ì • ì €ì¥ ë²„íŠ¼
            const saveKnowledgeBtn = document.getElementById('saveKnowledgeBtn');
            if (saveKnowledgeBtn) {
                saveKnowledgeBtn.addEventListener('click', function() {
                    const fileItems = document.querySelectorAll('.file-item');
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    
                    knowledgeData.enabled = fileItems.length > 0;
                    knowledgeData.files = Array.from(fileItems).map(item => item.querySelector('strong').textContent.replace('ğŸ“„ ', ''));
                    
                    localStorage.setItem('chatbotKnowledgeBase', JSON.stringify(knowledgeData));
                    
                    const statusDiv = document.getElementById('knowledgeSettingsStatus');
                    if (statusDiv) {
                        statusDiv.innerHTML = '<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">âœ… ì§€ì‹ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
                    }
                    
                    if (window.chatbot) {
                        window.chatbot.loadKnowledgeBaseSettings();
                    }
                    
                    alert('âœ… ì§€ì‹ ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                });
                console.log('âœ… ì§€ì‹ ì„¤ì • ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

            // ì§€ì‹ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ ë²„íŠ¼
            const testKnowledgeBtn = document.getElementById('testKnowledgeBtn');
            if (testKnowledgeBtn) {
                testKnowledgeBtn.addEventListener('click', function() {
                    const testQuery = prompt('ê²€ìƒ‰í•  ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”:');
                    if (!testQuery) return;
                    
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    
                    if (!knowledgeData.enabled || knowledgeData.parsedData.length === 0) {
                        alert('í™œì„±í™”ëœ ì§€ì‹ë² ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    const result = searchInKnowledgeBase(testQuery, knowledgeData.parsedData);
                    if (result) {
                        alert(`ê²€ìƒ‰ ê²°ê³¼:\n\nQ: ${result.question}\n\nA: ${result.answer}`);
                    } else {
                        alert('ê´€ë ¨ ë‹µë³€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                });
                console.log('âœ… ì§€ì‹ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

            // ì§€ì‹ë² ì´ìŠ¤ ê²€ìƒ‰ í•¨ìˆ˜
            function searchInKnowledgeBase(query, parsedData) {
                const normalizedQuery = query.toLowerCase().trim();
                let bestMatch = null;
                let bestScore = 0;
                
                for (const qa of parsedData) {
                    const question = qa.question.toLowerCase();
                    const answer = qa.answer.toLowerCase();
                    
                    let score = 0;
                    
                    if (question === normalizedQuery) score += 1000;
                    if (question.includes(normalizedQuery) || normalizedQuery.includes(question)) score += 500;
                    
                    const queryWords = normalizedQuery.split(/\s+/).filter(w => w.length > 1);
                    for (const word of queryWords) {
                        if (question.includes(word)) score += 100;
                        if (answer.includes(word)) score += 50;
                    }
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = qa;
                    }
                }
                
                return bestScore >= 50 ? bestMatch : null;
            }

            // íŒŒì‹±ëœ ë°ì´í„° ë³´ê¸° ë²„íŠ¼
            const showParsedDataBtn = document.getElementById('showParsedDataBtn');
            if (showParsedDataBtn) {
                showParsedDataBtn.addEventListener('click', function() {
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    const viewDiv = document.getElementById('parsedDataView');
                    const contentDiv = document.getElementById('parsedDataContent');
                    
                    if (viewDiv && contentDiv) {
                        if (knowledgeData.parsedData.length === 0) {
                            contentDiv.innerHTML = '<p style="color: #666;">íŒŒì‹±ëœ Q&A ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                        } else {
                            let html = '';
                            knowledgeData.parsedData.forEach((qa, index) => {
                                html += `
                                    <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">Q${index + 1}: ${qa.question}</div>
                                        <div style="color: #666;">A: ${qa.answer}</div>
                                    </div>
                                `;
                            });
                            contentDiv.innerHTML = html;
                        }
                        
                        viewDiv.style.display = viewDiv.style.display === 'none' ? 'block' : 'none';
                    }
                });
                console.log('âœ… íŒŒì‹±ëœ ë°ì´í„° ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

            // ëª¨ë“  ì§€ì‹ ì‚­ì œ ë²„íŠ¼
            const clearKnowledgeBtn = document.getElementById('clearKnowledgeBtn');
            if (clearKnowledgeBtn) {
                clearKnowledgeBtn.addEventListener('click', function() {
                    if (confirm('ì •ë§ë¡œ ëª¨ë“  ì§€ì‹ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        const fileList = document.getElementById('fileList');
                        if (fileList) {
                            fileList.innerHTML = '';
                        }
                        localStorage.removeItem('chatbotKnowledgeBase');
                        updateKnowledgeStatus();
                        
                        const statusDiv = document.getElementById('knowledgeSettingsStatus');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">ğŸ”„ ëª¨ë“  ì§€ì‹ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
                        }
                        
                        if (window.chatbot) {
                            window.chatbot.loadKnowledgeBaseSettings();
                        }
                        
                        alert('âœ… ëª¨ë“  ì§€ì‹ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }
                });
                console.log('âœ… ëª¨ë“  ì§€ì‹ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

            // ëŒ€í™” ì´ë ¥ ê´€ë¦¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
            // ëŒ€í™” ì´ë ¥ ë³´ê¸° ë²„íŠ¼
            const viewChatHistoryBtn = document.getElementById('viewChatHistoryBtn');
            if (viewChatHistoryBtn) {
                viewChatHistoryBtn.addEventListener('click', function() {
                    const viewDiv = document.getElementById('chatHistoryView');
                    const contentDiv = document.getElementById('chatHistoryContent');
                    
                    if (viewDiv && contentDiv && window.chatbot) {
                        const history = window.chatbot.chatHistory;
                        
                        if (history.length === 0) {
                            contentDiv.innerHTML = '<p style="color: #666;">í˜„ì¬ ëŒ€í™” ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        } else {
                            let html = '';
                            history.forEach((msg, index) => {
                                const role = msg.role === 'user' ? 'ğŸ‘¤ ì‚¬ìš©ì' : 'ğŸ‘©â€âš•ï¸ AI ìƒë‹´ì‚¬';
                                const time = new Date(msg.timestamp).toLocaleString();
                                html += `
                                    <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; background: ${msg.role === 'user' ? '#f8f9fa' : '#e3f2fd'}">
                                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
                                            ${role} (${time})
                                        </div>
                                        <div style="color: #666; word-break: break-word;">${msg.content}</div>
                                    </div>
                                `;
                            });
                            contentDiv.innerHTML = html;
                        }
                        
                        viewDiv.style.display = viewDiv.style.display === 'none' ? 'block' : 'none';
                    }
                });
                console.log('âœ… ëŒ€í™” ì´ë ¥ ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

            // ëŒ€í™” ì´ë ¥ ì„¤ì • ì €ì¥ ë²„íŠ¼
            const saveHistorySettingsBtn = document.getElementById('saveHistorySettingsBtn');
            if (saveHistorySettingsBtn) {
                saveHistorySettingsBtn.addEventListener('click', function() {
                    const maxHistory = document.getElementById('maxHistorySelect').value;
                    const maxTokens = document.getElementById('maxTokensSelect').value;
                    
                    if (window.chatbot) {
                        window.chatbot.MAX_HISTORY = parseInt(maxHistory);
                        window.chatbot.MAX_TOKENS = parseInt(maxTokens);
                        
                        // ì„¤ì •ì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                        localStorage.setItem('chatbotHistorySettings', JSON.stringify({
                            maxHistory: parseInt(maxHistory),
                            maxTokens: parseInt(maxTokens)
                        }));
                        
                        updateChatHistoryStatus();
                        
                        const statusDiv = document.getElementById('chatHistorySettingsStatus');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">âœ… ëŒ€í™” ì´ë ¥ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
                        }
                        
                        alert('âœ… ëŒ€í™” ì´ë ¥ ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }
                });
                console.log('âœ… ëŒ€í™” ì´ë ¥ ì„¤ì • ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

            // ëŒ€í™” ì´ë ¥ ì´ˆê¸°í™” ë²„íŠ¼
            const clearChatHistoryBtn = document.getElementById('clearChatHistoryBtn');
            if (clearChatHistoryBtn) {
                clearChatHistoryBtn.addEventListener('click', function() {
                    if (confirm('ì •ë§ë¡œ ëª¨ë“  ëŒ€í™” ì´ë ¥ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        if (window.chatbot) {
                            window.chatbot.clearChatHistory();
                            updateChatHistoryStatus();
                            
                            const statusDiv = document.getElementById('chatHistorySettingsStatus');
                            if (statusDiv) {
                                statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">ğŸ”„ ëŒ€í™” ì´ë ¥ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
                            }
                            
                            alert('âœ… ëŒ€í™” ì´ë ¥ì´ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        }
                    }
                });
                console.log('âœ… ëŒ€í™” ì´ë ¥ ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

            // ëŒ€í™” ì´ë ¥ ë‚´ë³´ë‚´ê¸° ë²„íŠ¼
            const exportChatHistoryBtn = document.getElementById('exportChatHistoryBtn');
            if (exportChatHistoryBtn) {
                exportChatHistoryBtn.addEventListener('click', function() {
                    if (window.chatbot && window.chatbot.chatHistory.length > 0) {
                        const history = window.chatbot.chatHistory;
                        let exportText = '=== í”¼ë‹‰ìŠ¤ ì¹˜ê³¼ AI ì±—ë´‡ ëŒ€í™” ì´ë ¥ ===\n\n';
                        
                        history.forEach((msg, index) => {
                            const role = msg.role === 'user' ? 'ì‚¬ìš©ì' : 'AI ìƒë‹´ì‚¬';
                            const time = new Date(msg.timestamp).toLocaleString();
                            exportText += `[${index + 1}] ${role} (${time})\n`;
                            exportText += `${msg.content}\n\n`;
                        });
                        
                        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                        const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `chatbot_history_${new Date().toISOString().slice(0, 10)}.txt`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        alert('âœ… ëŒ€í™” ì´ë ¥ì´ ì„±ê³µì ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } else {
                        alert('ë‚´ë³´ë‚¼ ëŒ€í™” ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.');
                    }
                });
                console.log('âœ… ëŒ€í™” ì´ë ¥ ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì™„ë£Œ');
            }

            // ëŒ€í™” ì´ë ¥ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateChatHistoryStatus() {
                const statusDiv = document.getElementById('chatHistoryStatus');
                if (statusDiv && window.chatbot) {
                    const historyCount = window.chatbot.chatHistory.length;
                    const maxHistory = window.chatbot.MAX_HISTORY;
                    statusDiv.innerHTML = `ğŸ’¬ í˜„ì¬ ëŒ€í™” ì´ë ¥: ${historyCount}ê°œ ë©”ì‹œì§€ | ìµœëŒ€ ì €ì¥: ${maxHistory}ê°œ ë©”ì‹œì§€`;
                }
            }
            
            console.log('âœ… ê´€ë¦¬ì í˜ì´ì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
        }

        // ê´€ë¦¬ì ì„¤ì • ë¡œë“œ í•¨ìˆ˜
        function loadAdminSettings() {
            try {
                console.log('ğŸ“‹ ê´€ë¦¬ì í˜ì´ì§€ ì„¤ì • ë¡œë“œ ì‹œì‘');
                
                // ê¸°ì¡´ ì„¤ì • ë¡œë“œ
                const apiSettings = JSON.parse(localStorage.getItem('chatbotApiSettings') || '{}');
                
                // OpenAI ì„¤ì • ë¡œë“œ
                const openaiApiKey = document.getElementById('openaiApiKey');
                const openaiModel = document.getElementById('openaiModel');
                
                if (openaiApiKey) openaiApiKey.value = apiSettings.openai?.apiKey || '';
                if (openaiModel) openaiModel.value = apiSettings.openai?.model || 'gpt-4o';  // ê¸°ë³¸ê°’ ì„¤ì •
                
                // Google API ì„¤ì • ë¡œë“œ
                if (apiSettings.google) {
                    const googleApiKey = document.getElementById('googleApiKey');
                    const googleModel = document.getElementById('googleModel');
                    
                    if (googleApiKey) googleApiKey.value = apiSettings.google.apiKey || '';
                    if (googleModel) googleModel.value = apiSettings.google.model || '';
                }
                
                // ëŒ€í™” ì´ë ¥ ì„¤ì • ë¡œë“œ
                const historySettings = JSON.parse(localStorage.getItem('chatbotHistorySettings') || '{}');
                const maxHistorySelect = document.getElementById('maxHistorySelect');
                const maxTokensSelect = document.getElementById('maxTokensSelect');
                
                if (maxHistorySelect && historySettings.maxHistory) {
                    maxHistorySelect.value = historySettings.maxHistory;
                }
                if (maxTokensSelect && historySettings.maxTokens) {
                    maxTokensSelect.value = historySettings.maxTokens;
                }
                
                // ì±—ë´‡ ì¸ìŠ¤í„´ìŠ¤ì— ì„¤ì • ì ìš©
                if (window.chatbot && historySettings.maxHistory) {
                    window.chatbot.MAX_HISTORY = historySettings.maxHistory;
                }
                if (window.chatbot && historySettings.maxTokens) {
                    window.chatbot.MAX_TOKENS = historySettings.maxTokens;
                }
                
                if (window.updateKnowledgeStatus) {
                    window.updateKnowledgeStatus();
                }
                if (window.updateChatHistoryStatus) {
                    window.updateChatHistoryStatus();
                }
                console.log('âœ… ê´€ë¦¬ì í˜ì´ì§€ ì„¤ì • ë¡œë“œ ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ê´€ë¦¬ì í˜ì´ì§€ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        console.log('âœ… Tax Agent ì–‘ë„ì„¸ ì±—ë´‡ ì´ˆê¸°í™” ì™„ë£Œ (ìµœì í™” ë²„ì „)');
    </script>

    <!-- AI ì±—ë´‡ ê´€ë¦¬ í˜ì´ì§€ -->
    <div class="popup-page" id="chatbotAdminPage" style="display: none;">
        <div class="admin-header">
            <div class="admin-title">âš™ï¸ Tax Agent ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
            <div class="admin-nav">
                <button class="nav-btn" onclick="closeChatbotAdmin()">ğŸ’° Tax Agentë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        </div>
        
        <div class="admin-content">
            <!-- ë‹µë³€ ìš°ì„ ìˆœìœ„ ì •ë³´ -->
            <div class="admin-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="section-header">
                    <h3>ğŸ¯ Tax Agent ë‹µë³€ ìš°ì„ ìˆœìœ„</h3>
                </div>
                <div style="padding: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 15px;">
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 15px; text-align: center;">
                        ì–‘ë„ì„¸ ì§ˆë¬¸ ë‹µë³€ ì²˜ë¦¬ ìˆœì„œ
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">1ì°¨</div>
                            <div>ğŸ’° ì–‘ë„ì„¸ ê¸°ë³¸ ì •ë³´</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">2ì°¨</div>
                            <div>ğŸ“š ì§€ì‹ë² ì´ìŠ¤ ê²€ìƒ‰</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">3ì°¨</div>
                            <div>â“ ê¸°ë³¸ FAQ ë‹µë³€</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">4ì°¨</div>
                            <div>ğŸ¤– AI API í˜¸ì¶œ</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">5ì°¨</div>
                            <div>ğŸ­ ì‹œë®¬ë ˆì´ì…˜ ë‹µë³€</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; text-align: center; font-size: 13px;">
                        <span id="adminApiStatus">
                            ${this.hasActiveAPI() ? 'ğŸŸ¢ AI API ì—°ê²°ë¨' : 'ğŸ”´ AI API ì„¤ì • í•„ìš”'}
                        </span>
                    </div>
                </div>
            </div>

            <!-- AI ëª¨ë¸ API ì„¤ì • -->
            <div class="admin-section">
                <div class="section-header">
                    <h3>ğŸ¤– Tax Agent AI ëª¨ë¸ ì—°ê²°í•˜ê¸°</h3>
                </div>
                
                <div class="api-form">
                    <!-- OpenAI ì„¤ì • -->
                    <div class="form-group">
                        <label for="openaiApiKey">OpenAI API Key</label>
                        <input type="password" id="openaiApiKey" placeholder="sk-proj-...">
                    </div>
                    <div class="form-group">
                        <label for="openaiModel">OpenAI ëª¨ë¸ì„ íƒ</label>
                        <select id="openaiModel">
                            <option value="">-- OpenAI ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                            <option value="gpt-4o" selected>GPT-4o (ìµœì‹  ë©€í‹°ëª¨ë‹¬)</option>
                            <option value="gpt-4o-mini">GPT-4o Mini (ê²½ì œì )</option>
                        </select>
                    </div>

                    <!-- Google API ì„¤ì • -->
                    <div class="form-group" style="margin-top: 25px;">
                        <label for="googleApiKey">Google API Key</label>
                        <input type="password" id="googleApiKey" placeholder="AIza...">
                    </div>
                    <div class="form-group">
                        <label for="googleModel">Google ëª¨ë¸ì„ íƒ</label>
                        <select id="googleModel">
                            <option value="">-- Google ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                            <option value="gemini-flash-2.5">Gemini Flash 2.5 (ë¹ ë¥¸ ì‘ë‹µ)</option>
                            <option value="gemini-pro-2.5">Gemini Pro 2.5 (ê³ ì„±ëŠ¥)</option>
                        </select>
                    </div>

                    <!-- API ì„¤ì • ì €ì¥ ë²„íŠ¼ -->
                    <div class="btn-group" style="margin-top: 30px;">
                        <button class="btn btn-success" id="saveApiBtn">ğŸ’¾ API ì„¤ì • ì €ì¥</button>
                        <button class="btn btn-primary" id="testApiBtn">ğŸ” API ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                        <button class="btn btn-danger" id="clearApiBtn">ğŸ—‘ï¸ API ì„¤ì • ì´ˆê¸°í™”</button>
                    </div>
                    
                    <!-- ì „ì—­ ì„¤ì • ê´€ë¦¬ -->
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-info" id="loadGlobalConfigBtn">ğŸŒ ì „ì—­ ì„¤ì • ë¡œë“œ</button>
                        <button class="btn btn-info" id="exportSettingsBtn">ğŸ“¤ ì„¤ì • ë‚´ë³´ë‚´ê¸°</button>
                        <button class="btn btn-info" id="importSettingsBtn">ğŸ“¥ ì„¤ì • ê°€ì ¸ì˜¤ê¸°</button>
                    </div>
                    
                    <div id="apiSettingsStatus" class="status-message"></div>



                </div>
            </div>

            <!-- AI ì§€ì‹ íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="admin-section">
                <div class="section-header">
                    <h3>ğŸ“š AI ì§€ì‹ íŒŒì¼ ì—…ë¡œë“œ</h3>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                    <div class="upload-types">ğŸ’¡ <strong>ì§€ì› í˜•ì‹: í…ìŠ¤íŠ¸(.txt), JSONL(.jsonl)</strong><br>
                    <small style="color: #666;">â€» ì§€ì› í˜•ì‹: .txt, .jsonl | PDFëŠ” í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ í›„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</small></div>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".txt,.jsonl" multiple>
                
                <div class="file-list" id="fileList">
                    <!-- ì—…ë¡œë“œëœ íŒŒì¼ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <div id="knowledgeStatus" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 14px;">
                    ğŸ“– ì—…ë¡œë“œëœ ì§€ì‹ íŒŒì¼: 0ê°œ | ìƒíƒœ: ë¹„í™œì„±
                </div>
                
                <!-- ì§€ì‹ íŒŒì¼ ì„¤ì • ì €ì¥ ë²„íŠ¼ -->
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-success" id="saveKnowledgeBtn">ğŸ’¾ ì§€ì‹ íŒŒì¼ ì„¤ì • ì €ì¥</button>
                    <button class="btn btn-primary" id="testKnowledgeBtn">ğŸ” ì§€ì‹ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸</button>
                    <button class="btn" style="background: #17a2b8; color: white;" id="showParsedDataBtn">ğŸ“‹ íŒŒì‹±ëœ Q&A ë³´ê¸°</button>
                    <button class="btn btn-danger" id="clearKnowledgeBtn">ğŸ—‘ï¸ ëª¨ë“  ì§€ì‹ ì‚­ì œ</button>
                </div>
                <div id="knowledgeSettingsStatus" class="status-message"></div>
                
                <!-- íŒŒì‹±ëœ Q&A í‘œì‹œ ì˜ì—­ -->
                <div id="parsedDataView" style="display: none; margin-top: 20px; background: white; border-radius: 10px; padding: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">ğŸ“‹ íŒŒì‹±ëœ Q&A ë°ì´í„°</h4>
                    <div id="parsedDataContent"></div>
                </div>
            </div>

            <!-- ëŒ€í™” ì´ë ¥ ê´€ë¦¬ -->
            <div class="admin-section">
                <div class="section-header">
                    <h3>ğŸ’¬ ëŒ€í™” ì´ë ¥ ê´€ë¦¬</h3>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">ğŸ“Š ëŒ€í™” ì´ë ¥ í˜„í™©</h4>
                        <div id="chatHistoryStatus" style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #4facfe;">
                            ğŸ’¬ í˜„ì¬ ëŒ€í™” ì´ë ¥: 0ê°œ ë©”ì‹œì§€ | ìµœëŒ€ ì €ì¥: 20ê°œ ë©”ì‹œì§€
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">âš™ï¸ ëŒ€í™” ì´ë ¥ ì„¤ì •</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <label style="font-weight: bold; display: block; margin-bottom: 5px;">ìµœëŒ€ ëŒ€í™” ì´ë ¥ ê°œìˆ˜</label>
                                <select id="maxHistorySelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="10">10ê°œ</option>
                                    <option value="20" selected>20ê°œ</option>
                                    <option value="30">30ê°œ</option>
                                    <option value="50">50ê°œ</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight: bold; display: block; margin-bottom: 5px;">API í˜¸ì¶œ ìµœëŒ€ í† í°</label>
                                <select id="maxTokensSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="1000">1,000 í† í°</option>
                                    <option value="1500" selected>1,500 í† í°</option>
                                    <option value="2000">2,000 í† í°</option>
                                    <option value="3000">3,000 í† í°</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ëŒ€í™” ì´ë ¥ ê´€ë¦¬ ë²„íŠ¼ -->
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" id="viewChatHistoryBtn">ğŸ‘ï¸ ëŒ€í™” ì´ë ¥ ë³´ê¸°</button>
                        <button class="btn btn-success" id="saveHistorySettingsBtn">ğŸ’¾ ì„¤ì • ì €ì¥</button>
                        <button class="btn btn-warning" id="clearChatHistoryBtn">ğŸ—‘ï¸ ëŒ€í™” ì´ë ¥ ì´ˆê¸°í™”</button>
                        <button class="btn" style="background: #17a2b8; color: white;" id="exportChatHistoryBtn">ğŸ“¤ ëŒ€í™” ì´ë ¥ ë‚´ë³´ë‚´ê¸°</button>
                    </div>
                    <div id="chatHistorySettingsStatus" class="status-message"></div>
                    
                    <!-- ëŒ€í™” ì´ë ¥ í‘œì‹œ ì˜ì—­ -->
                    <div id="chatHistoryView" style="display: none; margin-top: 20px; background: white; border-radius: 10px; padding: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd;">
                        <h4 style="margin-bottom: 15px; color: #2c3e50;">ğŸ’¬ í˜„ì¬ ëŒ€í™” ì´ë ¥</h4>
                        <div id="chatHistoryContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* ê´€ë¦¬ì í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        .popup-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .admin-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .admin-title {
            font-size: 24px;
            font-weight: bold;
            flex: 1;
            min-width: 200px;
        }

        .admin-login-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 250px;
        }

        .admin-nav {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: #2980b9;
        }

        .nav-btn.logout {
            background: #e74c3c;
        }

        .nav-btn.logout:hover {
            background: #c0392b;
        }

        .admin-content {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
            max-height: 80vh;
            overflow-y: auto;
        }

        .admin-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 20px;
        }

        /* API ì„¤ì • ìŠ¤íƒ€ì¼ */
        .api-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .btn-primary {
            background: #4facfe;
            color: white;
        }

        .btn-primary:hover {
            background: #3d8bfe;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        /* íŒŒì¼ ì—…ë¡œë“œ ìŠ¤íƒ€ì¼ */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .upload-types {
            font-size: 14px;
            color: #666;
        }

        .file-input {
            display: none;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            margin-bottom: 10px;
        }

        .status-message {
            margin-top: 15px;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .admin-title {
                font-size: 20px;
                min-width: auto;
            }
            
            .admin-login-info {
                min-width: auto;
                width: 100%;
                max-width: 300px;
                margin: 0 auto;
            }
            
            .admin-nav {
                width: 100%;
                justify-content: center;
            }
            
            .admin-content {
                padding: 15px;
                max-height: 90vh;
            }
            
            .admin-section {
                padding: 15px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .upload-area {
                padding: 20px;
            }
            
            .upload-icon {
                font-size: 36px;
            }
            
            .upload-text {
                font-size: 16px;
            }
        }
    </style>
</body>
</html>